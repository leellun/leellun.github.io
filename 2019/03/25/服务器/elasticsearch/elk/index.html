

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/leaf_icon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="leellun">
  <meta name="keywords" content="">
  
    <meta name="description" content="1. ElasticSearch简介1.1 ES简介Elasticsearch（以下简称 ES） 是使用java开发，基于Lucene、分布式、通过Restful方式进行交互的近实时搜索平台框架。它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。 ES 是 ELK 架构技术栈的组件之一。 ELK（ES+Logstash+Kibana">
<meta property="og:type" content="article">
<meta property="og:title" content="elasticsearch比较全面的教程">
<meta property="og:url" content="https://leellun.github.io/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/index.html">
<meta property="og:site_name" content="青叶水间 - 一个IT技术文章分享博客">
<meta property="og:description" content="1. ElasticSearch简介1.1 ES简介Elasticsearch（以下简称 ES） 是使用java开发，基于Lucene、分布式、通过Restful方式进行交互的近实时搜索平台框架。它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。 ES 是 ELK 架构技术栈的组件之一。 ELK（ES+Logstash+Kibana">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://leellun.github.io/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200907220623.png">
<meta property="og:image" content="https://leellun.github.io/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200907220642.png">
<meta property="og:image" content="https://leellun.github.io/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200907220728.png">
<meta property="og:image" content="https://leellun.github.io/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200907215602.png">
<meta property="og:image" content="https://leellun.github.io/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200908002226.png">
<meta property="og:image" content="https://leellun.github.io/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200911223257.png">
<meta property="og:image" content="https://leellun.github.io/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200911223325.png">
<meta property="og:image" content="https://leellun.github.io/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200912221855.png">
<meta property="og:image" content="https://leellun.github.io/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200912223339.png">
<meta property="og:image" content="https://leellun.github.io/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200913001418.png">
<meta property="og:image" content="https://leellun.github.io/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200913001308.png">
<meta property="og:image" content="https://leellun.github.io/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200910111010.png">
<meta property="article:published_time" content="2019-03-25T10:14:02.000Z">
<meta property="article:modified_time" content="2022-10-06T08:11:32.703Z">
<meta property="article:author" content="leellun">
<meta property="article:tag" content="elasticsearch">
<meta property="article:tag" content="elk">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://leellun.github.io/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200907220623.png">
  
  
  
  <title>elasticsearch比较全面的教程 - 青叶水间 - 一个IT技术文章分享博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"leellun.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 60vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>青叶水间</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg-default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="elasticsearch比较全面的教程"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2019-03-25 18:14" pubdate>
          2019年3月25日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          87k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          726 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">elasticsearch比较全面的教程</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="1-ElasticSearch简介"><a href="#1-ElasticSearch简介" class="headerlink" title="1. ElasticSearch简介"></a>1. ElasticSearch简介</h1><h2 id="1-1-ES简介"><a href="#1-1-ES简介" class="headerlink" title="1.1 ES简介"></a>1.1 ES简介</h2><p>Elasticsearch（以下简称 <strong>ES</strong>） 是使用java开发，基于Lucene、分布式、通过Restful方式进行交互的<strong>近实时</strong>搜索平台框架。它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。</p>
<p>ES 是 <strong>ELK</strong> 架构技术栈的组件之一。</p>
<p>ELK（ES+Logstash+Kibana）是一个免费开源的日志分析架构技术栈总称，但实际上ELK不仅仅适用于日志分析，它还可以支持其它任何数据搜索、分析和收集的场景，日志分析和收集只是更具有代表性。随着elk的发展，又有新成员Beats、elastic cloud的加入，所以就形成了<strong>Elastic Stack</strong>。所以说，ELK是旧的称呼，Elastic Stack是新的名字。</p>
<h2 id="1-2-ES特点"><a href="#1-2-ES特点" class="headerlink" title="1.2 ES特点"></a>1.2 ES特点</h2><ul>
<li>处理方式灵活：ES 是目前最流行的准实时全文检索引擎，具有高速检索大数据的能力。</li>
<li>接口简单：采用json形式RESTFUL API接受数据并响应，无关语言。</li>
<li>性能高效：ES 基于优秀的全文搜索技术Lucene，采用<strong>倒排索引</strong>，可以轻易地在百亿级别数据量下，搜索出想要的内容，并且是秒级响应。</li>
<li>功能强大：ES 作为传统数据库的一个补充，提供了数据库所不不能提供的很多功能，如全文检索，同义词处理，相关度排名。</li>
</ul>
<h2 id="1-3-应用场景"><a href="#1-3-应用场景" class="headerlink" title="1.3 应用场景"></a>1.3 应用场景</h2><p>ES 主要用于 <strong>搜索</strong> 。传统的数据库搜索存在以下弊端</p>
<ul>
<li>电商、社交网站数据存储往往是GB、PB级。存储上亿条数据时，涉及到的单表数据过大就必须分表，数据库磁盘占用过大就必须分库。</li>
<li>当查询 <strong>JavaWeb</strong> 时，上亿条数据的帖子需要从标题和内容中逐行扫描，性能相当差。</li>
<li>不能分词，当我搜索 <strong>Java Web</strong> 时，只能搜到 <strong>Java Web</strong> 的数据，而搜不到 <strong>JavaWeb</strong> 的数据。</li>
</ul>
<p>而相对的，就可以使用 ES 进行解决。ES 具有以下功能</p>
<ul>
<li>分布式的搜索引擎</li>
</ul>
<p>搜索：互联网搜索、站内搜索</p>
<ul>
<li><p>全文检索，结构化检索，数据分析</p>
</li>
<li><p>对海量数据进行近实时的处理</p>
</li>
</ul>
<p>分布式：ES自动可以将海量数据分散到多台服务器上去存储和检索,经行并行查询。</p>
<p>近实时：es只需秒级即可查询海量数据。</p>
<h2 id="1-4-Lucene-amp-Solr-amp-ES"><a href="#1-4-Lucene-amp-Solr-amp-ES" class="headerlink" title="1.4 Lucene&amp;Solr&amp;ES"></a>1.4 Lucene&amp;Solr&amp;ES</h2><p>Lucene：最先进、功能最强大的搜索库，直接基于lucene开发，非常复杂，api复杂。</p>
<p>solr：Solr是一个高性能，采用Java开发，基于Lucene的全文搜索服务器。同时对其进行了扩展，提供了比Lucene更为丰富的查询语言，同时实现了可配置、可扩展并对查询性能进行了优化，并且提供了一个完善的功能管理界面，是一款非常优秀的全文搜索引擎。</p>
<p>ES：基于lucene，封装了许多lucene底层功能，提供简单易用的restful api接口和许多语言的客户端。据说ES的搜索性能是Solr的50倍。起源：Shay Banon。2004年失业，陪老婆去伦敦学习厨师。失业在家帮老婆写一个菜谱搜索引擎。封装了lucene的开源项目，compass。找到工作后，做分布式高性能项目，再封装compass，写出了 ES，使得lucene支持分布式。现在是 ES 创始人兼Elastic首席执行官。</p>
<p>solr和 ES 性能对比。</p>
<p>当单纯的对已有数据进行搜索，并且数据量不是很大时，Solr更快。</p>
<img src="/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200907220623.png" srcset="/img/loading.gif" lazyload class="" title="image-20200907220623059">

<p>当实时建立索引时, Solr会产生io阻塞，查询性能较差, ES 具有明显的优势。</p>
<img src="/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200907220642.png" srcset="/img/loading.gif" lazyload class="" title="image-20200907220642631">

<p>随着数据量的增加，Solr的搜索效率会变得更低，而 ES 却没有明显的变化。</p>
<img src="/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200907220728.png" srcset="/img/loading.gif" lazyload class="" title="image-20200907220728006">

<p>综上所述，Solr的架构不适合实时搜索的应用。</p>
<h2 id="1-5-倒排索引"><a href="#1-5-倒排索引" class="headerlink" title="1.5 倒排索引"></a>1.5 倒排索引</h2><h3 id="1-5-1-正排索引"><a href="#1-5-1-正排索引" class="headerlink" title="1.5.1 正排索引"></a>1.5.1 正排索引</h3><p>在说倒排索引之前我们先说说什么是正排索引。正排索引也称为”前向索引”，它是创建倒排索引的基础。</p>
<p>这种组织方法在建立索引的时候结构比较简单，建立比较方便且易于维护;因为索引是基于文档建立的，若是有新的文档加入，直接为该文档建立一个新的索引块，挂接在原来索引文件的后面。若是有文档删除，则直接找到该文档号文档对应的索引信息，将其直接删除。</p>
<p>他适合根据文档ID来查询对应的内容。但是在查询一个keyword在哪些文档里包含的时候需对所有的文档进行扫描以确保没有遗漏，这样就使得检索时间大大延长，检索效率低下。</p>
<table>
<thead>
<tr>
<th>文档ID</th>
<th>文档内容</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>elasticsearch是最流行的搜索引擎</td>
</tr>
<tr>
<td>2</td>
<td>php是世界上最好的语言</td>
</tr>
<tr>
<td>3</td>
<td>搜索引擎是如何诞生的</td>
</tr>
</tbody></table>
<blockquote>
<p>优点：工作原理非常的简单。</p>
<p>缺点：检索效率太低，只能在一起简单的场景下使用。</p>
</blockquote>
<h3 id="1-5-2-倒排索引"><a href="#1-5-2-倒排索引" class="headerlink" title="1.5.2 倒排索引"></a>1.5.2 倒排索引</h3><p>根据字面意思可以知道他和正序索引是反的。在搜索引擎中每个文件都对应一个文件ID，文件内容被表示为一系列关键词的集合（文档要除去一些无用的词，比如’的’这些，剩下的词就是关键词，每个关键词都有自己的ID）。例如“文档1”经过分词，提取了3个关键词，每个关键词都会记录它所在在文档中的出现频率及出现位置。</p>
<p>那么上面的文档及内容构建的倒排索引结果会如下图。</p>
<table>
<thead>
<tr>
<th>单词</th>
<th>文档ID列表</th>
</tr>
</thead>
<tbody><tr>
<td>elasticsearch</td>
<td>1</td>
</tr>
<tr>
<td>流行</td>
<td>1</td>
</tr>
<tr>
<td>搜索引擎</td>
<td>1,3</td>
</tr>
<tr>
<td>php</td>
<td>2</td>
</tr>
<tr>
<td>世界</td>
<td>2</td>
</tr>
<tr>
<td>最好</td>
<td>2</td>
</tr>
<tr>
<td>语言</td>
<td>2</td>
</tr>
<tr>
<td>如何</td>
<td>3</td>
</tr>
<tr>
<td>诞生</td>
<td>3</td>
</tr>
</tbody></table>
<p><strong>如何查询</strong></p>
<p>比如我们要查询‘搜索引擎’这个关键词在哪些文档中出现过。首先我们通过倒排索引可以查询到该关键词出现的文档位置是在1和3中;然后再通过正排索引查询到文档1和3的内容并返回结果。</p>
<h3 id="1-5-3-组成"><a href="#1-5-3-组成" class="headerlink" title="1.5.3 组成"></a>1.5.3 组成</h3><p>倒排索引主要由单词词典（Term Dictionary）和倒排列表（Posting List）及倒排文件(Inverted File)组成。</p>
<p>他们三者的关系如下图：</p>
<img src="/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200907215602.png" srcset="/img/loading.gif" lazyload class="" title="image-20200907215602087">

<p><strong>单词词典（Term Dictionary）：</strong>搜索引擎的通常索引单位是<strong>单词</strong>，单词词典是由文档集合<strong>出现过的所有单词</strong>构成的字符串集合，单词词典内每条索引项记载单词本身的一些信息以及指向“倒排列表”的指针。</p>
<p><strong>倒排列表(PostingList)：</strong>倒排列表记载了出<strong>现过某个单词的所有文档的文档列表及单词在该文档中出现的位置信息及频率</strong>，每条记录称为一个<strong>倒排项</strong>(Posting)。根据倒排列表，即可获知哪些文档包含某个单词。</p>
<p><strong>倒排文件(Inverted File)：</strong>所有单词的倒排列表往往顺序地存储在磁盘的某个文件里，这个文件即被称之为倒排文件，<strong>倒排文件是存储倒排索引的物理文件</strong>。</p>
<h2 id="1-6-ES核心概念"><a href="#1-6-ES核心概念" class="headerlink" title="1.6 ES核心概念"></a>1.6 ES核心概念</h2><p><strong>近实时（NRT）</strong></p>
<ul>
<li>写入数据时，内部在分词、录入索引，一般过1秒左右才会被搜索到</li>
<li>ES搜索时，搜索和分析数据基本秒级出结果</li>
</ul>
<p><strong>集群（Cluster）</strong></p>
<p>包含一个或者多个启动着ES的机器群，同一网络下、集合一样的多个ES实例 <strong>自动组成集群，自动分片</strong> 等行为</p>
<p><strong>节点（Node）</strong></p>
<p>每个ES实例称为一个节点。节点名称可以手动设置，默认自动分配。</p>
<p><strong>索引（Index）</strong></p>
<p>包含一堆有相似结构的文档数据。相当于数据库（也相当于表）</p>
<p>索引创建规则：</p>
<ul>
<li><p>仅限小写字母</p>
</li>
<li><p>不能包含\、/、 *、?、”、&lt;、&gt;、|、#以及空格符等特殊符号</p>
</li>
<li><p>从7.0版本开始不再包含冒号</p>
</li>
<li><p>不能以-、_或+开头</p>
</li>
<li><p>不能超过255个字节（注意它是字节，因此多字节字符将计入255个限制）</p>
</li>
</ul>
<p><strong>文档（Document）</strong></p>
<p>ES中最小的数据单元，对应着数据库中的一条记录。</p>
<p>ES的文档通常用JSON格式展示，多个文档存储于一个索引中</p>
<p><strong>字段（Field）</strong></p>
<p>对应数据库中的列</p>
<p><strong>类型（Type）</strong></p>
<p>每个索引里都可以有一个或多个type，type是index中的一个逻辑数据分类，一个type下的document，都有相同的field。</p>
<blockquote>
<p>ES官方将在9.0版本之后彻底删除type</p>
</blockquote>
<p><strong>分片（shard）</strong></p>
<p>索引的数据量过大时，可以将索引中的数据分成多个分片，存储在多个服务器上。支持海量数据和高并发，提升性能和吞吐量。</p>
<p><strong>副本（replica）</strong></p>
<p>在分布式环境下，任何一台机器都会随时宕机，如果宕机，就会导致此索引不能搜索。所以，为了保证数据的安全，我们会将每个索引的分片经行备份，存储在另外的机器上。保证少数机器宕机es集群仍可以搜索。</p>
<p>能正常提供查询和插入的分片我们叫做主分片（primary shard），其余的我们就管他们叫做备份的分片（replica shard）。</p>
<p>es6.0默认新建索引时是一主一备，2副本5分片，总计10个集群。因此ES集群 <strong>至少需要2台服务器</strong></p>
<table>
<thead>
<tr>
<th>MySQL</th>
<th>Elasticsearch</th>
</tr>
</thead>
<tbody><tr>
<td>数据库Database</td>
<td>索引Index</td>
</tr>
<tr>
<td>表Table</td>
<td>索引Index（旧版本中对应type）</td>
</tr>
<tr>
<td>数据行row</td>
<td>文档 Document</td>
</tr>
<tr>
<td>数据列Column</td>
<td>字段Field</td>
</tr>
</tbody></table>
<h1 id="2-安装ES"><a href="#2-安装ES" class="headerlink" title="2. 安装ES"></a>2. 安装ES</h1><h2 id="2-1-Windows"><a href="#2-1-Windows" class="headerlink" title="2.1 Windows"></a>2.1 Windows</h2><h3 id="2-1-1-安装ES"><a href="#2-1-1-安装ES" class="headerlink" title="2.1.1 安装ES"></a>2.1.1 安装ES</h3><ol>
<li><p>安装JDK，至少要 <strong>1.8</strong> 版本（略）</p>
</li>
<li><p>下载安装包并解压。<a target="_blank" rel="noopener" href="https://www.elastic.co/cn/downloads/elasticsearch">官网</a>。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">bin：脚本目录，包括：启动、停止等可执行脚本<br>config：配置文件目录<br>data：索引目录，存放索引文件的地方<br>logs：日志目录<br>modules：模块目录，包括了es的功能模块<br>plugins :插件目录，es支持插件机制<br></code></pre></td></tr></table></figure></li>
<li><p> 配置文件</p>
</li>
</ol>
<p>   安装形式不同，ES配置文件的地址也不同</p>
<ul>
<li><p>使用zip、tar安装，配置文件在安装目录的config下</p>
</li>
<li><p>使用rpm安装，配置文件在<code>/etc/elasticsearch</code>下</p>
</li>
<li><p>使用msi安装，配置文件在安装目录的config下，并且会自动将config目录的地址写入环境变量 <code>ES_PATH_CONF</code></p>
</li>
<li><p>配置 <code>elasticsearch.yml</code></p>
<p>配置格式是 yaml，属性SpringBoot的同学都知道怎么配置了。不过这里虽然是yml，但是还是按照property的风格配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">path:</span><br>  <span class="hljs-attr">data:</span> <span class="hljs-string">/var/lib/elasticsearch</span><br>  <span class="hljs-attr">logs:</span> <span class="hljs-string">/var/log/elasticsearch</span><br><span class="hljs-string">或者</span><br><span class="hljs-attr">path.data:</span> <span class="hljs-string">H:/视频/软件/es/data</span><br><span class="hljs-attr">path.logs:</span> <span class="hljs-string">H:/视频/软件/es/logs</span><br></code></pre></td></tr></table></figure>

<p>主要的配置内容如下</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">cluster.name:</span> <span class="hljs-string">配置集群名称，默认是elasticsearch。</span><br><span class="hljs-attr">node.name:</span> <span class="hljs-string">节点名，es会默认随机指定一个名字。</span><br><span class="hljs-attr">path.conf:</span> <span class="hljs-string">设置配置文件的存储路径</span><br><span class="hljs-attr">path.data:</span> <span class="hljs-string">设置索引数据的存储路径，默认是es根目录下的data文件夹，可以设置多个存储路径，用逗号隔开。</span><br><span class="hljs-attr">path.logs:</span> <span class="hljs-string">设置日志文件的存储路径，默认是es根目录下的logs文件夹</span><br><span class="hljs-attr">path.plugins:</span> <span class="hljs-string">设置插件的存放路径，默认是es根目录下的plugins文件夹</span><br><span class="hljs-attr">bootstrap.memory_lock:</span> <span class="hljs-string">设置为true可以锁住ES使用的内存，避免内存与swap分区交换数据。</span><br><span class="hljs-attr">network.host:</span> <span class="hljs-string">设置绑定主机的ip地址，设置为0.0.0.0表示绑定任何ip，允许外网访问，生产环境建议设置为具体的ip。</span><br><span class="hljs-attr">http.port:</span> <span class="hljs-string">设置对外服务的http端口，默认为9200。</span><br><span class="hljs-attr">transport.tcp.port:</span> <span class="hljs-number">9300</span>  <span class="hljs-string">集群结点之间通信端口</span><br><span class="hljs-attr">node.master:</span> <span class="hljs-string">指定该节点是否有资格被选举成为master结点，默认是true，如果原来的master宕机会重新选举新的master。</span><br><span class="hljs-attr">node.data:</span> <span class="hljs-string">指定该节点是否存储索引数据，默认为true。</span><br><span class="hljs-attr">discovery.zen.ping.unicast.hosts:</span> [<span class="hljs-string">&quot;host1:port&quot;</span>, <span class="hljs-string">&quot;host2:port&quot;</span>, <span class="hljs-string">&quot;...&quot;</span>] <span class="hljs-string">设置集群中master节点的初始列表。</span><br><span class="hljs-attr">discovery.zen.ping.timeout:</span> <span class="hljs-string">设置ES自动发现节点连接超时的时间，默认为3s，如果网络延迟高可设置大些。</span><br><span class="hljs-attr">discovery.zen.minimum_master_nodes:</span> <span class="hljs-string">主结点数量的最少值</span> <span class="hljs-string">,此值的公式为：(master_eligible_nodes</span> <span class="hljs-string">/</span> <span class="hljs-number">2</span><span class="hljs-string">)</span> <span class="hljs-string">+</span> <span class="hljs-number">1</span> <span class="hljs-string">，比如：有3个符合要求的主结点，那么这里要设置为2。</span><br><span class="hljs-attr">node.max_local_storage_nodes:</span> <span class="hljs-string">单机允许的最大存储结点数，通常单机启动一个结点建议设置为1，开发环境如果单机启动多个节点可设置大于1。</span><br></code></pre></td></tr></table></figure></li>
<li><p>配置 <code>jvm.options</code></p>
<p>改配置用于设置一些JVM参数，常见的就是设置JVM堆内存</p>
</li>
</ul>
<ol start="4">
<li><p>启动。开箱即用，直接运行bin目录下的 <code>elasticsearch.bat</code> 即可</p>
</li>
<li><p>检查是否启动成功，访问 <a target="_blank" rel="noopener" href="http://localhost:9200/?pretty">http://localhost:9200/?pretty</a> </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node-1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;cluster_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my-application&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;cluster_uuid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;qSu-6EmsQ_qT9Cf_SiiGSg&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;number&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;7.3.0&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;build_flavor&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;default&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;build_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zip&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;build_hash&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;de777fa&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;build_date&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2019-07-24T18:30:11.767338Z&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;build_snapshot&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;lucene_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;8.1.0&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;minimum_wire_compatibility_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;6.8.0&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;minimum_index_compatibility_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;6.0.0-beta1&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;tagline&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;You Know, for Search&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li>
<li><p>浏览器访问 <a target="_blank" rel="noopener" href="http://localhost:9200/_cluster/health">http://localhost:9200/_cluster/health</a> 查询集群状态</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;cluster_name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my-application&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;green&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;number_of_nodes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;number_of_data_nodes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;active_primary_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;active_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;relocating_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;initializing_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;unassigned_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;delayed_unassigned_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;number_of_pending_tasks&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;number_of_in_flight_fetch&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;task_max_waiting_in_queue_millis&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;active_shards_percent_as_number&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>Status：集群状态。Green 所有分片可用。Yellow所有主分片可用。Red主分片不可用，集群不可用。</p>
</blockquote>
</li>
</ol>
<h3 id="2-1-2-安装Head"><a href="#2-1-2-安装Head" class="headerlink" title="2.1.2 安装Head"></a>2.1.2 安装Head</h3><ol>
<li><p>安装</p>
<p>ES的安装包只提供了 REST 风格的操作，并没有可视化界面。如果需要可视化界面，可以安装 head 插件。head插件是ES的可视化管理插件，用来监视ES的状态，并通过head客户端和ES交互。</p>
<p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/mobz/elasticsearch-head">https://github.com/mobz/elasticsearch-head</a></p>
<p>运行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 装包</span><br>npm i<br><span class="hljs-comment"># 运行</span><br>npm run start<br></code></pre></td></tr></table></figure>

<p>浏览器打开 <a target="_blank" rel="noopener" href="http://localhost:9100/">http://localhost:9100/</a></p>
</li>
</ol>
<img src="/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200908002226.png" srcset="/img/loading.gif" lazyload class="" title="image-20200908002225986">

<ol start="2">
<li><p>配置跨域</p>
<p>ES 默认是不允许跨域访问的，因此head插件会存在跨域问题。可以配置elasticsearch.yml来开启跨域（注意，需要将该文件另存为utf-8编码格式）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#开启cors跨域访问支持，默认为false   </span><br><span class="hljs-attr">http.cors.enabled:</span> <span class="hljs-literal">true</span>   <br><span class="hljs-comment">#跨域访问允许的域名地址，(允许所有域名)以上使用正则   </span><br><span class="hljs-attr">http.cors.allow-origin:</span> <span class="hljs-string">/.*/</span><br></code></pre></td></tr></table></figure>

<p>配置成功后如果还存在跨域问题，重启ES即可。</p>
</li>
</ol>
<h2 id="2-2-Linux"><a href="#2-2-Linux" class="headerlink" title="2.2 Linux"></a>2.2 Linux</h2><h3 id="2-2-1-安装ES"><a href="#2-2-1-安装ES" class="headerlink" title="2.2.1 安装ES"></a>2.2.1 安装ES</h3><ol>
<li><p>安装JDK，至少1.8版本</p>
<p>下载JDK上传至 <code>/usr/local/soft</code></p>
<p>解压</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar -zxvf jdk-8u261-linux-x64.tar.gz<br></code></pre></td></tr></table></figure>

<p>修改环境变量</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi /etc/profile<br></code></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">set</span> java environment<br>JAVA_HOME=/usr/local/soft/jdk1.8.0_261    <br>JRE_HOME=/usr/local/soft/jdk1.8.0_261/jre     <br>CLASS_PATH=.:<span class="hljs-variable">$JAVA_HOME</span>/lib/dt.jar:<span class="hljs-variable">$JAVA_HOME</span>/lib/tools.jar:<span class="hljs-variable">$JRE_HOME</span>/lib<br>PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$JRE_HOME</span>/bin<br><span class="hljs-built_in">export</span> JAVA_HOME JRE_HOME CLASS_PATH PATH<br></code></pre></td></tr></table></figure>

<p>让配置生效</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> /etc/profile<br></code></pre></td></tr></table></figure></li>
<li><p>安装ES，下载链接同上，资料已提供</p>
<p>上传至 <code>/usr/local/soft</code></p>
<p>解压</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar -zxvf elasticsearch-7.3.0-linux-x86_64.tar.gz<br></code></pre></td></tr></table></figure></li>
<li><p>添加用户，设置权限</p>
<p>ES5.0以上版本需要使用非root用户，否则无法启动，因此需要新建一个用户来启动ES。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">useradd es <span class="hljs-comment"># 创建新用户es。成功后会在/home下创建一个es目录</span><br>passwd es <span class="hljs-comment"># 给es设置密码</span><br>userdel es <span class="hljs-comment"># 删除用户es</span><br></code></pre></td></tr></table></figure>

<p>创建数据和日志目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">mkdir</span> -pv /usr/local/es/data<br><span class="hljs-built_in">mkdir</span> -pv /usr/local/es/logs<br></code></pre></td></tr></table></figure>

<p>修改文件所有者</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">chown</span> -R es:es /usr/local/es/<br><span class="hljs-built_in">chown</span> -R es:es /usr/local/soft/elasticsearch-7.3.0/     <br></code></pre></td></tr></table></figure>

<p>vim 编辑 /etc/security/limits.conf，在末尾加上：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 能打开文件的最大数</span><br>es soft nofile 65536<br>es hard nofile 65536<br><span class="hljs-comment"># 进程最大数</span><br>es soft <span class="hljs-built_in">nproc</span> 4096<br>es hard <span class="hljs-built_in">nproc</span> 4096<br></code></pre></td></tr></table></figure>

<p>vim 编辑 vim /etc/security/limits.d/20-nproc.conf，将* 改为用户名（es）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># Default limit for number of user&#x27;s processes to prevent</span><br><span class="hljs-comment"># accidental fork bombs.</span><br><span class="hljs-comment"># See rhbz #432903 for reasoning.</span><br><br>es      soft    <span class="hljs-built_in">nproc</span>     4096<br>root       soft    <span class="hljs-built_in">nproc</span>     unlimited<br></code></pre></td></tr></table></figure>

<p>vim 编辑 /etc/sysctl.conf，在末尾加上：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 最大虚拟内存大小</span><br>vm.max_map_count = 655360<br></code></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">sysctl -p<br></code></pre></td></tr></table></figure></li>
<li><p>配置 <code>elasticsearch.yml</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">path.data: /usr/local/es/data<br>path.logs: /usr/local/es/logs<br>network.host: 0.0.0.0<br></code></pre></td></tr></table></figure>

<p>此外，下面两处的配置也需要解开</p>
<img src="/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200911223257.png" srcset="/img/loading.gif" lazyload class="" title="image-20200911223257095">

<img src="/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200911223325.png" srcset="/img/loading.gif" lazyload class="" title="image-20200911223325704">

<p>配置 <code>jvm.options</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">-Xms256m<br>-Xmx256m<br></code></pre></td></tr></table></figure>



<p>考虑到看本课程的同学大部分是学生，服务器也是学生机，因此一定要配置堆内存。</p>
</li>
<li><p>使用上面创建的用户进行登录，并启动es</p>
</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">nohup</span> bin/elasticsearch &amp;<br></code></pre></td></tr></table></figure>

<p>​    查看是否安装成功</p>
<h3 id="2-2-2-安装Head"><a href="#2-2-2-安装Head" class="headerlink" title="2.2.2 安装Head"></a>2.2.2 安装Head</h3><ol>
<li><p>下载并安装nodejs <a target="_blank" rel="noopener" href="https://npm.taobao.org/mirrors/node/v14.9.0/">https://npm.taobao.org/mirrors/node/v14.9.0/</a></p>
<p>下载成功后上传到 <code>/usr/local/soft</code></p>
<p>解压</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar -zxvf node-v14.9.0-linux-x64.tar.gz<br></code></pre></td></tr></table></figure></li>
<li><p>修改环境变量</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">vi /etc/profile<br></code></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">export</span> NODE_HOME=/usr/local/soft/node-v14.9.0-linux-x64<br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$NODE_HOME</span>/bin<br><span class="hljs-built_in">export</span> NODE_PATH=<span class="hljs-variable">$NODE_HOME</span>/lib/node_modules<br></code></pre></td></tr></table></figure>

<p>让配置生效</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">source</span> /etc/profile<br></code></pre></td></tr></table></figure></li>
<li><p>剩余步骤同windows</p>
</li>
</ol>
<h2 id="2-3-Docker"><a href="#2-3-Docker" class="headerlink" title="2.3 Docker"></a>2.3 Docker</h2><h3 id="2-3-1-安装ES"><a href="#2-3-1-安装ES" class="headerlink" title="2.3.1 安装ES"></a>2.3.1 安装ES</h3><ol>
<li><p>安装Docker</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh">yum -y install gcc<br>yum -y install gcc-c++<br>yum install -y yum-utils device-mapper-persistent-data lvm2<br>yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br>yum makecache fast<br>yum -y install docker-ce<br>systemctl start docker<br><br>上面全部复制，一起粘贴即可<br>下面是配置国内仓库，可以不进行<br><br><span class="hljs-built_in">mkdir</span> -p /etc/docker<br>vim  /etc/docker/daemon.json<br><br>在文件中添加如下配置<br>&#123;<span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;http://hub-mirror.c.163.com&quot;</span>] &#125;<br>systemctl daemon-reload<br>systemctl restart docker<br></code></pre></td></tr></table></figure></li>
<li><p>创建各种目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">mkdir</span> -p /usr/local/dockeres/data<br><span class="hljs-built_in">mkdir</span> -p /usr/local/dockeres/logs<br><span class="hljs-built_in">mkdir</span> -p /usr/local/dockeres/config<br></code></pre></td></tr></table></figure>

<blockquote>
<p>一般我们只会配置 <code>elasticsearch.yml</code> 和 <code>jvm.options</code> 两个配置文件，因此我们把两个配置文件复制到config目录下</p>
<p>配置文件的配置方式和linux安装方式一样</p>
</blockquote>
</li>
<li><p>拉取镜像并创建容器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">   docker run -di --name=elasticsearch -p 9200:9200 -p 9300:9300 \<br>   -v /usr/local/dockeres/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \<br>   -v /usr/local/dockeres/config/jvm.options:/usr/share/elasticsearch/config/jvm.options \<br>   -v /usr/local/dockeres/data:/usr/local/dockeres/data \<br>   -v /usr/local/dockeres/logs:/usr/local/dockeres/logs \<br>-v /usr/local/dockeres/plugins/:/usr/share/elasticsearch/plugins/ \<br>   elasticsearch:7.3.0<br>   <br></code></pre></td></tr></table></figure>

<blockquote>
<p>报错可能是因为没有权限</p>
<p>chmod -R 777 dockeres</p>
</blockquote>
</li>
</ol>
<h3 id="2-3-2-安装Head"><a href="#2-3-2-安装Head" class="headerlink" title="2.3.2 安装Head"></a>2.3.2 安装Head</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run -di --name=elastic-head -p 9100:9100 mobz/elasticsearch-head:7<br></code></pre></td></tr></table></figure>

<p>之后访问即可</p>
<h3 id="2-3-3-安装ElasticHD"><a href="#2-3-3-安装ElasticHD" class="headerlink" title="2.3.3 安装ElasticHD"></a>2.3.3 安装ElasticHD</h3><p>elasticsearch-head的UI风格在现在看来实在不敢恭维，因此这里推荐另外两款可视化工具，首先是ElasticHD</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run -p 9800:9800 -di --name=elasticHD --<span class="hljs-built_in">link</span> elasticsearch:es containerize/elastichd<br></code></pre></td></tr></table></figure>

<blockquote>
<p>这里的–link是用来连接两个容器，使之可以互相通信。:es是为连接容器起的别名</p>
</blockquote>
<h3 id="2-3-4-安装Dejavu"><a href="#2-3-4-安装Dejavu" class="headerlink" title="2.3.4 安装Dejavu"></a>2.3.4 安装Dejavu</h3><p>Dejavu是另一款可视化工具，UI界面更符合当下主流的前端风格，使用起来也很方便</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run -p 1358:1358 -d appbaseio/dejavu<br></code></pre></td></tr></table></figure>

<h1 id="3-快速上手"><a href="#3-快速上手" class="headerlink" title="3. 快速上手"></a>3. 快速上手</h1><p>ES采用json形式RESTFUL API接受数据并响应，操作起来极为简单，只需要使用postman即可。</p>
<h2 id="3-1-查看集群的健康情况"><a href="#3-1-查看集群的健康情况" class="headerlink" title="3.1 查看集群的健康情况"></a>3.1 查看集群的健康情况</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /_cat/health?v<br></code></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">epoch      timestamp cluster        status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent<br>1599841683 16:28:03  my-application green           1         1      0   0    0    0        0             0                  -                100.0%<br><br></code></pre></td></tr></table></figure>

<blockquote>
<ol>
<li>cluster ，集群名称</li>
<li>status，集群状态 green代表健康；yellow代表分配了所有主分片，但至少缺少一个副本，此时集群数据仍旧完整；red代表部分主分片不可用，可能已经丢失数据。</li>
<li>node.total，代表在线的节点总数量</li>
<li>node.data，代表在线的数据节点的数量</li>
<li>shards， active_shards 存活的分片数量</li>
<li>pri，active_primary_shards 存活的主分片数量 正常情况下 shards的数量是pri的两倍。</li>
<li>relo， relocating_shards 迁移中的分片数量，正常情况为 0</li>
<li>init，  initializing_shards 初始化中的分片数量 正常情况为 0</li>
<li>unassign，  unassigned_shards 未分配的分片 正常情况为 0</li>
<li>pending_tasks，准备中的任务，任务指迁移分片等 正常情况为 0</li>
<li>max_task_wait_time，任务最长等待时间</li>
<li>active_shards_percent，正常分片百分比 正常情况为 100%</li>
</ol>
</blockquote>
<h2 id="3-2-索引操作"><a href="#3-2-索引操作" class="headerlink" title="3.2 索引操作"></a>3.2 索引操作</h2><h3 id="3-2-1-查看集群中的索引"><a href="#3-2-1-查看集群中的索引" class="headerlink" title="3.2.1 查看集群中的索引"></a>3.2.1 查看集群中的索引</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /_cat/indices?v<br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">health status index    uuid                   pri rep docs.count docs.deleted store.size pri.store.size<br>yellow open   my_index LiwgtxiRRH68FyNW9GLe7A   1   1          0            0       230b           230b<br><br></code></pre></td></tr></table></figure>



<h3 id="3-2-2-创建索引"><a href="#3-2-2-创建索引" class="headerlink" title="3.2.2 创建索引"></a>3.2.2 创建索引</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /索引名称?pretty<br></code></pre></td></tr></table></figure>

<blockquote>
<p>这里pretty的作用是格式化返回的json串</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-attr">&quot;acknowledged&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;shards_acknowledged&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my_index&quot;</span><br><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<h3 id="3-2-3-删除索引"><a href="#3-2-3-删除索引" class="headerlink" title="3.2.3 删除索引"></a>3.2.3 删除索引</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">DELETE /索引名称?pretty<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-attr">&quot;acknowledged&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<h2 id="3-3-帖子案例（CRUD）"><a href="#3-3-帖子案例（CRUD）" class="headerlink" title="3.3 帖子案例（CRUD）"></a>3.3 帖子案例（CRUD）</h2><h3 id="3-3-1-创建帖子索引"><a href="#3-3-1-创建帖子索引" class="headerlink" title="3.3.1 创建帖子索引"></a>3.3.1 创建帖子索引</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /article<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-attr">&quot;acknowledged&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;shards_acknowledged&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><br><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<h3 id="3-3-2-创建文档（新增帖子）"><a href="#3-3-2-创建文档（新增帖子）" class="headerlink" title="3.3.2 创建文档（新增帖子）"></a>3.3.2 创建文档（新增帖子）</h3><p>语法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /index/type/id<br></code></pre></td></tr></table></figure>

<p>下面创建3条帖子</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">article/_doc/3<br></code></pre></td></tr></table></figure>



<p>第一条</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Java从入门到精通&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;red&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">101</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Java是一门面向对象编程语言，不仅吸收了C++语言的各种优点，还摒弃了C++里难以理解的多继承、指针等概念，因此Java语言具有功能强大和简单易用两个特征。Java语言作为静态面向对象编程语言的代表，极好地实现了面向对象理论，允许程序员以优雅的思维方式进行复杂的编程&quot;</span><br><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>第二条</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;JavaEE从入门到入土&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;red&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Java EE 是 J2EE的一个新的名称，之所以改名，目的还是让大家清楚J2EE只是Java企业应用。在2004年底中国软件技术大会Ioc微容器（也就是Jdon框架的实现原理）演讲中指出：我们需要一个跨J2SE/WEB/EJB的微容器，保护我们的业务核心组件（中间件），以延续它的生命力，而不是依赖J2SE/J2EE版本&quot;</span><br><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>第三条</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;PHP从入门到精通&quot;</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;red&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span><br><span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;众所周知，PHP是世界上最好的语言&quot;</span><br><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<h3 id="3-3-3-检索文档（查询帖子）"><a href="#3-3-3-检索文档（查询帖子）" class="headerlink" title="3.3.3 检索文档（查询帖子）"></a>3.3.3 检索文档（查询帖子）</h3><p>语法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /index/type/id<br><br></code></pre></td></tr></table></figure>



<p><strong>字段含义</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;found&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Java从入门到精通&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;red&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">101</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Java是一门面向对象编程语言，不仅吸收了C++语言的各种优点，还摒弃了C++里难以理解的多继承、指针等概念，因此Java语言具有功能强大和简单易用两个特征。Java语言作为静态面向对象编程语言的代表，极好地实现了面向对象理论，允许程序员以优雅的思维方式进行复杂的编程&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>_index：该文档属于哪个索引</li>
<li>_type：相当于表。ES一直在弱化type，现在的type实际上都是_doc。ES9之后将彻底删除type</li>
<li>_id：文档的唯一标识，相当于主键。可以手动生成，也可以自动</li>
<li>_seq_no：递增的序列号，保证每次操作都比前一次大</li>
<li>_version：版本号，表示该数据被修改了多少次</li>
<li>found：是否查询到</li>
<li>_primary_term：当分片重新选举时，+1</li>
<li>_source：查询的数据</li>
</ul>
<h3 id="3-3-4-替换文档（修改帖子）"><a href="#3-3-4-替换文档（修改帖子）" class="headerlink" title="3.3.4 替换文档（修改帖子）"></a>3.3.4 替换文档（修改帖子）</h3><p>所谓替换文档，就是将整个文档的内容全部替换成新内容。替换操作不需要字段对应上，因为是完全替换的</p>
<p>语法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /index/type/id<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;PHP从入门到跑路&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<h3 id="3-3-5-修改文档（修改帖子）"><a href="#3-3-5-修改文档（修改帖子）" class="headerlink" title="3.3.5 修改文档（修改帖子）"></a>3.3.5 修改文档（修改帖子）</h3><p>所谓修改文档，就是修改文档中的某个字段。</p>
<p>语法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">POST  /index/type/id/_update<br></code></pre></td></tr></table></figure>

<blockquote>
<p>update操作不能直接指定字段，而是需要在外面包一层 doc</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;doc&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;PHP从入门到跑路2&quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<h3 id="3-3-6-删除文档（删除帖子）"><a href="#3-3-6-删除文档（删除帖子）" class="headerlink" title="3.3.6 删除文档（删除帖子）"></a>3.3.6 删除文档（删除帖子）</h3><p>语法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">DELETE /index/type/1<br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">article/_doc/4<br></code></pre></td></tr></table></figure>





<h1 id="4-CRUD提高"><a href="#4-CRUD提高" class="headerlink" title="4. CRUD提高"></a>4. CRUD提高</h1><h2 id="4-1-文档ID生成"><a href="#4-1-文档ID生成" class="headerlink" title="4.1 文档ID生成"></a>4.1 文档ID生成</h2><h3 id="4-1-1-自动生成"><a href="#4-1-1-自动生成" class="headerlink" title="4.1.1 自动生成"></a>4.1.1 自动生成</h3><p>当我们从外界导入数据到ES时，我们并不希望改变原本数据的主键，就需要手动设置ID。手动设置的方式在上面已经学习</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">put /index/type/id<br></code></pre></td></tr></table></figure>

<h3 id="4-1-2-自动生成"><a href="#4-1-2-自动生成" class="headerlink" title="4.1.2 自动生成"></a>4.1.2 自动生成</h3><p>语法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /index/type<br></code></pre></td></tr></table></figure>

<p>自动生成的ID，长度是20个字符的GUID，分布式全局唯一。</p>
<h2 id="4-2-查询指定字段"><a href="#4-2-查询指定字段" class="headerlink" title="4.2 查询指定字段"></a>4.2 查询指定字段</h2><p>在我们操作mysql时，想必大部分的公司都是禁止使用 <code>select *</code> 的，而要求用到什么列就查询什么列。</p>
<p>而我们上面使用ES的方式，就相当于在写 <code>select *</code> ，这是不推荐的，我们在实际使用的时候，可以只查询指定的字段。</p>
<p>语法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET  /index/type/id?_source_includes=字段名，多个字段逗号隔开    <br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">article/_doc/1?_source_includes=title,content<br></code></pre></td></tr></table></figure>



<h2 id="4-3-强制创建"><a href="#4-3-强制创建" class="headerlink" title="4.3 强制创建"></a>4.3 强制创建</h2><p>在上面的学习中，我们发现，替换文档和创建文档的API是一样的，这就意味着，我们在创建文档的过程中，可能这个文档其实已经存在了，但是我们不知道，通过创建的API直接把该文档进行了替换，这不是我们想要的结果，因此需要使用强制创建。</p>
<p>强制创建限定这个API只能是创建文档，如果指定ID的文档已经存在了，就抛出异常。</p>
<p>语法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /index/type/id/_create<br></code></pre></td></tr></table></figure>

<h2 id="4-4-lazy-delete"><a href="#4-4-lazy-delete" class="headerlink" title="4.4 lazy delete"></a>4.4 lazy delete</h2><p>ES在替换文档、修改文档的时候，本质上并不是直接替换，而是先将旧文档标记为deleted，然后再创建新的文档。此时旧的文档实际上还是存在于索引库里的，并不会立即删除，集群会找个合适的时机，一并删除所有标记deleted的文档</p>
<p>同样，删除的API也只是标记了deleted，并不是立即删除。</p>
<p>如果删除一条数据立马删除的话，所有分片和副本都要立马删除，对es集群压力太大。</p>
<h2 id="4-5-手动设置版本号"><a href="#4-5-手动设置版本号" class="headerlink" title="4.5 手动设置版本号"></a>4.5 手动设置版本号</h2><p>我们的数据库中可能已经维护了版本号，现在需要同步这些数据，同步的时候需要手动设置版本号</p>
<p>可以通过使用 <code>external version</code> 控制，设置的时候版本号必须大于当前文档的版本号</p>
<p>语法：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /index/type/id?version=要修改的版本号&amp;version_type=external<br></code></pre></td></tr></table></figure>

<p>两个客户端同时修改，只会有一个修改成功。</p>
<h2 id="4-6-批量操作"><a href="#4-6-批量操作" class="headerlink" title="4.6 批量操作"></a>4.6 批量操作</h2><h3 id="4-6-1-批量查询"><a href="#4-6-1-批量查询" class="headerlink" title="4.6.1 批量查询"></a>4.6.1 批量查询</h3><p>当我们要根据id查询的时候，如果一条一条查，性能损耗和网络开销大，可以使用批量查询</p>
<p>语法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /_mget<br></code></pre></td></tr></table></figure>

<p>_mget是全查询，操作起来并不是那么方便，并且容易报出 <code>request body or source parameter is required</code> 异常，因此使用率较少</p>
<h3 id="4-6-2-批量增删改"><a href="#4-6-2-批量增删改" class="headerlink" title="4.6.2 批量增删改"></a>4.6.2 批量增删改</h3><p><code>_bulk</code> 操作将文档的增删改查一系列操作，通过以此请求全部做完，减少网络传输次数</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /_bulk<br></code></pre></td></tr></table></figure>

<p>注意，bulk操作的形式是多个json，每个json写完必须换行，而在json内则不可以换行。多个json之间操作互不影响，即使报错了，其他行也可以正常执行</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;delete&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;create&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;我是批量操作中创建的数据，ID是7 &quot;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;update&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;doc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;我在批量操作中进行了修改，但是PHP依然是最好的语言&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure>



<p>总结：</p>
<ul>
<li> delete：删除一个文档，只要1个json串就可以了</li>
<li> create：相当于强制创建  PUT /index/type/id/_create </li>
<li> index：普通的put操作，可以是创建文档，也可以是全量替换文档</li>
<li> update：执行的是局部更新partial update操作</li>
<li> 使用json格式发送数据（postman中报错不要紧），最后一行也需要换行 </li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;errors&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;items&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;delete&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;6&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;not_found&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">31</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">404</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;create&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;7&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">409</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;error&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;version_conflict_engine_exception&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;reason&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;[7]: version conflict, document already exists (current version [1])&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;index_uuid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;uHYrNKR2S1Gf6dsFONzwVg&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;shard&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;update&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;5&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;noop&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>                <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;status&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<h2 id="4-7-ES的并发问题"><a href="#4-7-ES的并发问题" class="headerlink" title="4.7 ES的并发问题"></a>4.7 ES的并发问题</h2><p>通常情况下，ES在多线程操作的时候，会产生并发问题</p>
<p>举个例子，我跟你在淘宝在同一时间下单买了同一本书，两个线程同时去es扣这本书的库存，库存有100本书，正常情况扣完库存后应该变成98本，但如果两个线程并发冲突，就会变成这样</p>
<img src="/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200912221855.png" srcset="/img/loading.gif" lazyload class="" title="image-20200912221836552">

<p>可以看到库存的值变成了99本，与我们期望中的98本不符。这一现象也叫超卖，对数据库的库存扣减的时候也会出现这种并发冲突的情况。</p>
<p>为控制并发问题，我们通常采用锁机制。分为悲观锁和乐观锁两种机制。</p>
<h3 id="4-7-1-悲观锁"><a href="#4-7-1-悲观锁" class="headerlink" title="4.7.1 悲观锁"></a>4.7.1 悲观锁</h3><p>悲观锁的思路是在线程1读到库存是100的时候就把es的这条库存给锁上，阻止线程2去读库存，线程1扣完库存并把新的库存量99写入es后，才允许线程2去读取库存，这时线程2读取出来的库存是99而不是100，扣减完变成98再写入es。</p>
<blockquote>
<p>这种思路实际是把并发的线程转成串行执行，非常方便，直接加锁就行，对程序来说不需要做额外的操作，但是并发能力低，同一时间只能一条线程去扣减库存。</p>
</blockquote>
<h3 id="4-7-2-乐观锁"><a href="#4-7-2-乐观锁" class="headerlink" title="4.7.2 乐观锁"></a>4.7.2 乐观锁</h3><p>乐观锁的思路是给es的库存附加一个版本号，并发冲突的情况下，线程1读取库存库存100(版本号1)，线程2读取库存100(版本号1)，线程1扣减库存后变成99，线程2扣减后变成99，线程1写入库存99到es前比对库存版本号(线程1读取的库存版本号为1，当前es的库存版本号为1)发现一致，于是写入库存99到es并更新库存版本号为2，线程2写入库存99到es前比对库存版本号(线程2读取的库存版本号为1，当前es的库存版本号为2)发现不一致，线程2写入失败，线程2重新读取库存99(版本号2)，线程2扣减后变成98，线程2写入库存98到es前比对库存版本号(都是2)发现一致，于是写入库存98到es并更新库存版本号为3</p>
<blockquote>
<p>这种方式只是在把库存写入es那一刻检查一下版本号判断是否可以写入就行了，不需要把库存锁上，因此并发能力很高，但这种方式编码的时候比较麻烦，每次更新库存都要去比对版本号和更新版本号，版本号对不上的时候还需要重新读取库存并扣库存。</p>
</blockquote>
<h3 id="4-7-3-ES的乐观锁"><a href="#4-7-3-ES的乐观锁" class="headerlink" title="4.7.3 ES的乐观锁"></a>4.7.3 ES的乐观锁</h3><p>ES对文档的增删改都是基于版本号，也就是 <code>_version</code> 字段，新版本基于 <code>_seq_no</code>字段</p>
<img src="/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200912223339.png" srcset="/img/loading.gif" lazyload class="" title="image-20200912223339251">

<ol>
<li>多次新增同一个文档，发现版本号递增</li>
<li>删除文档再新增，发现版本号依然递增，验证了延迟删除策略</li>
</ol>
<h3 id="4-7-4-乐观锁演示"><a href="#4-7-4-乐观锁演示" class="headerlink" title="4.7.4 乐观锁演示"></a>4.7.4 乐观锁演示</h3><ol>
<li><p>查询数据当前的版本号</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /article/_doc/7<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;10&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_seq_no&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">39</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_primary_term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;found&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;MySQL从入门到秃头6&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li>
<li><p>客户端1更新，带版本号</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /article/_doc/7?if_seq_no=40&amp;if_primary_term=1<br></code></pre></td></tr></table></figure></li>
<li><p>客户端2更新，带版本号，报错</p>
</li>
<li><p>客户端2重新查询版本号</p>
</li>
<li><p>客户端2更新，带版本号</p>
</li>
</ol>
<h2 id="4-8-更新时的重试机制（retry-on-conflict-）"><a href="#4-8-更新时的重试机制（retry-on-conflict-）" class="headerlink" title="4.8 更新时的重试机制（retry_on_conflict ）"></a>4.8 更新时的重试机制（retry_on_conflict ）</h2><p>有时候我们更新时，并不希望失败了直接报错，而是想让程序有一定的重试机制，重试一定次数后如果还是失败，就报错，这时候可以使用 <strong>retry_on_conflict</strong></p>
<p>指定重试次数</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /index/type/_update?retry_on_conflict=次数<br></code></pre></td></tr></table></figure>



<p>和_version一起使用</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /index/type/5/_update?retry_on_conflict=3&amp;version=22&amp;version_type=external<br></code></pre></td></tr></table></figure>





<h1 id="5-search搜索"><a href="#5-search搜索" class="headerlink" title="5. search搜索"></a>5. search搜索</h1><h2 id="5-1-普通搜索"><a href="#5-1-普通搜索" class="headerlink" title="5.1 普通搜索"></a>5.1 普通搜索</h2><p>语法：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /index/_search<br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">83</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Java从入门到精通&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;red&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">101</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Java是一门面向对象编程语言，不仅吸收了C++语言的各种优点，还摒弃了C++里难以理解的多继承、指针等概念，因此Java语言具有功能强大和简单易用两个特征。Java语言作为静态面向对象编程语言的代表，极好地实现了面向对象理论，允许程序员以优雅的思维方式进行复杂的编程&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;JavaEE从入门到入土&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;red&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Java EE 是 J2EE的一个新的名称，之所以改名，目的还是让大家清楚J2EE只是Java企业应用。在2004年底中国软件技术大会Ioc微容器（也就是Jdon框架的实现原理）演讲中指出：我们需要一个跨J2SE/WEB/EJB的微容器，保护我们的业务核心组件（中间件），以延续它的生命力，而不是依赖J2SE/J2EE版本&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;3&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;PHP从入门到精通&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;red&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;众所周知，PHP是世界上最好的语言&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<blockquote>
<p>took：执行毫秒</p>
<p>timed_out：是否超时</p>
<p>_shards：到几个分片搜索，成功几个，跳过几个，失败几个。 </p>
<p>total：查询总数</p>
<p>max_score：相关度。越相关分数越高</p>
<p>hits：查询命中的document</p>
</blockquote>
<h2 id="5-2-传参搜索"><a href="#5-2-传参搜索" class="headerlink" title="5.2 传参搜索"></a>5.2 传参搜索</h2><p>语法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /index/_search?q=key:value&amp;sort=key:desc或者asc<br></code></pre></td></tr></table></figure>

<blockquote>
<p>q是搜索条件，键值对形式，这里的条件是模糊匹配，相当于 like ‘%value%’</p>
<p>sort是排序条件，desc或者asc</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">article/_search?q=content:java<br>article/_search?q=content:java&amp;sort=red:asc<br></code></pre></td></tr></table></figure>



<p>语法2</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /index/_search?q=value<br></code></pre></td></tr></table></figure>

<blockquote>
<p>这样可以搜索到所有的字段。任意一个字段包含指定的关键字都可以搜索出来。</p>
<p>注意，这种搜索方式并不是把每个字段遍历了一遍，ES在建立索引的时候，会将所有的field值进行全量分词，把这些分词放到 <strong>all field</strong> 中，在不指定字段的时候，就从all中搜索</p>
</blockquote>
<h2 id="5-3-多索引搜索"><a href="#5-3-多索引搜索" class="headerlink" title="5.3 多索引搜索"></a>5.3 多索引搜索</h2><p>语法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http">/_search：查询所有索引下的所有数据<br>/index1/_search：查询index下的所有数据<br>/index1,index2/_search：查询多个index下的所有数据<br>/index*/_search：通配符去搜索多个索引<br></code></pre></td></tr></table></figure>

<p>应用场景：如日志表，会按照日期拆分，每天一个日志</p>
<h2 id="5-4-分页搜索"><a href="#5-4-分页搜索" class="headerlink" title="5.4 分页搜索"></a>5.4 分页搜索</h2><p>语法</p>
<p>select * from article limit 4,2</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /index/_search?from=1&amp;size=2<br></code></pre></td></tr></table></figure>

<p>这里的from 1 size 2相当于mysql中的 limit 1,2</p>
<h2 id="5-5-QUERY-DSL"><a href="#5-5-QUERY-DSL" class="headerlink" title="5.5 QUERY DSL"></a>5.5 QUERY DSL</h2><p>我们上面的搜索方式，是把查询条件用问号拼接到后面，当参数越来越多的时候，搜索条件越来越复杂的时候，操作起来很麻烦。ES可以在请求体携带搜索条件，功能强大。</p>
<p>DSL:Domain Specified Language，特定领域的语言</p>
<p>查询全部 POST /index/_search</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /index/_search<br><br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match_all&quot;: &#123;&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>条件查询 POST/index/_search?q=name:java</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /index/_search <br><br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match&quot;: &#123;<br>       &quot;title&quot;: &quot;java PHP&quot;<br>  <br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>排序 POST/index/_search?sort=read</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/index/</span>_search <br><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>       <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;java PHP&quot;</span><br>  <br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;sort&quot;</span>: [<br>    &#123;<br>      <span class="hljs-string">&quot;red&quot;</span>: <span class="hljs-string">&quot;asc&quot;</span><br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>分页查询 POST/index/_search?size=10&amp;from=0</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST  <span class="hljs-regexp">/index/</span>_search <br><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match_all&quot;</span>: &#123;&#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;from&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">2</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>指定返回字段 POST/index/ _search? _source=title,content</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/index/</span>_search <br><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match_all&quot;</span>: &#123;&#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;_source&quot;</span>: [<br>    <span class="hljs-string">&quot;title&quot;</span>, <span class="hljs-string">&quot;content&quot;</span><br>  ]<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="5-6-DSL语法深入"><a href="#5-6-DSL语法深入" class="headerlink" title="5.6 DSL语法深入"></a>5.6 DSL语法深入</h2><h3 id="5-6-1-全部查询-match-all"><a href="#5-6-1-全部查询-match-all" class="headerlink" title="5.6.1 全部查询 match_all"></a>5.6.1 全部查询 match_all</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/index/</span>_search<br><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match_all&quot;</span>: &#123;&#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-6-2-查询-match"><a href="#5-6-2-查询-match" class="headerlink" title="5.6.2 查询 match"></a>5.6.2 查询 match</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/index/</span>_search<br><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;语言&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-6-3-多字段查询-multi-match"><a href="#5-6-3-多字段查询-multi-match" class="headerlink" title="5.6.3 多字段查询 multi_match"></a>5.6.3 多字段查询 multi_match</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/index/</span>_search<br><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;multi_match&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;语言 Java&quot;</span>,<br>      <span class="hljs-string">&quot;fields&quot;</span>: [<br>        <span class="hljs-string">&quot;title&quot;</span>, <span class="hljs-string">&quot;content&quot;</span><br>      ]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-6-4-范围查询-range-query"><a href="#5-6-4-范围查询-range-query" class="headerlink" title="5.6.4 范围查询 range query"></a>5.6.4 范围查询 range query</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/index/</span>_search<br><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;range&quot;</span>: &#123;<br>       <span class="hljs-string">&quot;red&quot;</span>: &#123;<br>         <span class="hljs-string">&quot;lt&quot;</span>: <span class="hljs-number">100</span>,<br>         <span class="hljs-string">&quot;gt&quot;</span>: <span class="hljs-number">50</span><br>       &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>gte：大于等于</li>
<li>gt：大于</li>
<li>lte：小于等于</li>
<li>lt：小于</li>
<li>boost：设置查询的推动值（boost），默认为1.0</li>
</ul>
</blockquote>
<h3 id="5-6-5-不分词查询-term-query"><a href="#5-6-5-不分词查询-term-query" class="headerlink" title="5.6.5 不分词查询 term query"></a>5.6.5 不分词查询 term query</h3><p>字段为keyword时，存储和搜索都不分词</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/index/</span>_search<br><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;term&quot;</span>: &#123;<br>       <span class="hljs-string">&quot;red&quot;</span>: <span class="hljs-number">101</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-6-6-多关键字查询-terms-query"><a href="#5-6-6-多关键字查询-terms-query" class="headerlink" title="5.6.6 多关键字查询 terms query"></a>5.6.6 多关键字查询 terms query</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/index/</span>_search<br><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>       <span class="hljs-string">&quot;red&quot;</span>: [<span class="hljs-number">101</span>, <span class="hljs-number">50</span>]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-6-7-查询包含某些字段的文档-exist-query"><a href="#5-6-7-查询包含某些字段的文档-exist-query" class="headerlink" title="5.6.7 查询包含某些字段的文档 exist query"></a>5.6.7 查询包含某些字段的文档 exist query</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">POST /_search<br><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;exists&quot;</span>: &#123;<br>       <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;name&quot;</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-6-8-模糊匹配-Fuzzy-query"><a href="#5-6-8-模糊匹配-Fuzzy-query" class="headerlink" title="5.6.8 模糊匹配 Fuzzy query"></a>5.6.8 模糊匹配 Fuzzy query</h3><p>返回包含与搜索词类似的词的文档，该词由Levenshtein编辑距离度量。</p>
<ul>
<li><p>value：查询的关键字</p>
</li>
<li><p>boost：查询的权值，默认值是1.0</p>
</li>
<li><p>min_similarity：设置匹配的最小相似度，默认值0.5，对于字符串，取值0-1(包括0和1)；对于数值，取值可能大于1；对于日期取值为1d,1m等，1d等于1天</p>
</li>
<li><p>prefix_length：指明区分词项的共同前缀长度，默认是0</p>
</li>
</ul>
<p>包括以下几种情况：</p>
<ul>
<li><p>更改角色（big→pig）</p>
</li>
<li><p>删除字符（good→god）</p>
</li>
<li><p>插入字符（god→good）</p>
</li>
<li><p>调换两个相邻字符（god→dog） </p>
</li>
</ul>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/index/</span>_search<br><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;fuzzy&quot;</span>: &#123;<br>       <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>         <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;Java&quot;</span>,<br>         <span class="hljs-string">&quot;boost&quot;</span>: <span class="hljs-number">0.5</span><br>       &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-6-9-id集合查询-ids"><a href="#5-6-9-id集合查询-ids" class="headerlink" title="5.6.9 id集合查询 ids"></a>5.6.9 id集合查询 ids</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/index/</span>_search<br><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;ids&quot;</span>: &#123;<br>       <span class="hljs-string">&quot;values&quot;</span>: [<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="5-6-10-前缀查询-prefix"><a href="#5-6-10-前缀查询-prefix" class="headerlink" title="5.6.10 前缀查询 prefix"></a>5.6.10 前缀查询 prefix</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/index/</span>_search<br><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;prefix&quot;</span>: &#123;<br>       <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;java&quot;</span><br>       &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-6-11-正则查询-regexp-query"><a href="#5-6-11-正则查询-regexp-query" class="headerlink" title="5.6.11 正则查询 regexp query"></a>5.6.11 正则查询 regexp query</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/index/</span>_search<br><br>&#123;<br>  <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;regexp&quot;</span>: &#123;<br>       <span class="hljs-string">&quot;title&quot;</span>: &#123;<br>          <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-string">&quot;j.*a.*&quot;</span><br>       &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-6-12-组合查询"><a href="#5-6-12-组合查询" class="headerlink" title="5.6.12 组合查询"></a>5.6.12 组合查询</h3><p>在es中，使用组合条件查询是其作为搜索引擎检索数据的一个强大之处，在前节篇中，简单演示了es的查询语法，但基本的增删改查功能并不能很好的满足复杂的查询场景，比如说我们期望像mysql那样做到拼接复杂的条件进行查询该如何做呢？es中有一种语法叫 <strong>bool</strong> ，通过在bool里面拼接es特定的语法可以做到大部分场景下复杂条件的拼接查询，也叫 <strong>复合查询</strong> </p>
<p>首先简单介绍es中常用的组合查询用到的关键词</p>
<ul>
<li>must:如果有多个条件，这些条件都必须满足，相当于and</li>
<li>should:如果有多个条件，满足一个或多个即可，相当于or</li>
<li>must_not:和must相反，必须都不满足条件才可以匹配到，相当于非</li>
</ul>
<p>搜索需求：title必须包含elasticsearch，content可以包含elasticsearch也可以不包含，author_id必须不为111</p>
<p>sql where  and or != </p>
<p>初始数据：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/website/</span>_doc/<span class="hljs-number">1</span><br>&#123;<br>      <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;my hadoop article&quot;</span>,<br>      <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;hadoop is very bad&quot;</span>,<br>      <span class="hljs-string">&quot;author_id&quot;</span>: <span class="hljs-number">111</span><br>&#125;<br><br>POST <span class="hljs-regexp">/website/</span>_doc/<span class="hljs-number">2</span><br>&#123;<br>      <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;my elasticsearch  article&quot;</span>,<br>      <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;es is very bad&quot;</span>,<br>      <span class="hljs-string">&quot;author_id&quot;</span>: <span class="hljs-number">112</span><br>&#125;<br>POST <span class="hljs-regexp">/website/</span>_doc/<span class="hljs-number">3</span><br>&#123;<br>      <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;my elasticsearch article&quot;</span>,<br>      <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;es is very goods&quot;</span>,<br>      <span class="hljs-string">&quot;author_id&quot;</span>: <span class="hljs-number">111</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>搜索：</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs prolog"><span class="hljs-symbol">GET</span> /website/<span class="hljs-symbol">_doc</span>/<span class="hljs-symbol">_search</span><br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;bool&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;must&quot;</span>: [<br>                &#123;<br>                    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;elasticsearch&quot;</span><br>                    &#125;<br>                &#125;<br>            ],<br>            <span class="hljs-string">&quot;should&quot;</span>: [<br>                &#123;<br>                    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;elasticsearch&quot;</span><br>                    &#125;<br>                &#125;<br>            ],<br>            <span class="hljs-string">&quot;must_not&quot;</span>: [<br>                &#123;<br>                    <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>                        <span class="hljs-string">&quot;author_id&quot;</span>: <span class="hljs-number">111</span><br>                    &#125;<br>                &#125;<br>            ]<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>返回：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.47000363</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;website&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.47000363</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my elasticsearch article&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;es is very bad&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;author_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">112</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="5-6-13-查询计划"><a href="#5-6-13-查询计划" class="headerlink" title="5.6.13 查询计划"></a>5.6.13 查询计划</h3><p>explain可以用来反映本次查询的一些信息，也可以用来定位查询错误</p>
<p>验证错误语句：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/article/</span>_validate/query?explain<br>&#123;<br><span class="hljs-string">&quot;query &quot;</span>: &#123;<br>  <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;java&quot;</span><br>   &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>返回：</p>
<figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs smalltalk">&#123;<br><br>    <span class="hljs-comment">&quot;valid&quot;</span>: <span class="hljs-keyword">false</span>,<br>    <span class="hljs-comment">&quot;error&quot;</span>: <span class="hljs-comment">&quot;org.elasticsearch.common.ParsingException: request does not support [query ]&quot;</span><br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>正确</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/book/</span>_validate/query?explain<br>&#123;<br><span class="hljs-string">&quot;query&quot;</span>: &#123;<br>  <span class="hljs-string">&quot;match&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;java&quot;</span><br>   &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>返回</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;valid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;explanations&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;valid&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;explanation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;content:java&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>一般用在那种特别复杂庞大的搜索下，比如你一下子写了上百行的搜索，这个时候可以先用validate api去验证一下，搜索是否合法。</p>
<p>合法以后，explain就像mysql的执行计划，可以看到搜索的目标等信息。</p>
<h2 id="5-7-滚动搜索"><a href="#5-7-滚动搜索" class="headerlink" title="5.7 滚动搜索"></a>5.7 滚动搜索</h2><p>现在有一个需求，把某个索引中1亿条数据下载下来存到数据库中。</p>
<p>如果一次查询出来，极有可能导致内存溢出，因此需要分批查询。除了我们上面说的分页查询以外，还可以使用滚动搜索技术 <code>scroll</code></p>
<p>scroll搜索会在第一次搜索时，保留一个当时的快照，之后只会基于这个快照提供数据，这个时间段如果发生了数据的变更，用户不会感知。</p>
<p>每次发送scroll请求，我们还需要指定一个scroll参数和一个时间窗口。每次请求只要在这个时间窗口内完成就可以了 。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /article/_search?scroll=1m<br>&#123;<br>  &quot;query&quot;: &#123;<br>    &quot;match_all&quot;: &#123;&#125;<br>  &#125;,<br>  &quot;size&quot;: 2<br>&#125;<br></code></pre></td></tr></table></figure>

<p>返回结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br><br>    <span class="hljs-attr">&quot;_scroll_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAHgWU29BMG1xamtUelNuOEVvSTdWYjdPUQ==&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;took&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;timed_out&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;successful&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;skipped&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;failed&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;total&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;relation&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;eq&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;max_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;hits&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Java从入门到精通&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;red&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">101</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Java是一门面向对象编程语言，不仅吸收了C++语言的各种优点，还摒弃了C++里难以理解的多继承、指针等概念，因此Java语言具有功能强大和简单易用两个特征。Java语言作为静态面向对象编程语言的代表，极好地实现了面向对象理论，允许程序员以优雅的思维方式进行复杂的编程&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">,</span><br>            <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;article&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;_doc&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2&quot;</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>                <span class="hljs-attr">&quot;_source&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                    <span class="hljs-attr">&quot;title&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;JavaEE从入门到入土&quot;</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;red&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span><br>                    <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Java EE 是 J2EE的一个新的名称，之所以改名，目的还是让大家清楚J2EE只是Java企业应用。在2004年底中国软件技术大会Ioc微容器（也就是Jdon框架的实现原理）演讲中指出：我们需要一个跨J2SE/WEB/EJB的微容器，保护我们的业务核心组件（中间件），以延续它的生命力，而不是依赖J2SE/J2EE版本&quot;</span><br>                <span class="hljs-punctuation">&#125;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>获得的结果会有一个scoll_id，下一次再发送scoll请求的时候，必须带上这个scoll_id</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">POST <span class="hljs-regexp">/_search/</span>scroll<br><br>&#123;<span class="hljs-string">&quot;scroll&quot;</span>:<span class="hljs-string">&quot;1m&quot;</span>,<span class="hljs-string">&quot;scroll_id&quot;</span>:<span class="hljs-string">&quot;DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAHkWU29BMG1xamtUelNuOEVvSTdWYjdPUQ==&quot;</span>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="6-分词器-analyzer"><a href="#6-分词器-analyzer" class="headerlink" title="6. 分词器 analyzer"></a>6. 分词器 analyzer</h1><h2 id="6-1-什么是分词器"><a href="#6-1-什么是分词器" class="headerlink" title="6.1 什么是分词器"></a>6.1 什么是分词器</h2><p>给你一段句子，然后将这段句子拆分成一个一个的单个的单词，同时对每个单词进行时态转换（单复数、同义词）</p>
<p>分词器的组成部分：</p>
<p>1、字符过滤：在一段文本进行分词之前，先进行预处理，比如过滤html标签</p>
<p>2、分词：hello world java –&gt; hello, world, java</p>
<p>3、字符处理：字母转小写，去掉语气词，同义词转换，dogs –&gt; dog，liked –&gt; like，Tom –&gt; tom，a/the/an –&gt; 干掉，mother –&gt; mom，small –&gt; little</p>
<p>选用特定的分词器很重要，一段文本只有经过合适的处理之后才能拿去建立倒排索引</p>
<h2 id="6-2-内置分词器"><a href="#6-2-内置分词器" class="headerlink" title="6.2 内置分词器"></a>6.2 内置分词器</h2><p>对这句话进行分词：Set the shape to semi-transparent by calling set_trans(5)</p>
<p>standard analyzer标准分词器（默认）：set, the, shape, to, semi, transparent, by, calling, set_trans, 5</p>
<p>simple analyzer简单分词器：set, the, shape, to, semi, transparent, by, calling, set, trans</p>
<p>whitespace analyzer空白分词器：Set, the, shape, to, semi-transparent, by, calling, set_trans(5)</p>
<p>language analyzer（特定的语言的分词器，比如说，english，英语分词器）：set, shape, semi, transpar, call, set_tran, 5</p>
<h2 id="6-3-测试分词器"><a href="#6-3-测试分词器" class="headerlink" title="6.3 测试分词器"></a>6.3 测试分词器</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /_analyze<br>&#123;<br>  &quot;analyzer&quot;: &quot;standard&quot;,<br>  &quot;text&quot;: &quot;Set the shape to semi-transparent by calling set_trans(5)&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>token 实际存储的term 关键字</p>
<p>position 在此词条在原文本中的位置</p>
<p>start_offset/end_offset字符在原始字符串中的位置</p>
</blockquote>
<h2 id="6-4-IK分词器"><a href="#6-4-IK分词器" class="headerlink" title="6.4 IK分词器"></a>6.4 IK分词器</h2><h3 id="6-4-1-背景"><a href="#6-4-1-背景" class="headerlink" title="6.4.1 背景"></a>6.4.1 背景</h3><p>用标准分词器对下面的文本进行分词</p>
<blockquote>
<p>北京市朝阳区人民群众</p>
</blockquote>
<p>分词结果发现，标准分词器相当的不标准。标准分词器只对英文进行标准分词，并不支持中文，因此需要选用三方的中文分词器</p>
<p>IK分词器是目前最流行的中文分词器，2012年12月之后停止了更新，elasticsearch-analyzer-ik依然在持续更新中</p>
<h3 id="6-4-2-安装"><a href="#6-4-2-安装" class="headerlink" title="6.4.2 安装"></a>6.4.2 安装</h3><p>下载地址：<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a></p>
<p>下载后解压到ES目录的 <code>plugins/ik中</code></p>
<h3 id="6-4-3-使用"><a href="#6-4-3-使用" class="headerlink" title="6.4.3 使用"></a>6.4.3 使用</h3><p>测试</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">POST _analyze<br>&#123;<br>  &quot;analyzer&quot;: &quot;ik_max_word&quot;,<br>  &quot;text&quot;: &quot;北京市朝阳区人民群众&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>开始使用</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index <br>&#123;<br> &quot;settings&quot;:&#123;<br>     //指定分词器  <br>    &quot;analysis&quot;:&#123;   <br>      &quot;analyzer&quot;:&#123;<br>    &quot;ik&quot;:&#123;<br>      &quot;tokenizer&quot;:&quot;ik_max_word&quot;<br>    &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>ik_max_word: 会将文本做最细粒度的拆分。</p>
<p>ik_smart: 会做最粗粒度的拆分。</p>
</blockquote>
<p>一般存储时用细粒度存储，查询时没有特殊要求的话用粗粒度查询</p>
<p>测试</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index/_search?q=北京市朝阳区人民群众<br></code></pre></td></tr></table></figure>



<h3 id="6-4-4-配置文件"><a href="#6-4-4-配置文件" class="headerlink" title="6.4.4 配置文件"></a>6.4.4 配置文件</h3><p>ik配置文件地址：plugins/ik/config目录</p>
<ul>
<li><p>IKAnalyzer.cfg.xml：用来配置自定义词库</p>
</li>
<li><p>main.dic：ik原生内置的中文词库，总共有 <strong>27万多条</strong> ，只要是这些单词，都会被分在一起</p>
</li>
<li><p>preposition.dic: 介词</p>
</li>
<li><p>quantifier.dic：放了一些单位相关的词，量词</p>
</li>
<li><p>suffix.dic：放了一些后缀</p>
</li>
<li><p>surname.dic：中国的姓氏</p>
</li>
<li><p>stopword.dic：英文停用词</p>
</li>
</ul>
<p>最重要的就是下面两个配置，我们一般也只关注这两个</p>
<ol>
<li><p>main.dic：包含了原生的中文词语，会按照这个里面的词语去分词</p>
</li>
<li><p>stopword.dic：包含了英文的停用词</p>
</li>
</ol>
<p>停用词在分词的时候会被直接干掉。</p>
<h3 id="6-4-5-自定义词库"><a href="#6-4-5-自定义词库" class="headerlink" title="6.4.5 自定义词库"></a>6.4.5 自定义词库</h3><p>每年都会出现一些流行词，比如 鬼畜、空耳、老铁、666、233等，一般不会出现在ik内置的词库中，需要自己进行扩展。</p>
<p>自己补充自己的最新的词语，到ik的词库里面</p>
<p>IKAnalyzer.cfg.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">properties</span> <span class="hljs-keyword">SYSTEM</span> <span class="hljs-string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="hljs-tag">&lt;/<span class="hljs-name">comment</span>&gt;</span><br>	<span class="hljs-comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;ext_dict&quot;</span>&gt;</span>custom/mydict.dic;custom/single_word_low_freq.dic<span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br>	 <span class="hljs-comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;ext_stopwords&quot;</span>&gt;</span>custom/ext_stopword.dic<span class="hljs-tag">&lt;/<span class="hljs-name">entry</span>&gt;</span><br>	<span class="hljs-comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span><br>	<span class="hljs-comment">&lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; --&gt;</span><br>	<span class="hljs-comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span><br>	<span class="hljs-comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在custom目录下创建mydict.dic文件，输入自定义的词语</p>
<p>补充自己的词语，然后需要重启es，才能生效</p>
<p>自己建立停用词库：比如了，的，啥，么，我们可能并不想去建立索引，让人家搜索</p>
<p>custom/ext_stopword.dic，已经有了常用的中文停用词，可以补充自己的停用词，然后重启es</p>
<h1 id="7-聚合操作"><a href="#7-聚合操作" class="headerlink" title="7. 聚合操作"></a>7. 聚合操作</h1><p>所谓聚合，就是在查询完某些数据之后，进行group by等操作，并进行一系列的统计。</p>
<p>基本语法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /index/_search<br>&#123;<br>  &quot;size&quot;: 0, # 不查询任何数据，因为聚合操作主要是为了统计，查询数据并没有意义<br>  &quot;query&quot;: &#123;<br>    &quot;match_all&quot;: &#123;&#125; # 查询所有<br>  &#125;, <br>  &quot;aggs&quot;: &#123;<br>    &quot;group_by_model&quot;: &#123; # 相当于给count(*)起一个别名<br>      &quot;terms&quot;: &#123; &quot;field&quot;: &quot;根据哪个字段聚合&quot; &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="7-1统计每个type下的帖子数量"><a href="#7-1统计每个type下的帖子数量" class="headerlink" title="7.1统计每个type下的帖子数量"></a>7.1统计每个type下的帖子数量</h2><p>sql语句： select type，count(*)  from artuicle group by type</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/index/</span>_search<br>&#123;<br>    <span class="hljs-string">&quot;query&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;match_all&quot;</span>: &#123;&#125;<br>    &#125;,<br>    <span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-string">&quot;aggs&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;types_count&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;terms&quot;</span>: &#123;<br>                <span class="hljs-string">&quot;field&quot;</span>: <span class="hljs-string">&quot;types&quot;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="7-2-统计阅读量大于100的帖子数量"><a href="#7-2-统计阅读量大于100的帖子数量" class="headerlink" title="7.2 统计阅读量大于100的帖子数量"></a>7.2 统计阅读量大于100的帖子数量</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;range&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;red&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br><span class="hljs-attr">&quot;gt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><br><span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;aggs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;types_count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;types&quot;</span><br>            <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<p>除了统计数量以外，es还支持最大值、最小值、平均值、总和等操作，分别对应着 <strong>max、min、avg、sum</strong> ，只需要把上面的terms换成这些即可</p>
<h2 id="7-3-bucket和metric"><a href="#7-3-bucket和metric" class="headerlink" title="7.3 bucket和metric"></a>7.3 bucket和metric</h2><p>bucket：数据的分组</p>
<table>
<thead>
<tr>
<th>班级</th>
<th>姓名</th>
</tr>
</thead>
<tbody><tr>
<td>一年级</td>
<td>张三</td>
</tr>
<tr>
<td>一年级</td>
<td>李四</td>
</tr>
<tr>
<td>二年级</td>
<td>王五</td>
</tr>
<tr>
<td>二年级</td>
<td>赵六</td>
</tr>
<tr>
<td>二年级</td>
<td>田七</td>
</tr>
</tbody></table>
<p>划分出来两个bucket，一个一年级，一个是二年级<br>一年级bucket：包含了2个人，张三，李四<br>二年级bucket：包含了3个人，王五，赵六，田七</p>
<p>metric：对数据分组执行的统计，比如说最大值、最小值、总数、平均值</p>
<h1 id="8-ES7-SQL操作"><a href="#8-ES7-SQL操作" class="headerlink" title="8. ES7 SQL操作"></a>8. ES7 SQL操作</h1><p>是的你没听错，ES7之后支持SQL操作了，至少需要JDK11版本 </p>
<h2 id="8-1-语法"><a href="#8-1-语法" class="headerlink" title="8.1 语法"></a>8.1 语法</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /_sql?format=txt<br>&#123;<br>	&quot;query&quot;: &quot;select * from article&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里的 <code>format=txt</code> 是指显示的方式，除了txt之外，还支持以下方式</p>
<p>csv、json、tsv、txt、yaml、cbor、smile</p>
<h2 id="8-2-与DSL结合"><a href="#8-2-与DSL结合" class="headerlink" title="8.2 与DSL结合"></a>8.2 与DSL结合</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs http">POST /_sql?format=txt<br>&#123;<br>	&quot;query&quot;: &quot;select * from article&quot;,<br>	&quot;filter&quot;: &#123;<br>		&quot;range&quot;:  &#123;<br>			&quot;red&quot;: &#123;<br>				&quot;lt&quot;: 100<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可惜的是，开源版本的ES并不支持通过Java或者其他语言操作SQL，如果需要操作SQL，则需要购买白金版（直白点说就是要氪金）</p>
<h1 id="9-Mapping映射"><a href="#9-Mapping映射" class="headerlink" title="9. Mapping映射"></a>9. Mapping映射</h1><h2 id="9-1-什么是Mapping映射"><a href="#9-1-什么是Mapping映射" class="headerlink" title="9.1 什么是Mapping映射"></a>9.1 什么是Mapping映射</h2><p>概念：自动或手动为index中的_doc建立的一种数据结构和相关配置，简称为mapping映射。</p>
<p>说白了，就是给我们索引中的某些字段指定一下数据类型</p>
<p>插入几条数据，让es自动为我们建立一个索引</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk">PUT <span class="hljs-regexp">/website/</span>_doc/<span class="hljs-number">1</span><br>&#123;<br>  <span class="hljs-string">&quot;post_date&quot;</span>: <span class="hljs-string">&quot;2019-01-01&quot;</span>,<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;my first article&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;this is my first article in this website&quot;</span>,<br>  <span class="hljs-string">&quot;author_id&quot;</span>: <span class="hljs-number">11400</span><br>&#125;<br><br>PUT <span class="hljs-regexp">/website/</span>_doc/<span class="hljs-number">2</span><br>&#123;<br>  <span class="hljs-string">&quot;post_date&quot;</span>: <span class="hljs-string">&quot;2019-01-02&quot;</span>,<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;my second article&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;this is my second article in this website&quot;</span>,<br>  <span class="hljs-string">&quot;author_id&quot;</span>: <span class="hljs-number">11400</span><br>&#125;<br> <br>PUT <span class="hljs-regexp">/website/</span>_doc/<span class="hljs-number">3</span><br>&#123;<br>  <span class="hljs-string">&quot;post_date&quot;</span>: <span class="hljs-string">&quot;2019-01-03&quot;</span>,<br>  <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;my third article&quot;</span>,<br>  <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;this is my third article in this website&quot;</span>,<br>  <span class="hljs-string">&quot;author_id&quot;</span>: <span class="hljs-number">11400</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>对比数据库建表语句</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs scss">create <span class="hljs-selector-tag">table</span> <span class="hljs-built_in">website</span>(<br>     post_date date,<br>     title varchar(<span class="hljs-number">50</span>),     <br>     <span class="hljs-attribute">content</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">100</span>),<br>     author_id <span class="hljs-built_in">int</span>(<span class="hljs-number">11</span>) <br> );<br></code></pre></td></tr></table></figure>

<p>动态映射：dynamic mapping，自动为我们建立index，以及对应的mapping，mapping中包含了每个field对应的数据类型，以及如何分词等设置。</p>
<p>尝试各种搜索</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">GET</span> /website/_search?<span class="hljs-attribute">q</span>=2019        0条结果             <br><span class="hljs-built_in">GET</span> /website/_search?<span class="hljs-attribute">q</span>=2019-01-01           1条结果<br><span class="hljs-built_in">GET</span> /website/_search?<span class="hljs-attribute">q</span>=post_date:2019-01-01     1条结果<br><span class="hljs-built_in">GET</span> /website/_search?<span class="hljs-attribute">q</span>=post_date:2019          0 条结果<br></code></pre></td></tr></table></figure>

<p>搜索结果为什么不一致，因为es自动建立mapping的时候，设置了不同的field不同的data type。不同的data type的分词、搜索等行为是不一样的。所以出现了_all field和post_date field的搜索表现完全不一样。</p>
<h2 id="9-2-精确搜索与全文搜索对比"><a href="#9-2-精确搜索与全文搜索对比" class="headerlink" title="9.2 精确搜索与全文搜索对比"></a>9.2 精确搜索与全文搜索对比</h2><h3 id="9-2-1-exact-value精确匹配"><a href="#9-2-1-exact-value精确匹配" class="headerlink" title="9.2.1 exact value精确匹配"></a>9.2.1 exact value精确匹配</h3><p>2019-01-01，exact value，搜索的时候，必须输入2019-01-01，才能搜索出来</p>
<p>如果你输入一个01，是搜索不出来的</p>
<p>类似于下面的sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> book <span class="hljs-keyword">where</span> name<span class="hljs-operator">=</span> <span class="hljs-string">&#x27;java&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="9-2-2-full-text-全文检索"><a href="#9-2-2-full-text-全文检索" class="headerlink" title="9.2.2 full text 全文检索"></a>9.2.2 full text 全文检索</h3><p>（1）缩写 vs. 全称：cn vs. china</p>
<p>（2）格式转化：like liked likes</p>
<p>（3）大小写：Tom vs tom</p>
<p>（4）同义词：like vs love</p>
<p>2019-01-01，2019 01 01，搜索2019，或者01，都可以搜索出来</p>
<p>china，搜索cn，也可以将china搜索出来</p>
<p>likes，搜索like，也可以将likes搜索出来</p>
<p>Tom，搜索tom，也可以将Tom搜索出来</p>
<p>like，搜索love，同义词，也可以将like搜索出来</p>
<p>就不是说单纯的只是匹配完整的一个值，而是可以对值进行拆分词语后（分词）进行匹配，也可以通过缩写、时态、大小写、同义词等进行匹配。深入 NPL,自然语义处理。</p>
<h2 id="9-3-全文检索下倒排索引是如何建立的"><a href="#9-3-全文检索下倒排索引是如何建立的" class="headerlink" title="9.3 全文检索下倒排索引是如何建立的"></a>9.3 全文检索下倒排索引是如何建立的</h2><p>doc1：I really liked my small dogs, and I think my mom also liked them.</p>
<p>doc2：He never liked any dogs, so I hope that my mom will not expect me to liked him.</p>
<h4 id="分词，初步的倒排索引的建立"><a href="#分词，初步的倒排索引的建立" class="headerlink" title="分词，初步的倒排索引的建立"></a>分词，初步的倒排索引的建立</h4><table>
<thead>
<tr>
<th>term</th>
<th><strong>doc1</strong></th>
<th><strong>doc2</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>I</strong></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td><strong>really</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>liked</strong></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td><strong>my</strong></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td><strong>small</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>dogs</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>and</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>think</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>mom</strong></td>
<td>*</td>
<td>*</td>
</tr>
<tr>
<td><strong>also</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>them</strong></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>He</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>never</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>any</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>so</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>hope</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>that</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>will</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>not</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>expect</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>me</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>to</strong></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td><strong>him</strong></td>
<td></td>
<td>*</td>
</tr>
</tbody></table>
<p>演示了一下倒排索引最简单的建立的一个过程</p>
<h4 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h4><p>mother like little dog，不可能有任何结果</p>
<p>mother</p>
<p>like</p>
<p>little</p>
<p>dog</p>
<p>这不是我们想要的结果。同义词mom\mother在我们人类看来是一样。想进行标准化操作。</p>
<h4 id="重建倒排索引"><a href="#重建倒排索引" class="headerlink" title="重建倒排索引"></a>重建倒排索引</h4><p>normalization正规化，建立倒排索引的时候，会执行一个操作，也就是说对拆分出的各个单词进行相应的处理，以提升后面搜索的时候能够搜索到相关联的文档的概率</p>
<p>时态的转换，单复数的转换，同义词的转换，大小写的转换</p>
<p>mom ―&gt; mother</p>
<p>liked ―&gt; like</p>
<p>small ―&gt; little</p>
<p>dogs ―&gt; dog</p>
<p>重新建立倒排索引，加入normalization，再次用mother liked little dog搜索，就可以搜索到了</p>
<table>
<thead>
<tr>
<th><strong>word</strong></th>
<th><strong>doc1</strong></th>
<th><strong>doc2</strong></th>
<th><strong>normalization</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>I</strong></td>
<td>*</td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>really</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>like</strong></td>
<td>*</td>
<td>*</td>
<td>liked ―&gt; like</td>
</tr>
<tr>
<td><strong>my</strong></td>
<td>*</td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>little</strong></td>
<td>*</td>
<td></td>
<td>small ―&gt; little</td>
</tr>
<tr>
<td><strong>dog</strong></td>
<td>*</td>
<td></td>
<td>dogs ―&gt; dog</td>
</tr>
<tr>
<td><strong>and</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>think</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>mother</strong></td>
<td>*</td>
<td>*</td>
<td>mom ―&gt; mother</td>
</tr>
<tr>
<td><strong>also</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>them</strong></td>
<td>*</td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>He</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>never</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>any</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>so</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>hope</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>that</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>will</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>not</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>expect</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>me</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>to</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
<tr>
<td><strong>him</strong></td>
<td></td>
<td>*</td>
<td></td>
</tr>
</tbody></table>
<h4 id="重新搜索"><a href="#重新搜索" class="headerlink" title="重新搜索"></a>重新搜索</h4><p>搜索：mother liked  little dog，</p>
<p> 对搜索条件经行分词 normalization</p>
<p>mother </p>
<p>liked  -》like</p>
<p> little </p>
<p>dog</p>
<p>doc1和doc2都会搜索出来</p>
<h2 id="9-4-Mapping核心数据类型"><a href="#9-4-Mapping核心数据类型" class="headerlink" title="9.4 Mapping核心数据类型"></a>9.4 Mapping核心数据类型</h2><h3 id="9-4-1-数据类型"><a href="#9-4-1-数据类型" class="headerlink" title="9.4.1 数据类型"></a>9.4.1 数据类型</h3><p>string :text and keyword</p>
<p>byte，short，integer，long,float，double</p>
<p>boolean</p>
<p>date</p>
<p>详见：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/7.3/mapping-types.html">https://www.elastic.co/guide/en/elasticsearch/reference/7.3/mapping-types.html</a></p>
<h3 id="9-4-2-dynamic-mapping推测规则"><a href="#9-4-2-dynamic-mapping推测规则" class="headerlink" title="9.4.2 dynamic mapping推测规则"></a>9.4.2 dynamic mapping推测规则</h3><p>当我们不手动配置映射时，索引会为我们自动配置映射。自动映射会依据字段的值去推测这个字段的数据类型</p>
<ul>
<li><p>true or false   –&gt; boolean</p>
</li>
<li><p>123     –&gt; long</p>
</li>
<li><p>123.45      –&gt; double</p>
</li>
<li><p>2019-01-01  –&gt; date</p>
</li>
<li><p>“hello world”   –&gt; text/keywod</p>
</li>
</ul>
<h2 id="9-5-手动管理Mapping"><a href="#9-5-手动管理Mapping" class="headerlink" title="9.5 手动管理Mapping"></a>9.5 手动管理Mapping</h2><h3 id="9-5-1-查看Mapping"><a href="#9-5-1-查看Mapping" class="headerlink" title="9.5.1 查看Mapping"></a>9.5.1 查看Mapping</h3><p><strong>查查看mapping</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /index/_mapping/<br></code></pre></td></tr></table></figure>

<p><strong>查看所有索引的映射</strong></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /_mapping<br></code></pre></td></tr></table></figure>

<h3 id="9-5-2-创建映射"><a href="#9-5-2-创建映射" class="headerlink" title="9.5.2 创建映射"></a>9.5.2 创建映射</h3><p>就像我们编写java代码一样，创建了类之后就需要提供属性。我们创建索引后，也应该立即手动创建映射</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT book/_mapping<br>&#123;<br>&quot;properties&quot;: &#123;<br>&quot;title&quot;: &#123;<br>  &quot;type&quot;: &quot;text&quot;,<br>  &quot;analyzer&quot;: &quot;ik_max_word&quot;,<br>  &quot;search_analyzer&quot;: &quot;ik_smart&quot;<br>&#125;,<br>&quot;content&quot;: &#123;<br>  &quot;type&quot;: &quot;text&quot;,<br>  &quot;analyzer&quot;: &quot;ik_max_word&quot;,<br>  &quot;search_analyzer&quot;: &quot;ik_smart&quot;<br>&#125;,<br>&quot;types&quot;: &#123;<br>  &quot;type&quot;: &quot;keyword&quot;<br>&#125;,<br>&quot;read&quot;: &#123;<br>  &quot;type&quot;: &quot;integer&quot;<br>&#125;<br><br><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Text文本类型"><a href="#Text文本类型" class="headerlink" title="Text文本类型"></a>Text文本类型</h4><ul>
<li><p>analyzer</p>
<p>通过analyzer属性指定分词器。</p>
<p>上边指定了analyzer是指在索引和搜索都使用english，如果单独想定义搜索时使用的分词器则可以通过search_analyzer属性。</p>
</li>
<li><p>index</p>
<p>index属性指定是否索引。</p>
<p>默认为index=true，即要进行索引，只有进行索引才可以从索引库搜索到。</p>
<p>但是也有一些内容不需要索引，比如：商品图片地址只被用来展示图片，不进行搜索图片，此时可以将index设置为false。</p>
<p>删除索引，重新创建映射，将pic的index设置为false，尝试根据pic去搜索，结果搜索不到数据。</p>
</li>
</ul>
<p>插入文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /book/_doc/1<br>&#123;<br>  &quot;name&quot;:&quot;Bootstrap开发框架&quot;,<br>  &quot;description&quot;:&quot;Bootstrap是由Twitter推出的一个前台页面开发框架，在行业之中使用较为广泛。此开发框架包含了大量的CSS、JS程序代码，可以帮助开发者（尤其是不擅长页面开发的程序人员）轻松的实现一个不受浏览器限制的精美界面效果。&quot;,<br>  &quot;pic&quot;:&quot;group1/M00/00/01/wKhlQFqO4MmAOP53AAAcwDwm6SU490.jpg&quot;,<br>  &quot;studymodel&quot;:&quot;201002&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Get /book/_search?q=name:开发</p>
<p>Get  /book/_search?q=description:开发</p>
<p>Get /book/_search?q=pic:group1/M00/00/01/wKhlQFqO4MmAOP53AAAcwDwm6SU490.jpg</p>
<p>Get /book/_search?q=studymodel:201002</p>
<p>通过测试发现：name和description都支持全文检索，pic不可作为查询条件。</p>
<h4 id="keyword关键字"><a href="#keyword关键字" class="headerlink" title="keyword关键字"></a>keyword关键字</h4><p>目前已经取代了”index”: false。上边介绍的text文本字段在映射时要设置分词器，keyword字段为关键字字段，通常搜索keyword是按照整体搜索，所以创建keyword字段的索引时是不进行分词的，比如：邮政编码、手机号码、身份证等。keyword字段通常用于过虑、排序、聚合等。</p>
<h4 id="date日期类型"><a href="#date日期类型" class="headerlink" title="date日期类型"></a>date日期类型</h4><p>日期类型不用设置分词器。</p>
<p>通常日期类型的字段用于排序。</p>
<p>format</p>
<p>通过format设置日期格式</p>
<p>例子：</p>
<p>下边的设置允许date字段存储年月日时分秒、年月日及毫秒三种格式。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;timestamp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span>   <span class="hljs-string">&quot;date&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;format&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss||yyyy-MM-dd&quot;</span><br>        <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>



<p>插入文档：</p>
<p>Post book/doc/3 </p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http">&#123;<br> &quot;name&quot;: &quot;spring开发基础&quot;,<br> &quot;description&quot;: &quot;spring 在java领域非常流行，java程序员都在用。&quot;,<br> &quot;studymodel&quot;: &quot;201001&quot;,<br> &quot;pic&quot;:&quot;group1/M00/00/01/wKhlQFqO4MmAOP53AAAcwDwm6SU490.jpg&quot;,<br> &quot;timestamp&quot;:&quot;2018-07-04 18:28:58&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="数值类型"><a href="#数值类型" class="headerlink" title="数值类型"></a>数值类型</h4><p>ES支持以下几种数值类型</p>
<p>long、integer、short、byte、double、float、half_float、scaled_float</p>
<h3 id="9-5-3-修改和删除映射"><a href="#9-5-3-修改和删除映射" class="headerlink" title="9.5.3 修改和删除映射"></a>9.5.3 修改和删除映射</h3><p>只能创建index时手动建立mapping，或者新增field mapping，但是不能update field mapping。</p>
<p>因为已有数据按照映射早已分词存储好。如果修改，那这些存量数据就会出问题。</p>
<p>同样，映射也不能删除，如果想删除映射，只能通过删除索引的方式进行。</p>
<h1 id="10-Index索引入门"><a href="#10-Index索引入门" class="headerlink" title="10. Index索引入门"></a>10. Index索引入门</h1><p>虽然直接put数据，ES就会为我们创建索引并且动态建立映射，但是为了方便维护，我们需要手动建立索引和映射，就像数据库的建表语句一样，即使Hibernate和jpa已经给我们提供了自动建表功能，我们实际开发中依然是手动建表。</p>
<h2 id="10-1-创建索引"><a href="#10-1-创建索引" class="headerlink" title="10.1 创建索引"></a>10.1 创建索引</h2><p>语法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /index<br>&#123;<br>    &quot;settings&quot;: &#123; ... any settings ... &#125;,<br>    &quot;mappings&quot;: &#123;<br>       &quot;properties&quot; : &#123;<br>            &quot;field1&quot; : &#123; &quot;type&quot; : &quot;text&quot; &#125;<br>        &#125;<br>    &#125;,<br>    &quot;aliases&quot;: &#123;<br>    	&quot;default_index&quot;: &#123;&#125;<br>  &#125; <br>&#125;<br></code></pre></td></tr></table></figure>

<p>如下</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index<br>&#123;<br>    &quot;settings&quot;: &#123;<br>        &quot;number_of_shards&quot;: 1,<br>        &quot;number_of_replicas&quot;: 1<br>    &#125;,<br>    &quot;mappings&quot;: &#123;<br>        &quot;properties&quot;: &#123;<br>            &quot;content&quot;: &#123;<br>                &quot;type&quot;: &quot;text&quot;,<br>                &quot;analyzer&quot;: &quot;ik_max_word&quot;,<br>                &quot;search_analyzer&quot;: &quot;ik_smart&quot;<br>            &#125;<br>        &#125;<br>    &#125;,<br>    &quot;aliases&quot;: &#123;<br>        &quot;hhhh&quot;: &#123;&#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>aliases是别名，我们可以使用索引名称查询，也可以使用别名</p>
<h2 id="10-2-查询索引"><a href="#10-2-查询索引" class="headerlink" title="10.2 查询索引"></a>10.2 查询索引</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">GET /my_index<br><br>GET /my_index/_mapping<br><br>GET /my_index/_setting<br></code></pre></td></tr></table></figure>

<h2 id="10-3-修改索引"><a href="#10-3-修改索引" class="headerlink" title="10.3 修改索引"></a>10.3 修改索引</h2><p>修改settings</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /my_index/_settings<br>&#123;<br>    &quot;index&quot; : &#123;<br>        &quot;number_of_replicas&quot; : 2<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="10-4-删除索引"><a href="#10-4-删除索引" class="headerlink" title="10.4 删除索引"></a>10.4 删除索引</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http">DELETE /my_index<br><br>DELETE /index_one,index_two<br><br>DELETE /index_*<br><br>DELETE /_all<br></code></pre></td></tr></table></figure>

<p>为了安全起见，防止恶意删除索引，删除时必须指定索引名：</p>
<p>elasticsearch.yml</p>
<p>action.destructive_requires_name: true</p>
<h2 id="10-5-type"><a href="#10-5-type" class="headerlink" title="10.5 type"></a>10.5 type</h2><h3 id="10-5-1-type是什么"><a href="#10-5-1-type是什么" class="headerlink" title="10.5.1 type是什么"></a>10.5.1 type是什么</h3><p>type，是一个index中用来区分类似的数据的，类似的数据，但是可能有不同的fields，而且有不同的属性来控制索引建立、分词器.</p>
<p>lucene是没有type的概念的，在document中，实际上将type作为一个document的field来存储，即_type，es通过_type来进行type的过滤和筛选。</p>
<h3 id="10-5-2-type存储机制"><a href="#10-5-2-type存储机制" class="headerlink" title="10.5.2 type存储机制"></a>10.5.2 type存储机制</h3><p>一个index中的多个type，实际上是放在一起存储的，因此一个index下，不能有多个type重名，而类型或者其他设置不同的，因为那样是无法处理的</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>   <span class="hljs-attr">&quot;goods&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>         <span class="hljs-attr">&quot;electronic_goods&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>               <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;double&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;service_period&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><br>                   <span class="hljs-punctuation">&#125;</span>			<br>                <span class="hljs-punctuation">&#125;</span><br>         <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>         <span class="hljs-attr">&quot;fresh_goods&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>               <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>                  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;double&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>               <span class="hljs-attr">&quot;eat_period&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              		<span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span><br>               <span class="hljs-punctuation">&#125;</span><br>                <span class="hljs-punctuation">&#125;</span><br>         <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>   <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /goods/electronic_goods/1<br>&#123;<br>  &quot;name&quot;: &quot;小米空调&quot;,<br>  &quot;price&quot;: 1999.0,<br>  &quot;service_period&quot;: &quot;one year&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">PUT /goods/fresh_goods/1<br>&#123;<br>  &quot;name&quot;: &quot;澳洲龙虾&quot;,<br>  &quot;price&quot;: 199.0,<br>  &quot;eat_period&quot;: &quot;one week&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ES底层实际的存储形式其实是这样的</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">&#123;<br>   &quot;goods&quot;: &#123;<br>      &quot;mappings&quot;: &#123;<br>        &quot;_type&quot;: &#123;<br>          &quot;type&quot;: &quot;string&quot;,<br>          &quot;<span class="hljs-keyword">index</span><span class="hljs-string">&quot;: &quot;</span><span class="hljs-literal">false</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>name<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-built_in">type</span><span class="hljs-string">&quot;: &quot;</span><span class="hljs-keyword">string</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">        &quot;</span>price<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-built_in">type</span><span class="hljs-string">&quot;: &quot;</span>double<span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">        &quot;</span>service_period<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-built_in">type</span><span class="hljs-string">&quot;: &quot;</span><span class="hljs-keyword">string</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;,</span><br><span class="hljs-string">        &quot;</span>eat_period<span class="hljs-string">&quot;: &#123;</span><br><span class="hljs-string">          &quot;</span><span class="hljs-built_in">type</span><span class="hljs-string">&quot;: &quot;</span><span class="hljs-keyword">string</span><span class="hljs-string">&quot;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">   &#125;</span><br><span class="hljs-string">&#125;</span><br></code></pre></td></tr></table></figure>

<p>底层数据的存储形式</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;electronic_goods&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;小米空调&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1999.0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;service_period&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;one year&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;eat_period&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;_type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;fresh_goods&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;澳洲龙虾&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">199.0</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;service_period&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;eat_period&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;one week&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="10-5-3-type弃用的原因"><a href="#10-5-3-type弃用的原因" class="headerlink" title="10.5.3 type弃用的原因"></a>10.5.3 type弃用的原因</h3><p>统一索引下，不同type的数据也需要存储其他type的field，这样就会出现大量的空值，造成资源的浪费，因此不同的数据要放到不同的索引中。</p>
<p>ES9中将会彻底删除type</p>
<h1 id="11-Java操作ES"><a href="#11-Java操作ES" class="headerlink" title="11. Java操作ES"></a>11. Java操作ES</h1><p>操作ES可以采用 <code>SpringDataElasticSearch</code></p>
<h2 id="11-1-配置文件"><a href="#11-1-配置文件" class="headerlink" title="11.1 配置文件"></a>11.1 配置文件</h2><p><code>pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><code>application.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">elasticsearch:</span><br>    <span class="hljs-attr">rest:</span><br>      <span class="hljs-attr">uris:</span> <span class="hljs-string">http://39.102.41.53:9200</span><br><br></code></pre></td></tr></table></figure>

<h2 id="11-2-编写代码"><a href="#11-2-编写代码" class="headerlink" title="11.2 编写代码"></a>11.2 编写代码</h2><p>实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span>: 杨德石</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span>: 2020/9/14 21:57</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Document(indexName = &quot;article&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Article</span> &#123;<br><br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> String id;<br><br>    <span class="hljs-meta">@Field(store = true, type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;)</span><br>    <span class="hljs-keyword">private</span> String title;<br><br>    <span class="hljs-meta">@Field(store = true, type = FieldType.Text, analyzer = &quot;ik_max_word&quot;, searchAnalyzer = &quot;ik_smart&quot;)</span><br>    <span class="hljs-keyword">private</span> String content;<br><br>    <span class="hljs-meta">@Field(store = true, type = FieldType.Integer)</span><br>    <span class="hljs-keyword">private</span> Integer read;<br><br>    <span class="hljs-meta">@Field(store = true, type = FieldType.Keyword)</span><br>    <span class="hljs-keyword">private</span> String types;<br><br>    <span class="hljs-meta">@Field(store = true, type = FieldType.Keyword)</span><br>    <span class="hljs-keyword">private</span> String author;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(String id)</span> &#123;<br>        <span class="hljs-built_in">this</span>.id = id;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTitle</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> title;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTitle</span><span class="hljs-params">(String title)</span> &#123;<br>        <span class="hljs-built_in">this</span>.title = title;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> content;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContent</span><span class="hljs-params">(String content)</span> &#123;<br>        <span class="hljs-built_in">this</span>.content = content;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getRead</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> read;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRead</span><span class="hljs-params">(Integer read)</span> &#123;<br>        <span class="hljs-built_in">this</span>.read = read;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTypes</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> types;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTypes</span><span class="hljs-params">(String types)</span> &#123;<br>        <span class="hljs-built_in">this</span>.types = types;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getAuthor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> author;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAuthor</span><span class="hljs-params">(String author)</span> &#123;<br>        <span class="hljs-built_in">this</span>.author = author;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>Spring Data通过注解来声明字段的映射属性，有下面的三个注解：</p>
<ul>
<li><p><code>@Document</code></p>
<p> 作用在类，标记实体类为文档对象，一般有四个属性</p>
<ul>
<li>indexName：对应索引库名称</li>
<li>type：对应在索引库中的类型</li>
<li>shards：分片数量，默认5</li>
<li>replicas：副本数量，默认1</li>
</ul>
</li>
<li><p><code>@Id</code> 作用在成员变量，标记一个字段作为id主键</p>
</li>
<li><p><code>field</code></p>
<p> 作用在成员变量，标记为文档的字段，并指定字段映射属性：</p>
<ul>
<li>type：字段类型，取值是枚举：FieldType</li>
<li>index：是否索引，布尔类型，默认是true</li>
<li>store：是否存储，布尔类型，默认是false</li>
<li>analyzer：分词器名称：ik_max_word</li>
<li>searchAnalyzer：搜索时的分词器名称</li>
</ul>
</li>
</ul>
</blockquote>
<p>dao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Author</span>: 杨德石</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Date</span>: 2020/9/14 22:02</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Version</span> 1.0</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ArticleDao</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElasticsearchRepository</span>&lt;Article, String&gt; &#123;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArticleService</span> &#123;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ArticleDao articleDao;<br>    <br>&#125;<br><br></code></pre></td></tr></table></figure>



<h2 id="11-4-增删改查"><a href="#11-4-增删改查" class="headerlink" title="11.4 增删改查"></a>11.4 增删改查</h2><h3 id="11-4-1-添加和修改"><a href="#11-4-1-添加和修改" class="headerlink" title="11.4.1 添加和修改"></a>11.4.1 添加和修改</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 添加</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> article</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(Article article)</span> &#123;<br>    article.setId(UUID.randomUUID().toString());<br>    articleDao.save(article);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 修改。当数据存在时是更新，当数据不存在时，是修改</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> article</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Article article)</span> &#123;<br>    <span class="hljs-keyword">if</span>(StringUtils.isEmpty(article.getId())) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;ID不能为空&quot;</span>);<br>    &#125;<br>    articleDao.save(article);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Article</span> <span class="hljs-variable">article</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>();<br>    article.setAuthor(<span class="hljs-string">&quot;吴彦祖&quot;</span>);<br>    article.setTitle(<span class="hljs-string">&quot;PHP是世界上最好的语言&quot;</span>);<br>    article.setContent(<span class="hljs-string">&quot;学习不可三天打鱼两天晒网，打铁还需自身硬&quot;</span>);<br>    article.setRead(<span class="hljs-number">0</span>);<br>    article.setTypes(<span class="hljs-string">&quot;Java&quot;</span>);<br>    articleService.save(article);<br>&#125;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Article</span> <span class="hljs-variable">article</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>();<br>    article.setId(<span class="hljs-string">&quot;1a2282e7-8079-403d-b7cf-87523e414630&quot;</span>);<br>    article.setAuthor(<span class="hljs-string">&quot;鸡哥&quot;</span>);<br>    article.setTitle(<span class="hljs-string">&quot;PHP是世界上最好的语言&quot;</span>);<br>    article.setContent(<span class="hljs-string">&quot;学习不可三天打鱼两天晒网，打铁还需自身硬&quot;</span>);<br>    article.setRead(<span class="hljs-number">600</span>);<br>    article.setTypes(<span class="hljs-string">&quot;PHP&quot;</span>);<br>    articleService.update(article);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="11-4-2-批量新增"><a href="#11-4-2-批量新增" class="headerlink" title="11.4.2 批量新增"></a>11.4.2 批量新增</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 批量更新</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> articles</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveBatch</span><span class="hljs-params">(List&lt;Article&gt; articles)</span> &#123;<br>    articleDao.saveAll(articles);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveBatch</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Article</span> <span class="hljs-variable">article</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>();<br>    article.setAuthor(<span class="hljs-string">&quot;鸡哥&quot;</span>);<br>    article.setTitle(<span class="hljs-string">&quot;文档1&quot;</span>);<br>    article.setContent(<span class="hljs-string">&quot;我是文档1&quot;</span>);<br>    article.setRead(<span class="hljs-number">600</span>);<br>    article.setTypes(<span class="hljs-string">&quot;PHP&quot;</span>);<br>    <span class="hljs-type">Article</span> <span class="hljs-variable">article2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Article</span>();<br>    article2.setAuthor(<span class="hljs-string">&quot;鸡哥&quot;</span>);<br>    article2.setTitle(<span class="hljs-string">&quot;文档2&quot;</span>);<br>    article2.setContent(<span class="hljs-string">&quot;我是文档2&quot;</span>);<br>    article2.setRead(<span class="hljs-number">600</span>);<br>    article2.setTypes(<span class="hljs-string">&quot;PHP&quot;</span>);<br>    List&lt;Article&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    list.add(article);<br>    list.add(article2);<br>    articleService.saveBatch(list);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="11-4-3-删除"><a href="#11-4-3-删除" class="headerlink" title="11.4.3 删除"></a>11.4.3 删除</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id删除</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(String id)</span> &#123;<br>    articleDao.deleteById(id);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">()</span> &#123;<br>    articleService.deleteById(<span class="hljs-string">&quot;A7j1jHQB-Gb4jts1l0YE&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="11-4-4-根据id查询"><a href="#11-4-4-根据id查询" class="headerlink" title="11.4.4 根据id查询"></a>11.4.4 根据id查询</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据id查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> id</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> Article <span class="hljs-title function_">getById</span><span class="hljs-params">(String id)</span> &#123;<br>    <span class="hljs-keyword">return</span> articleDao.findById(id).get();<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getById</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Article</span> <span class="hljs-variable">article</span> <span class="hljs-operator">=</span> articleService.getById(<span class="hljs-string">&quot;bc304389-9f69-4cbb-a242-41b846889637&quot;</span>);<br>    System.out.println(article);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="11-4-5-Jpa语法查询"><a href="#11-4-5-Jpa语法查询" class="headerlink" title="11.4.5 Jpa语法查询"></a>11.4.5 Jpa语法查询</h3><table>
<thead>
<tr>
<th>Keyword</th>
<th>Sample</th>
<th>Elasticsearch Query String</th>
</tr>
</thead>
<tbody><tr>
<td><code>And</code></td>
<td><code>findByNameAndPrice</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;price&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Or</code></td>
<td><code>findByNameOrPrice</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;should&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;price&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Is</code></td>
<td><code>findByName</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Between</code></td>
<td><code>findByPriceBetween</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>LessThanEqual</code></td>
<td><code>findByPriceLessThan</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : null,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>GreaterThanEqual</code></td>
<td><code>findByPriceGreaterThan</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : null,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Before</code></td>
<td><code>findByPriceBefore</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : null,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>After</code></td>
<td><code>findByPriceAfter</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : null,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Like</code></td>
<td><code>findByNameLike</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;?*&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>StartingWith</code></td>
<td><code>findByNameStartingWith</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;?*&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>EndingWith</code></td>
<td><code>findByNameEndingWith</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;*?&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Contains/Containing</code></td>
<td><code>findByNameContaining</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;**?**&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>In</code></td>
<td><code>findByNameIn(Collection&lt;String&gt;names)</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;bool&quot; : &#123;&quot;should&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>NotIn</code></td>
<td><code>findByNameNotIn(Collection&lt;String&gt;names)</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must_not&quot; : &#123;&quot;bool&quot; : &#123;&quot;should&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>Near</code></td>
<td><code>findByStoreNear</code></td>
<td><code>Not Supported Yet !</code></td>
</tr>
<tr>
<td><code>True</code></td>
<td><code>findByAvailableTrue</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : true&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>False</code></td>
<td><code>findByAvailableFalse</code></td>
<td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : false&#125;&#125;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>OrderBy</code></td>
<td><code>findByAvailableTrueOrderByNameDesc</code></td>
<td><code>&#123;&quot;sort&quot; : [&#123; &quot;name&quot; : &#123;&quot;order&quot; : &quot;desc&quot;&#125; &#125;],&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : true&#125;&#125;&#125;&#125;</code></td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据content查询</span><br><span class="hljs-comment"> * 这里如果是需要分词的字段</span><br><span class="hljs-comment"> * 首先会将传入的参数进行分词</span><br><span class="hljs-comment"> * 分完词之后，使用这些分词进行查询</span><br><span class="hljs-comment"> * 然后取交集</span><br><span class="hljs-comment"> * 其实就是相当于</span><br><span class="hljs-comment"> * 分词之后多个term取交集</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>List&lt;Article&gt; <span class="hljs-title function_">findByContent</span><span class="hljs-params">(String content)</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据content查询</span><br><span class="hljs-comment"> * 这里会将content进行分词</span><br><span class="hljs-comment"> * 根据分词的结果查询</span><br><span class="hljs-comment"> * 取并集</span><br><span class="hljs-comment"> * 其实就是相当于 match</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>List&lt;Article&gt; <span class="hljs-title function_">findByContentLike</span><span class="hljs-params">(String content)</span>;<br><br></code></pre></td></tr></table></figure>

<p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据content查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> List&lt;Article&gt; <span class="hljs-title function_">getByContent</span><span class="hljs-params">(String content)</span> &#123;<br>    <span class="hljs-keyword">return</span> articleDao.findByContent(content);<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据content like查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> List&lt;Article&gt; <span class="hljs-title function_">getByContentLike</span><span class="hljs-params">(String content)</span> &#123;<br>    <span class="hljs-keyword">return</span> articleDao.findByContentLike(content);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">content</span><span class="hljs-params">()</span> &#123;<br>    List&lt;Article&gt; list = articleService.getByContent(<span class="hljs-string">&quot;干就完了，奥利给&quot;</span>);<br>    System.out.println(list);<br>&#125;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">contentLike</span><span class="hljs-params">()</span> &#123;<br>    List&lt;Article&gt; articleList = articleService.getByContentLike(<span class="hljs-string">&quot;老铁，奥利给&quot;</span>);<br>    System.out.println(articleList);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="11-4-6-分页"><a href="#11-4-6-分页" class="headerlink" title="11.4.6 分页"></a>11.4.6 分页</h3><p>分页查询主要涉及两个类。一个是Page，一个是Pageable</p>
<p>Repository中编写代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据content和title分页查询</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> title</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> pageable</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br>Page&lt;Article&gt; <span class="hljs-title function_">findByContentLikeOrTitleLike</span><span class="hljs-params">(String content, String title, Pageable pageable)</span>;<br><br></code></pre></td></tr></table></figure>

<p>Service中添加代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 分页查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> title</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> page</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> size</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> Page&lt;Article&gt; <span class="hljs-title function_">getByContentOrTitlePage</span><span class="hljs-params">(String content, String title, <span class="hljs-type">int</span> page, <span class="hljs-type">int</span> size)</span> &#123;<br>    <span class="hljs-comment">// 构造Pageable</span><br>    <span class="hljs-type">Pageable</span> <span class="hljs-variable">pageable</span> <span class="hljs-operator">=</span> PageRequest.of(page - <span class="hljs-number">1</span>, size);<br>    Page&lt;Article&gt; articlePage = articleDao.findByContentLikeOrTitleLike(content, title, pageable);<br>    <span class="hljs-keyword">return</span> articlePage;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPage1</span><span class="hljs-params">()</span> &#123;<br>    Page&lt;Article&gt; page = articleService.getByContentOrTitlePage(<span class="hljs-string">&quot;奥利给&quot;</span>, <span class="hljs-string">&quot;PHP&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);<br>    System.out.println(<span class="hljs-string">&quot;总条数：&quot;</span> + page.getTotalElements());<br>    System.out.println(<span class="hljs-string">&quot;总页数：&quot;</span> + page.getTotalPages());<br>    System.out.println(<span class="hljs-string">&quot;本页数据：&quot;</span> + page.getContent());<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="11-4-7-高级查询"><a href="#11-4-7-高级查询" class="headerlink" title="11.4.7 高级查询"></a>11.4.7 高级查询</h3><p>虽然基本查询和自定义方法已经很强大了，但是如果是复杂查询（模糊、通配符、词条查询等）就显得力不从心了。此时，我们只能使用原生查询。</p>
<h4 id="11-4-7-1-基本查询"><a href="#11-4-7-1-基本查询" class="headerlink" title="11.4.7.1 基本查询"></a>11.4.7.1 基本查询</h4><p>先看看基本玩法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 使用content的原生查询</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> content</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> List&lt;Article&gt; <span class="hljs-title function_">getByContentNative</span><span class="hljs-params">(String content)</span> &#123;<br>    <span class="hljs-type">MatchQueryBuilder</span> <span class="hljs-variable">matchQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.matchQuery(<span class="hljs-string">&quot;content&quot;</span>, content);<br>    <span class="hljs-type">NativeSearchQueryBuilder</span> <span class="hljs-variable">queryBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeSearchQueryBuilder</span>();<br>    queryBuilder.withQuery(matchQueryBuilder);<br>    SearchHits&lt;Article&gt; searchHits = elasticsearchRestTemplate.search(queryBuilder.build(), Article.class);<br>    <span class="hljs-keyword">return</span> searchHits.get().map(SearchHit::getContent).collect(Collectors.toList());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getByContentNative</span><span class="hljs-params">()</span> &#123;<br>    List&lt;Article&gt; articleList = articleService.getByContentNative(<span class="hljs-string">&quot;干就完了，奥利给&quot;</span>);<br>    System.out.println(articleList);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>QueryBuilders提供了大量的静态方法，用于生成各种不同类型的查询对象，例如：词条、模糊、通配符等QueryBuilder对象。</p>
<p>NativeSearchQueryBuilder：Spring提供的一个查询条件构建器，帮助构建json格式的请求体</p>
<h4 id="11-4-7-2-分页查询"><a href="#11-4-7-2-分页查询" class="headerlink" title="11.4.7.2 分页查询"></a>11.4.7.2 分页查询</h4><p>利用<code>NativeSearchQueryBuilder</code>可以方便的实现分页：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> com.example.pojo.Page&lt;Article&gt; <span class="hljs-title function_">getPageByContentNative</span><span class="hljs-params">(String content, String title, <span class="hljs-type">int</span> page, <span class="hljs-type">int</span> size)</span> &#123;<br>    <span class="hljs-type">NativeSearchQueryBuilder</span> <span class="hljs-variable">queryBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeSearchQueryBuilder</span>();<br>    <span class="hljs-comment">// 构造queryBuilder</span><br>    <span class="hljs-type">BoolQueryBuilder</span> <span class="hljs-variable">boolQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.boolQuery();<br>    boolQueryBuilder.should(QueryBuilders.matchQuery(<span class="hljs-string">&quot;content&quot;</span>, content));<br>    boolQueryBuilder.should(QueryBuilders.matchQuery(<span class="hljs-string">&quot;title&quot;</span>, title));<br>    queryBuilder.withQuery(boolQueryBuilder);<br>    queryBuilder.withPageable(PageRequest.of(page - <span class="hljs-number">1</span>, size));<br>    SearchHits&lt;Article&gt; searchHits = elasticsearchRestTemplate.search(queryBuilder.build(), Article.class);<br>    <span class="hljs-comment">// 获取查询的数据</span><br>    List&lt;Article&gt; articleList = searchHits.get().map(SearchHit::getContent).collect(Collectors.toList());<br>    <span class="hljs-comment">// 获取总条数</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">totalHits</span> <span class="hljs-operator">=</span> searchHits.getTotalHits();<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.example.pojo.Page&lt;Article&gt;(totalHits, size, articleList);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getPageByContentNative</span><span class="hljs-params">()</span> &#123;<br>    com.example.pojo.Page&lt;Article&gt; page = articleService.getPageByContentNative(<span class="hljs-string">&quot;奥利给，Java，PHP，文档&quot;</span>, <span class="hljs-string">&quot;奥利给，Java，PHP，文档&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);<br>    System.out.println(<span class="hljs-string">&quot;总条数：&quot;</span> + page.getTotalCount());<br>    System.out.println(<span class="hljs-string">&quot;总页数：&quot;</span> + page.getTotalPage());<br>    System.out.println(<span class="hljs-string">&quot;本页数据：&quot;</span>);<br>    page.getList().forEach(System.out::println);<br>&#125;<br><br></code></pre></td></tr></table></figure>





<p>可以发现，<strong>Elasticsearch中的分页是从第0页开始</strong>。</p>
<h4 id="11-4-7-3-排序"><a href="#11-4-7-3-排序" class="headerlink" title="11.4.7.3 排序"></a>11.4.7.3 排序</h4><p>排序也通用通过<code>NativeSearchQueryBuilder</code>完成：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> com.example.pojo.Page&lt;Article&gt; <span class="hljs-title function_">getPageByContentNativeSort</span><span class="hljs-params">(String content, String title, <span class="hljs-type">int</span> page, <span class="hljs-type">int</span> size)</span> &#123;<br>    <span class="hljs-type">NativeSearchQueryBuilder</span> <span class="hljs-variable">queryBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeSearchQueryBuilder</span>();<br>    <span class="hljs-comment">// 构造queryBuilder</span><br>    <span class="hljs-type">BoolQueryBuilder</span> <span class="hljs-variable">boolQueryBuilder</span> <span class="hljs-operator">=</span> QueryBuilders.boolQuery();<br>    boolQueryBuilder.should(QueryBuilders.matchQuery(<span class="hljs-string">&quot;content&quot;</span>, content));<br>    boolQueryBuilder.should(QueryBuilders.matchQuery(<span class="hljs-string">&quot;title&quot;</span>, title));<br>    queryBuilder.withQuery(boolQueryBuilder);<br>    queryBuilder.withPageable(PageRequest.of(page - <span class="hljs-number">1</span>, size));<br>    <span class="hljs-comment">// 构造排序对象</span><br>    queryBuilder.withSort(SortBuilders.fieldSort(<span class="hljs-string">&quot;read&quot;</span>).order(SortOrder.DESC));<br><br>    SearchHits&lt;Article&gt; searchHits = elasticsearchRestTemplate.search(queryBuilder.build(), Article.class);<br>    <span class="hljs-comment">// 获取查询的数据</span><br>    List&lt;Article&gt; articleList = searchHits.get().map(SearchHit::getContent).collect(Collectors.toList());<br>    <span class="hljs-comment">// 获取总条数</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">totalHits</span> <span class="hljs-operator">=</span> searchHits.getTotalHits();<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.example.pojo.Page&lt;Article&gt;(totalHits, size, articleList);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getPageByContentNativeSort</span><span class="hljs-params">()</span> &#123;<br>    com.example.pojo.Page&lt;Article&gt; page = articleService.getPageByContentNativeSort(<span class="hljs-string">&quot;奥利给，Java，PHP，文档&quot;</span>, <span class="hljs-string">&quot;奥利给，Java，PHP，文档&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);<br>    System.out.println(<span class="hljs-string">&quot;总条数：&quot;</span> + page.getTotalCount());<br>    System.out.println(<span class="hljs-string">&quot;总页数：&quot;</span> + page.getTotalPage());<br>    System.out.println(<span class="hljs-string">&quot;本页数据：&quot;</span>);<br>    page.getList().forEach(System.out::println);<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h3 id="11-4-8-聚合"><a href="#11-4-8-聚合" class="headerlink" title="11.4.8 聚合"></a>11.4.8 聚合</h3><h4 id="11-4-8-1-聚合为桶"><a href="#11-4-8-1-聚合为桶" class="headerlink" title="11.4.8.1 聚合为桶"></a>11.4.8.1 聚合为桶</h4><p>桶就是分组，比如这里我们按照帖子分类进行分组：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 根据type聚合</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getCountByTypes</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">NativeSearchQueryBuilder</span> <span class="hljs-variable">nativeSearchQueryBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeSearchQueryBuilder</span>();<br>    <span class="hljs-comment">// 设置要查询的字段</span><br>    nativeSearchQueryBuilder.withSourceFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FetchSourceFilter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;&quot;</span>&#125;, <span class="hljs-literal">null</span>));<br>    <span class="hljs-comment">// 设置一下查询的条数</span><br>    nativeSearchQueryBuilder.withPageable(PageRequest.of(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>));<br>    <span class="hljs-comment">// 设置聚合字段，指定聚合后的字段名，以及根据哪个字段聚合</span><br>    nativeSearchQueryBuilder.addAggregation(AggregationBuilders.terms(<span class="hljs-string">&quot;typeCount&quot;</span>).field(<span class="hljs-string">&quot;types&quot;</span>));<br>    <span class="hljs-comment">// 搜索</span><br>    SearchHits&lt;Article&gt; searchHits = elasticsearchRestTemplate.search(nativeSearchQueryBuilder.build(), Article.class);<br>    <span class="hljs-comment">// 取出来聚合的数据</span><br>    <span class="hljs-type">Aggregations</span> <span class="hljs-variable">aggregations</span> <span class="hljs-operator">=</span> searchHits.getAggregations();<br>    <span class="hljs-comment">// 取出我们聚合的字段</span><br>    <span class="hljs-type">Terms</span> <span class="hljs-variable">terms</span> <span class="hljs-operator">=</span> aggregations.get(<span class="hljs-string">&quot;typeCount&quot;</span>);<br>    List&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Terms</span>.Bucket&gt; buckets = terms.getBuckets();<br>    <span class="hljs-keyword">for</span> (Terms.Bucket bucket : buckets) &#123;<br>        System.out.println(bucket.getKey());<br>        System.out.println(bucket.getDocCount());<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getCountByType</span><span class="hljs-params">()</span> &#123;<br>    articleService.getCountByTypes();<br>&#125;<br></code></pre></td></tr></table></figure>





<h4 id="11-4-8-2-嵌套聚合"><a href="#11-4-8-2-嵌套聚合" class="headerlink" title="11.4.8.2 嵌套聚合"></a>11.4.8.2 嵌套聚合</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 嵌套聚合</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getCountAndSum</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">NativeSearchQueryBuilder</span> <span class="hljs-variable">nativeSearchQueryBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeSearchQueryBuilder</span>();<br>    <span class="hljs-comment">// 设置要查询的字段</span><br>    nativeSearchQueryBuilder.withSourceFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FetchSourceFilter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;&quot;</span>&#125;, <span class="hljs-literal">null</span>));<br>    <span class="hljs-comment">// 设置一下查询的条数</span><br>    nativeSearchQueryBuilder.withPageable(PageRequest.of(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>));<br>    <span class="hljs-comment">// 设置聚合字段，指定聚合后的字段名，以及根据哪个字段聚合</span><br>    nativeSearchQueryBuilder.addAggregation(<br>            <span class="hljs-comment">// 按照types聚合，求总数</span><br>            AggregationBuilders.terms(<span class="hljs-string">&quot;typeCount&quot;</span>).field(<span class="hljs-string">&quot;types&quot;</span>)<br>            <span class="hljs-comment">// types聚合完毕后，再根据read聚合</span><br>            .subAggregation(AggregationBuilders.sum(<span class="hljs-string">&quot;readNum&quot;</span>).field(<span class="hljs-string">&quot;read&quot;</span>))<br>    );<br>    <span class="hljs-comment">// 搜索</span><br>    SearchHits&lt;Article&gt; searchHits = elasticsearchRestTemplate.search(nativeSearchQueryBuilder.build(), Article.class);<br>    <span class="hljs-type">Aggregations</span> <span class="hljs-variable">aggregations</span> <span class="hljs-operator">=</span> searchHits.getAggregations();<br>    <span class="hljs-type">Terms</span> <span class="hljs-variable">terms</span> <span class="hljs-operator">=</span> aggregations.get(<span class="hljs-string">&quot;typeCount&quot;</span>);<br>    List&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Terms</span>.Bucket&gt; buckets = terms.getBuckets();<br>    <span class="hljs-keyword">for</span> (Terms.Bucket bucket : buckets) &#123;<br>        System.out.println(bucket.getKey());<br>        System.out.println(bucket.getDocCount());<br>        <span class="hljs-type">Aggregations</span> <span class="hljs-variable">subAggs</span> <span class="hljs-operator">=</span> bucket.getAggregations();<br>        <span class="hljs-type">Sum</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> subAggs.get(<span class="hljs-string">&quot;readNum&quot;</span>);<br>        System.out.println(sum.getValue());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getCountAndSum</span><span class="hljs-params">()</span> &#123;<br>    articleService.getCountAndSum();<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h1 id="12-评分机制-TF-IDF"><a href="#12-评分机制-TF-IDF" class="headerlink" title="12. 评分机制 TF\IDF"></a>12. 评分机制 TF\IDF</h1><h2 id="12-1-算法介绍"><a href="#12-1-算法介绍" class="headerlink" title="12.1 算法介绍"></a>12.1 算法介绍</h2><p>relevance score算法，简单来说，就是计算出，一个索引中的文本，与搜索文本，他们之间的关联匹配程度。</p>
<p>Elasticsearch使用的是 term frequency/inverse document frequency算法，简称为TF/IDF算法。TF词频(Term Frequency)，IDF逆向文件频率(Inverse Document Frequency)</p>
<p><strong>Term frequency</strong>：搜索文本中的各个词条在field文本中出现了多少次，出现次数越多，就越相关。</p>
<img src="/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200913001418.png" srcset="/img/loading.gif" lazyload class="" title="image-20200913001418228">

<p>举例：搜索请求：hello world</p>
<p>doc1 : hello you and me,and world is very good. </p>
<p>doc2 : hello,how are you</p>
<p><strong>Inverse document frequency</strong>：搜索文本中的各个词条在整个索引的所有文档中出现了多少次，出现的次数越多，就越不相关.</p>
<img src="/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200913001308.png" srcset="/img/loading.gif" lazyload class="" title="image-20200913001308194">



<p>举例：搜索请求：hello world</p>
<p>doc1 :  hello ,today is very good</p>
<p>doc2 : hi world ,how are you</p>
<p>整个index中1亿条数据。hello的document 1000个，有world的document  有100个。</p>
<p>doc2 更相关</p>
<p><strong>Field-length norm</strong>：field长度，field越长，相关度越弱</p>
<p>举例：搜索请求：hello world</p>
<p>doc1 : {“title”:”hello article”,”content “:”balabalabal 1万个”}</p>
<p>doc2 : {“title”:”my article”,”content “:”balabalabal 1万个,world”}</p>
<h2 id="12-2-score是如何被计算出来的"><a href="#12-2-score是如何被计算出来的" class="headerlink" title="12.2 _score是如何被计算出来的"></a>12.2 _score是如何被计算出来的</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs css">&#123;<br>	&quot;query&quot;: &#123;<br>&quot;match&quot;: &#123;<br>&quot;<span class="hljs-attribute">content</span>&quot;: <span class="hljs-string">&quot;老铁，奥利给&quot;</span><br>&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>返回</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><code class="hljs prolog">&#123;<br><br>    <span class="hljs-string">&quot;took&quot;</span>: <span class="hljs-number">2</span>,<br>    <span class="hljs-string">&quot;timed_out&quot;</span>: false,<br>    <span class="hljs-string">&quot;_shards&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;successful&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;skipped&quot;</span>: <span class="hljs-number">0</span>,<br>        <span class="hljs-string">&quot;failed&quot;</span>: <span class="hljs-number">0</span><br>    &#125;,<br>    <span class="hljs-string">&quot;hits&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;total&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">3</span>,<br>            <span class="hljs-string">&quot;relation&quot;</span>: <span class="hljs-string">&quot;eq&quot;</span><br>        &#125;,<br>        <span class="hljs-string">&quot;max_score&quot;</span>: <span class="hljs-number">1.0393288</span>,<br>        <span class="hljs-string">&quot;hits&quot;</span>: [<br>            &#123;<br>                <span class="hljs-string">&quot;_shard&quot;</span>: <span class="hljs-string">&quot;[article][0]&quot;</span>,<br>                <span class="hljs-string">&quot;_node&quot;</span>: <span class="hljs-string">&quot;SoA0mqjkTzSn8EoI7Vb7OQ&quot;</span>,<br>                <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;article&quot;</span>,<br>                <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;0352c029-92c1-4bdd-a6e9-672e1ebf6f3e&quot;</span>,<br>                <span class="hljs-string">&quot;_score&quot;</span>: <span class="hljs-number">1.0393288</span>,<br>                <span class="hljs-string">&quot;_source&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;_class&quot;</span>: <span class="hljs-string">&quot;com.example.pojo.Article&quot;</span>,<br>                    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;0352c029-92c1-4bdd-a6e9-672e1ebf6f3e&quot;</span>,<br>                    <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;Java从入门到精通&quot;</span>,<br>                    <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;老铁们，今天就不拍什么搞笑段子了，给大家表演一个铁锅炖大鹅，奥利给&quot;</span>,<br>                    <span class="hljs-string">&quot;read&quot;</span>: <span class="hljs-number">500</span>,<br>                    <span class="hljs-string">&quot;types&quot;</span>: <span class="hljs-string">&quot;Java&quot;</span>,<br>                    <span class="hljs-string">&quot;author&quot;</span>: <span class="hljs-string">&quot;鸡哥&quot;</span><br>                &#125;,<br>                <span class="hljs-string">&quot;_explanation&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">1.0393288</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;sum of:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                        &#123;<br>                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.91478837</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;weight(content:老铁 in 0) [PerFieldSimilarity], result of:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                &#123;<br>                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.91478837</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;score(freq=1.0), product of:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                        &#123;<br>                                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">2.2</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;boost&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.98082924</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                                &#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;n, number of documents containing term&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">3</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;N, total number of documents with field&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;]&#125;,&#123;<br>                                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.42394015</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                                &#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;freq, occurrences of term within document&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">1.2</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;k1, term saturation parameter&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.75</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;b, length normalization parameter&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">20</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;dl, length of field&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">17</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;avgdl, average length of field&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;]&#125;]&#125;]&#125;,&#123;<br>                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.1245405</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;weight(content:奥利给 in 0) [PerFieldSimilarity], result of:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                &#123;<br>                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.1245405</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;score(freq=1.0), product of:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                        &#123;<br>                                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">2.2</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;boost&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.13353139</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                                &#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">3</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;n, number of documents containing term&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">3</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;N, total number of documents with field&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;]&#125;,&#123;<br>                                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.42394015</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                                &#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;freq, occurrences of term within document&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">1.2</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;k1, term saturation parameter&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.75</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;b, length normalization parameter&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">20</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;dl, length of field&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">17</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;avgdl, average length of field&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;]&#125;]&#125;]&#125;]&#125;<br>            &#125;<br>            ,<br>            &#123;<br>                <span class="hljs-string">&quot;_shard&quot;</span>: <span class="hljs-string">&quot;[article][0]&quot;</span>,<br>                <span class="hljs-string">&quot;_node&quot;</span>: <span class="hljs-string">&quot;SoA0mqjkTzSn8EoI7Vb7OQ&quot;</span>,<br>                <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;article&quot;</span>,<br>                <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;077f557a-c26f-479a-9111-c44a587dbfe5&quot;</span>,<br>                <span class="hljs-string">&quot;_score&quot;</span>: <span class="hljs-number">0.16058116</span>,<br>                <span class="hljs-string">&quot;_source&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;_class&quot;</span>: <span class="hljs-string">&quot;com.example.pojo.Article&quot;</span>,<br>                    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;077f557a-c26f-479a-9111-c44a587dbfe5&quot;</span>,<br>                    <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;Java从入门到精通&quot;</span>,<br>                    <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;Java是一门面向对象语言，奥利给&quot;</span>,<br>                    <span class="hljs-string">&quot;read&quot;</span>: <span class="hljs-number">500</span>,<br>                    <span class="hljs-string">&quot;types&quot;</span>: <span class="hljs-string">&quot;PHP&quot;</span>,<br>                    <span class="hljs-string">&quot;author&quot;</span>: <span class="hljs-string">&quot;雷哥&quot;</span><br>                &#125;,<br>                <span class="hljs-string">&quot;_explanation&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.16058116</span>,<br>                    <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;sum of:&quot;</span>,<br>                    <span class="hljs-string">&quot;details&quot;</span>: [<br>                        &#123;<br>                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.16058116</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;weight(content:奥利给 in 0) [PerFieldSimilarity], result of:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                &#123;<br>                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.16058116</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;score(freq=1.0), product of:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                        &#123;<br>                                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">2.2</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;boost&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.13353139</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                                &#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">3</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;n, number of documents containing term&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">3</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;N, total number of documents with field&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;]&#125;,&#123;<br>                                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.54662377</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                                &#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;freq, occurrences of term within document&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">1.2</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;k1, term saturation parameter&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.75</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;b, length normalization parameter&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">10</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;dl, length of field&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">17</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;avgdl, average length of field&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;]&#125;]&#125;]&#125;]<br>                &#125;<br>            &#125;<br>            ,<br>            &#123;<br>                <span class="hljs-string">&quot;_shard&quot;</span>: <span class="hljs-string">&quot;[article][0]&quot;</span>,<br>                <span class="hljs-string">&quot;_node&quot;</span>: <span class="hljs-string">&quot;SoA0mqjkTzSn8EoI7Vb7OQ&quot;</span>,<br>                <span class="hljs-string">&quot;_index&quot;</span>: <span class="hljs-string">&quot;article&quot;</span>,<br>                <span class="hljs-string">&quot;_type&quot;</span>: <span class="hljs-string">&quot;_doc&quot;</span>,<br>                <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-string">&quot;76eae24a-925f-48f8-99b7-7807b03c14e0&quot;</span>,<br>                <span class="hljs-string">&quot;_score&quot;</span>: <span class="hljs-number">0.12180669</span>,<br>                <span class="hljs-string">&quot;_source&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;_class&quot;</span>: <span class="hljs-string">&quot;com.example.pojo.Article&quot;</span>,<br>                    <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-string">&quot;76eae24a-925f-48f8-99b7-7807b03c14e0&quot;</span>,<br>                    <span class="hljs-string">&quot;title&quot;</span>: <span class="hljs-string">&quot;PHP是世界上最好的语言&quot;</span>,<br>                    <span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;学习不可三天打鱼两天晒网，打铁还需自身硬，干就完了，加油奥利给&quot;</span>,<br>                    <span class="hljs-string">&quot;read&quot;</span>: <span class="hljs-number">0</span>,<br>                    <span class="hljs-string">&quot;types&quot;</span>: <span class="hljs-string">&quot;Java&quot;</span>,<br>                    <span class="hljs-string">&quot;author&quot;</span>: <span class="hljs-string">&quot;吴彦祖&quot;</span><br>                &#125;,<br>                <span class="hljs-string">&quot;_explanation&quot;</span>: &#123;<br>                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.12180669</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;sum of:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                        &#123;<br>                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.12180669</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;weight(content:奥利给 in 0) [PerFieldSimilarity], result of:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                &#123;<br>                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.12180669</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;score(freq=1.0), product of:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                        &#123;<br>                                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">2.2</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;boost&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.13353139</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;idf, computed as log(1 + (N - n + 0.5) / (n + 0.5)) from:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                                &#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">3</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;n, number of documents containing term&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">3</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;N, total number of documents with field&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;]&#125;,&#123;<br>                                            <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.41463417</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;tf, computed as freq / (freq + k1 * (1 - b + b * dl / avgdl)) from:&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [<br>                                                &#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">1</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;freq, occurrences of term within document&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">1.2</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;k1, term saturation parameter&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">0.75</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;b, length normalization parameter&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">21</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;dl, length of field&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;,&#123;<br>                                                    <span class="hljs-string">&quot;value&quot;</span>: <span class="hljs-number">17</span>,<span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;avgdl, average length of field&quot;</span>,<span class="hljs-string">&quot;details&quot;</span>: [ ]&#125;]&#125;]&#125;]&#125;]&#125;<br>            &#125;<br>        ]<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="12-3-一个document是如何被匹配上的"><a href="#12-3-一个document是如何被匹配上的" class="headerlink" title="12.3 一个document是如何被匹配上的"></a>12.3 一个document是如何被匹配上的</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">GET <span class="hljs-regexp">/article/</span>_explain/<span class="hljs-number">0352</span>c029-<span class="hljs-number">92</span>c1-<span class="hljs-number">4</span>bdd-a6e9-<span class="hljs-number">672</span>e1ebf6f3e<br>&#123;<br>	<span class="hljs-string">&quot;query&quot;</span>: &#123;<br><span class="hljs-string">&quot;match&quot;</span>: &#123;<br><span class="hljs-string">&quot;content&quot;</span>: <span class="hljs-string">&quot;老铁，奥利给&quot;</span><br>&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h1 id="13-集群搭建"><a href="#13-集群搭建" class="headerlink" title="13. 集群搭建"></a>13. 集群搭建</h1><h2 id="13-1-为什么要搭建集群"><a href="#13-1-为什么要搭建集群" class="headerlink" title="13.1 为什么要搭建集群"></a>13.1 为什么要搭建集群</h2><p>假如 Elasticsearch 只放在一台服务器上，即单机运行，假如这台主机突然断网了或者被攻击了，那么整个 Elasticsearch  的服务就不可用了。但如果改成 Elasticsearch 集群的话，有一台主机宕机了，还有其他的主机可以支撑，这样就仍然可以保证服务是可用的。</p>
<h2 id="13-2-集群简介"><a href="#13-2-集群简介" class="headerlink" title="13.2 集群简介"></a>13.2 集群简介</h2><p>接下来我们再来了解下集群的结构是怎样的。</p>
<p>首先我们应该清楚多台主机构成了一个集群，每台主机称作一个节点（Node）。</p>
<p>如图就是一个三节点的集群：</p>
<img src="/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elk/20200910111010.png" srcset="/img/loading.gif" lazyload class="" title="image-20200910111009285">

<p>在图中，每个 Node 都有三个分片，其中 P 开头的代表 Primary 分片，即主分片，R 开头的代表 Replica  分片，即副本分片。所以图中主分片 1、2，副本分片 0 储存在 1 号节点，副本分片 0、1、2 储存在 2 号节点，主分片 0 和副本分片  1、2 储存在 3 号节点，一共是 3 个主分片和 6 个副本分片。同时我们还注意到 1 号节点还有个 MASTER  的标识，这代表它是一个主节点，它相比其他的节点更加特殊，它有权限控制整个集群，比如资源的分配、节点的修改等等。</p>
<p>这里就引出了一个概念就是节点的类型，我们可以将节点分为这么四个类型：</p>
<ul>
<li>主节点：即 Master  节点。主节点的主要职责是和集群操作相关的内容，如创建或删除索引，跟踪哪些节点是群集的一部分，并决定哪些分片分配给相关的节点。稳定的主节点对集群的健康是非常重要的。默认情况下任何一个集群中的节点都有可能被选为主节点。索引数据和搜索查询等操作会占用大量的cpu，内存，io资源，为了确保一个集群的稳定，分离主节点和数据节点是一个比较好的选择。虽然主节点也可以协调节点，路由搜索和从客户端新增数据到数据节点，但最好不要使用这些专用的主节点。一个重要的原则是，尽可能做尽量少的工作。</li>
<li>数据节点：即 Data 节点。数据节点主要是存储索引数据的节点，主要对文档进行增删改查操作，聚合操作等。数据节点对 CPU、内存、IO 要求较高，在优化的时候需要监控数据节点的状态，当资源不够的时候，需要在集群中添加新的节点。</li>
<li>负载均衡节点：也称作 Client  节点，也称作客户端节点。当一个节点既不配置为主节点，也不配置为数据节点时，该节点只能处理路由请求，处理搜索，分发索引操作等，从本质上来说该客户节点表现为智能负载平衡器。独立的客户端节点在一个比较大的集群中是非常有用的，他协调主节点和数据节点，客户端节点加入集群可以得到集群的状态，根据集群的状态可以直接路由请求。</li>
<li>预处理节点：也称作 Ingest 节点，在索引数据之前可以先对数据做预处理操作，所有节点其实默认都是支持 Ingest 操作的，也可以专门将某个节点配置为 Ingest 节点。</li>
</ul>
<p>以上就是节点几种类型，一个节点其实可以对应不同的类型，如一个节点可以同时成为主节点和数据节点和预处理节点，但如果一个节点既不是主节点也不是数据节点，那么它就是负载均衡节点。</p>
<h2 id="13-3-搭建"><a href="#13-3-搭建" class="headerlink" title="13.3 搭建"></a>13.3 搭建</h2><ul>
<li><p>创建数据目录和日志目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">mkdir</span> -p /usr/local/es/data<br><span class="hljs-built_in">mkdir</span> -p /usr/local/es/log<br>修改文件所有者<br><span class="hljs-built_in">chown</span> -R es:es /usr/local/es/<br><span class="hljs-built_in">chown</span> -R es:es /usr/local/soft/elasticsearch-7.3.0/<br></code></pre></td></tr></table></figure></li>
<li><p>配置文件</p>
<p>集群配置中最重要的两项是<code>node.name</code>与<code>network.host</code>，每个节点都必须不同。其中<code>node.name</code>是节点名称主要是在Elasticsearch自己的日志加以区分每一个节点信息。<code>discovery.seed_hosts</code>是集群中的节点信息，可以使用IP地址、可以使用主机名(必须可以解析)。</p>
<p>编辑 <code>elasticsearch.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 如下是每个节点的配置文件内容</span><br><span class="hljs-attr">cluster.name:</span> <span class="hljs-string">my-application</span><br><span class="hljs-attr">node.name:</span> <span class="hljs-string">node-1</span><br><br><span class="hljs-comment"># 主节点</span><br><span class="hljs-attr">node.master:</span> <span class="hljs-literal">true</span><br><span class="hljs-comment"># 数据节点</span><br><span class="hljs-attr">node.data:</span> <span class="hljs-literal">true</span> <br><br><span class="hljs-attr">network.host:</span> <span class="hljs-string">该节点ip</span><br><span class="hljs-attr">http.port:</span> <span class="hljs-number">9200</span><br><span class="hljs-attr">transport.port:</span> <span class="hljs-number">9300</span><br><span class="hljs-attr">transport.tcp.compress:</span> <span class="hljs-literal">true</span><br><br><span class="hljs-attr">discovery.seed_hosts:</span> [<span class="hljs-string">&quot;192.168.0.160&quot;</span>, <span class="hljs-string">&quot;192.168.0.160&quot;</span>,<span class="hljs-string">&quot;192.168.0.160&quot;</span>]<br><span class="hljs-attr">cluster.initial_master_nodes:</span> [<span class="hljs-string">&quot;node-1&quot;</span>] <span class="hljs-comment"># 确保当前节点是主节点</span><br><br><span class="hljs-attr">http.cors.enabled:</span> <span class="hljs-literal">true</span><br><span class="hljs-attr">http.cors.allow-origin:</span> <span class="hljs-string">&quot;*&quot;</span><br></code></pre></td></tr></table></figure>

<p>每个节点都这么去部署</p>
</li>
<li><p>启动所有节点，使用可视化界面连接节点测试。</p>
</li>
</ul>
<h1 id="14-ELK"><a href="#14-ELK" class="headerlink" title="14. ELK"></a>14. ELK</h1><h2 id="14-1-简介"><a href="#14-1-简介" class="headerlink" title="14.1 简介"></a>14.1 简介</h2><p>ELK是包含但不限于Elasticsearch（简称es）、Logstash、Kibana 三个开源软件的组成的一个整体。这三个软件合成ELK。是用于数据抽取（Logstash）、搜索分析（Elasticsearch）、数据展现（Kibana）的一整套解决方案，所以也称作elastic stack。</p>
<p>Elasticsearch提供搜索分析，Logstash从内部采集数据到指定地方来展现它数据采集的功能。Kibana则从数据绘图展现数据可视化的功能。</p>
<h2 id="14-2-Logstash"><a href="#14-2-Logstash" class="headerlink" title="14.2 Logstash"></a>14.2 Logstash</h2><h3 id="14-2-1-简介"><a href="#14-2-1-简介" class="headerlink" title="14.2.1 简介"></a>14.2.1 简介</h3><p>logstash是一个数据抽取工具，将数据从一个地方转移到另一个地方。logstash之所以功能强大和流行，还与其丰富的过滤器插件是分不开的，过滤器提供的并不单单是过滤的功能，还可以对进入过滤器的原始数据进行复杂的逻辑处理，甚至添加独特的事件到后续流程中。</p>
<p>Logstash配置文件有如下三部分组成，其中input、output部分是必须配置，filter部分是可选配置，而filter就是过滤器插件，可以在这部分实现各种日志过滤功能。</p>
<h3 id="14-2-2-配置"><a href="#14-2-2-配置" class="headerlink" title="14.2.2 配置"></a>14.2.2 配置</h3><p>logback的 <code>logstash-sample.conf</code> 一般不进行配置，而是在config目录下新建一个配置文件进行配置。配置完毕后，通过下面命令指定配置文件启动</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">logstash.bat -f ../config/配置文件<br></code></pre></td></tr></table></figure>



<h4 id="14-2-2-1-input输入插件"><a href="#14-2-2-1-input输入插件" class="headerlink" title="14.2.2.1 input输入插件"></a>14.2.2.1 input输入插件</h4><p><strong>读取文件</strong></p>
<p>logstash使用一个名为filewatch的ruby gem库来监听文件变化,并通过一个叫.sincedb的数据库文件来记录被监听的日志文件的读取进度（时间戳），这个sincedb数据文件的默认路径在 &lt;path.data&gt;/plugins/inputs/file下面，文件名类似于.sincedb_123456，而&lt;path.data&gt;表示logstash插件存储目录，默认是LOGSTASH_HOME/data。</p>
<p>input通常有以下几个配置项，只能选用其中一种</p>
<ul>
<li>file：从文件系统中读取一个文件，很像UNIX命令 “tail -0a”</li>
<li>syslog：监听514端口，按照RFC3164标准解析日志数据</li>
<li>redis：从redis服务器读取数据，支持channel(发布订阅)和list模式。redis一般在Logstash消费集群中作为”broker”角色，保存events队列共Logstash消费。</li>
<li>tcp：从网络中获取数据</li>
<li>stdin：标准输如，从控制台获取</li>
<li>其他扩展，如jdbc</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs json">stdin <span class="hljs-punctuation">&#123;</span> <span class="hljs-punctuation">&#125;</span> # 从控制台中输入来源<br><br><br>file <span class="hljs-punctuation">&#123;</span> # 从文件中来<br>    path =&gt; <span class="hljs-string">&quot;/data/*&quot;</span> #单一文件<br>     #监听文件的多个路径<br>    path =&gt; <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;/data/*.log&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-string">&quot;F:/*.log&quot;</span><span class="hljs-punctuation">]</span><br>    #排除不想监听的文件<br>    exclude =&gt; <span class="hljs-string">&quot;1.log&quot;</span><br>    <br>    #添加自定义的字段<br>    add_field =&gt; <span class="hljs-punctuation">&#123;</span><span class="hljs-string">&quot;test&quot;</span>=&gt;<span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">&#125;</span><br>    #增加标签<br>    tags =&gt; <span class="hljs-string">&quot;tag1&quot;</span><br><br>    #设置新事件的标志<br>    delimiter =&gt; <span class="hljs-string">&quot;\n&quot;</span><br><br>    #设置多长时间扫描目录，发现新文件<br>    discover_interval =&gt; <span class="hljs-number">15</span><br>    #设置多长时间检测文件是否修改<br>    stat_interval =&gt; <span class="hljs-number">1</span><br><br>     #监听文件的起始位置，默认是end<br>    start_position =&gt; beginning<br><br>    #监听文件读取信息记录的位置<br>    sincedb_path =&gt; <span class="hljs-string">&quot;\/test.txt&quot;</span><br>    #设置多长时间会写入读取的位置信息<br>    sincedb_write_interval =&gt; <span class="hljs-number">15</span><br><span class="hljs-punctuation">&#125;</span><br><br><br>syslog <span class="hljs-punctuation">&#123;</span> # 系统日志方式<br>    type =&gt; <span class="hljs-string">&quot;system-syslog&quot;</span>  # 定义类型<br>    port =&gt; <span class="hljs-number">10514</span>    # 定义监听端口<br><span class="hljs-punctuation">&#125;</span><br><br></code></pre></td></tr></table></figure>



<h4 id="14-2-2-2-output输出插件"><a href="#14-2-2-2-output输出插件" class="headerlink" title="14.2.2.2 output输出插件"></a>14.2.2.2 output输出插件</h4><p>output用于向外输出，一个事件可以经过多个输出，而一旦所有输出处理完成，整个事件就执行完成。 一些常用的输出包括：</p>
<ul>
<li>file：  表示将数据写入磁盘上的文件。</li>
<li>elasticsearch：表示将数据发送给Elasticsearch。Elasticsearch可以高效方便和易于查询的保存数据。</li>
<li>stdout：输出到控制台</li>
</ul>
<p>输出的模式可以选用多种</p>
<p>1、输出到标准输出(stdout)</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs puppet"><span class="hljs-keyword">output</span> &#123;<br>    stdout &#123;<br>        <span class="hljs-attr">codec</span> =&gt; rubydebug<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>2、保存为文件（file）</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs puppet"><span class="hljs-keyword">output</span> &#123;<br>    file &#123;<br>        <span class="hljs-attr">path</span> =&gt; <span class="hljs-string">&quot;/data/log/%&#123;+yyyy-MM-dd&#125;/%&#123;host&#125;_%&#123;+HH&#125;.log&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>3、输出到elasticsearch</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs puppet"><span class="hljs-keyword">output</span> &#123;<br>    elasticsearch &#123;<br>        <span class="hljs-attr">hosts</span> =&gt; [<span class="hljs-string">&quot;192.168.1.1:9200&quot;</span>]<br>        <span class="hljs-attr">index</span> =&gt; <span class="hljs-string">&quot;logstash-%&#123;+YYYY.MM.dd&#125;&quot;</span>       <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>hosts：是一个数组类型的值，后面跟的值是elasticsearch节点的地址与端口，默认端口是9200。可添加多个地址。</li>
<li>index：写入elasticsearch的索引的名称，这里可以使用变量。Logstash提供了%{+YYYY.MM.dd}这种写法。在语法解析的时候，看到以+ 号开头的，就会自动认为后面是时间格式，尝试用时间格式来解析后续字符串。这种以天为单位分割的写法，可以很容易的删除老的数据或者搜索指定时间范围内的数据。此外，注意索引名中不能有大写字母。</li>
</ul>
<h4 id="14-2-2-3-filter过滤器插件"><a href="#14-2-2-3-filter过滤器插件" class="headerlink" title="14.2.2.3 filter过滤器插件"></a>14.2.2.3 filter过滤器插件</h4><p>filter是可选配置，用来过滤从input中读取的数据，一般用于日志处理</p>
<h5 id="Grok-正则捕获"><a href="#Grok-正则捕获" class="headerlink" title="Grok 正则捕获"></a>Grok 正则捕获</h5><p>grok是一个十分强大的 <code>filter</code> 插件，他可以通过正则解析任意文本，将非结构化日志数据弄成结构化和方便查询的结构。他是目前logstash 中解析非结构化日志数据最好的方式。</p>
<p>Grok 的语法规则是：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haml"><span class="hljs-tag">%&#123;语法: 语义&#125;</span><br></code></pre></td></tr></table></figure>

<p>例如输入的内容为：</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">172.16.213.132</span> <span class="hljs-string">[07/Feb/2019:16:24:19 +0800]</span> <span class="hljs-string">&quot;<span class="hljs-keyword">GET</span> / HTTP/1.1&quot;</span> <span class="hljs-number">403</span> <span class="hljs-number">5039</span><br></code></pre></td></tr></table></figure>

<p>%{IP:ip}匹配模式将获得的结果为：ip: 192.168.0.1</p>
<p>%{HTTPDATE:timestamp}匹配模式将获得的结果为：timestamp: 07/Feb/2018:16:24:19 +0800</p>
<p>而%{QS:referrer}匹配模式将获得的结果为：referrer: “GET / HTTP/1.1”</p>
<p>下面是一个组合匹配模式，它可以获取上面输入的所有内容：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">%&#123;IP:clientip&#125;\ \<span class="hljs-selector-attr">[%&#123;HTTPDATE:timestamp&#125;\]</span>\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;<br></code></pre></td></tr></table></figure>

<p>通过上面这个组合匹配模式，我们将输入的内容分成了五个部分，即五个字段，将输入内容分割为不同的数据字段，这对于日后解析和查询日志数据非常有用，这正是使用grok的目的。</p>
<p>例子：</p>
<figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs fsharp"><span class="hljs-keyword">input</span>&#123;<br>    <span class="hljs-keyword">stdin</span>&#123;&#125;<br>&#125;<br><span class="hljs-keyword">filter</span>&#123;<br>    <span class="hljs-keyword">grok</span>&#123;<br>        <span class="hljs-keyword">match</span> <span class="hljs-operator">=&gt;</span> [<span class="hljs-string">&quot;message&quot;</span>,<span class="hljs-string">&quot;%&#123;IP:clientip&#125;\ \[%&#123;HTTPDATE:timestamp&#125;\]\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;&quot;</span>]<br>    &#125;<br>&#125;<br><span class="hljs-keyword">output</span>&#123;<br>    <span class="hljs-keyword">stdout</span>&#123;<br>        codec <span class="hljs-operator">=&gt;</span> <span class="hljs-string">&quot;rubydebug&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<p>输入内容：</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">172.16.213.132</span> <span class="hljs-string">[07/Feb/2019:16:24:19 +0800]</span> <span class="hljs-string">&quot;<span class="hljs-keyword">GET</span> / HTTP/1.1&quot;</span> <span class="hljs-number">403</span> <span class="hljs-number">5039</span><br></code></pre></td></tr></table></figure>

<p><strong>grok 内置类型</strong></p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs inform7">USERNAME ：<span class="hljs-comment">[a-zA-Z0-9._-]</span>+<br>USER ：%&#123;USERNAME&#125;<br>INT ：(?:<span class="hljs-comment">[+-]</span>?(?:<span class="hljs-comment">[0-9]</span>+))<br>BASE10NUM ：(?&lt;!<span class="hljs-comment">[0-9.+-]</span>)(?&gt;<span class="hljs-comment">[+-]</span>?(?:(?:<span class="hljs-comment">[0-9]</span>+(?:\.<span class="hljs-comment">[0-9]</span>+)?)|(?:\.<span class="hljs-comment">[0-9]</span>+)))<br>NUMBER ：(?:%&#123;BASE10NUM&#125;)<br>BASE16NUM ：(?&lt;!<span class="hljs-comment">[0-9A-Fa-f]</span>)(?:<span class="hljs-comment">[+-]</span>?(?:0x)?(?:<span class="hljs-comment">[0-9A-Fa-f]</span>+))<br>BASE16FLOAT ：\b(?&lt;!<span class="hljs-comment">[0-9A-Fa-f.]</span>)(?:<span class="hljs-comment">[+-]</span>?(?:0x)?(?:(?:<span class="hljs-comment">[0-9A-Fa-f]</span>+(?:\.<span class="hljs-comment">[0-9A-Fa-f]</span>*)?)|(?:\.<span class="hljs-comment">[0-9A-Fa-f]</span>+)))\b<br><br>POSINT ：\b(?:<span class="hljs-comment">[1-9]</span><span class="hljs-comment">[0-9]</span>*)\b<br>NONNEGINT ：\b(?:<span class="hljs-comment">[0-9]</span>+)\b<br>WORD ：\b\w+\b<br>NOTSPACE ：\S+<br>SPACE ：\s*<br>DATA ：.*?<br>GREEDYDATA ：.*<br>QUOTEDSTRING ：(?&gt;(?&lt;!\\)(?&gt;<span class="hljs-string">&quot;(?&gt;\\.|<span class="hljs-subst">[^\\&quot;]</span>+)+&quot;</span>|<span class="hljs-string">&quot;&quot;</span>|(?&gt;&#x27;(?&gt;\\.|<span class="hljs-comment">[^\\&#x27;]</span>+)+&#x27;)|&#x27;&#x27;|(?&gt;`(?&gt;\\.|<span class="hljs-comment">[^\\`]</span>+)+`)|``))<br>UUID ：<span class="hljs-comment">[A-Fa-f0-9]</span>&#123;8&#125;-(?:<span class="hljs-comment">[A-Fa-f0-9]</span>&#123;4&#125;-)&#123;3&#125;<span class="hljs-comment">[A-Fa-f0-9]</span>&#123;12&#125;<br><br># Networking<br>MAC ：(?:%&#123;CISCOMAC&#125;|%&#123;WINDOWSMAC&#125;|%&#123;COMMONMAC&#125;)<br>CISCOMAC ：(?:(?:<span class="hljs-comment">[A-Fa-f0-9]</span>&#123;4&#125;\.)&#123;2&#125;<span class="hljs-comment">[A-Fa-f0-9]</span>&#123;4&#125;)<br>WINDOWSMAC ：(?:(?:<span class="hljs-comment">[A-Fa-f0-9]</span>&#123;2&#125;-)&#123;5&#125;<span class="hljs-comment">[A-Fa-f0-9]</span>&#123;2&#125;)<br>COMMONMAC ：(?:(?:<span class="hljs-comment">[A-Fa-f0-9]</span>&#123;2&#125;:)&#123;5&#125;<span class="hljs-comment">[A-Fa-f0-9]</span>&#123;2&#125;)<br>IPV6 ：(((<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;:)&#123;7&#125;(<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;|:))|((<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;:)&#123;6&#125;(:<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;|((25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span>\d|1\d\d|<span class="hljs-comment">[1-9]</span>?\d)(\.(25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span>\d|1\d\d|<span class="hljs-comment">[1-9]</span>?\d))&#123;3&#125;)|:))|((<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;:)&#123;5&#125;(((:<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;)&#123;1,2&#125;)|:((25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span>\d|1\d\d|<span class="hljs-comment">[1-9]</span>?\d)(\.(25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span>\d|1\d\d|<span class="hljs-comment">[1-9]</span>?\d))&#123;3&#125;)|:))|((<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;:)&#123;4&#125;(((:<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;)&#123;1,3&#125;)|((:<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;)?:((25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span>\d|1\d\d|<span class="hljs-comment">[1-9]</span>?\d)(\.(25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span>\d|1\d\d|<span class="hljs-comment">[1-9]</span>?\d))&#123;3&#125;))|:))|((<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;:)&#123;3&#125;(((:<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;)&#123;1,4&#125;)|((:<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;)&#123;0,2&#125;:((25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span>\d|1\d\d|<span class="hljs-comment">[1-9]</span>?\d)(\.(25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span>\d|1\d\d|<span class="hljs-comment">[1-9]</span>?\d))&#123;3&#125;))|:))|((<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;:)&#123;2&#125;(((:<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;)&#123;1,5&#125;)|((:<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;)&#123;0,3&#125;:((25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span>\d|1\d\d|<span class="hljs-comment">[1-9]</span>?\d)(\.(25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span>\d|1\d\d|<span class="hljs-comment">[1-9]</span>?\d))&#123;3&#125;))|:))|((<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;:)&#123;1&#125;(((:<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;)&#123;1,6&#125;)|((:<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;)&#123;0,4&#125;:((25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span>\d|1\d\d|<span class="hljs-comment">[1-9]</span>?\d)(\.(25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span>\d|1\d\d|<span class="hljs-comment">[1-9]</span>?\d))&#123;3&#125;))|:))|(:(((:<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;)&#123;1,7&#125;)|((:<span class="hljs-comment">[0-9A-Fa-f]</span>&#123;1,4&#125;)&#123;0,5&#125;:((25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span>\d|1\d\d|<span class="hljs-comment">[1-9]</span>?\d)(\.(25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span>\d|1\d\d|<span class="hljs-comment">[1-9]</span>?\d))&#123;3&#125;))|:)))(%.+)?<br>IPV4 (?&lt;!<span class="hljs-comment">[0-9]</span>)(?:(?:25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span><span class="hljs-comment">[0-9]</span>|<span class="hljs-comment">[0-1]</span>?<span class="hljs-comment">[0-9]</span>&#123;1,2&#125;)<span class="hljs-comment">[.]</span>(?:25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span><span class="hljs-comment">[0-9]</span>|<span class="hljs-comment">[0-1]</span>?<span class="hljs-comment">[0-9]</span>&#123;1,2&#125;)<span class="hljs-comment">[.]</span>(?:25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span><span class="hljs-comment">[0-9]</span>|<span class="hljs-comment">[0-1]</span>?<span class="hljs-comment">[0-9]</span>&#123;1,2&#125;)<span class="hljs-comment">[.]</span>(?:25<span class="hljs-comment">[0-5]</span>|2<span class="hljs-comment">[0-4]</span><span class="hljs-comment">[0-9]</span>|<span class="hljs-comment">[0-1]</span>?<span class="hljs-comment">[0-9]</span>&#123;1,2&#125;))(?!<span class="hljs-comment">[0-9]</span>)<br>IP ：(?:%&#123;IPV6&#125;|%&#123;IPV4&#125;)<br>HOSTNAME ：\b(?:<span class="hljs-comment">[0-9A-Za-z]</span><span class="hljs-comment">[0-9A-Za-z-]</span>&#123;0,62&#125;)(?:\.(?:<span class="hljs-comment">[0-9A-Za-z]</span><span class="hljs-comment">[0-9A-Za-z-]</span>&#123;0,62&#125;))*(\.?|\b)<br>HOST ：%&#123;HOSTNAME&#125;<br>IPORHOST ：(?:%&#123;HOSTNAME&#125;|%&#123;IP&#125;)<br>HOSTPORT ：%&#123;IPORHOST&#125;:%&#123;POSINT&#125;<br><br># paths<br>PATH ：(?:%&#123;UNIXPATH&#125;|%&#123;WINPATH&#125;)<br>UNIXPATH ：(?&gt;/(?&gt;<span class="hljs-comment">[\w_%!$@:.,-]</span>+|\\.)*)+<br>TTY ：(?:/dev/(pts|tty(<span class="hljs-comment">[pq]</span>)?)(\w+)?/?(?:<span class="hljs-comment">[0-9]</span>+))<br>WINPATH ：(?&gt;<span class="hljs-comment">[A-Za-z]</span>+:|\\)(?:\\<span class="hljs-comment">[^\\?*]</span>*)+<br>URIPROTO ：<span class="hljs-comment">[A-Za-z]</span>+(\+<span class="hljs-comment">[A-Za-z+]</span>+)?<br>URIHOST ：%&#123;IPORHOST&#125;(?::%&#123;POSINT:port&#125;)?<br># uripath comes loosely from RFC1738, but mostly from what Firefox<br># doesn&#x27;t turn into %XX<br>URIPATH ：(?:/<span class="hljs-comment">[A-Za-z0-9$.+!*&#x27;()&#123;&#125;,~:;=@#%_\-]</span>*)+<br>#URIPARAM \?(?:<span class="hljs-comment">[A-Za-z0-9]</span>+(?:=(?:<span class="hljs-comment">[^&amp;]</span>*))?(?:&amp;(?:<span class="hljs-comment">[A-Za-z0-9]</span>+(?:=(?:<span class="hljs-comment">[^&amp;]</span>*))?)?)*)?<br>URIPARAM ：\?<span class="hljs-comment">[A-Za-z0-9$.+!*&#x27;|()&#123;&#125;,~@#%&amp;/=:;_?\-\<span class="hljs-comment">[\]</span>]</span>*<br>URIPATHPARAM ：%&#123;URIPATH&#125;(?:%&#123;URIPARAM&#125;)?<br>URI ：%&#123;URIPROTO&#125;://(?:%&#123;USER&#125;(?::<span class="hljs-comment">[^@]</span>*)?@)?(?:%&#123;URIHOST&#125;)?(?:%&#123;URIPATHPARAM&#125;)?<br><br># Months: January, Feb, 3, 03, 12, December<br>MONTH ：\b(?:Jan(?:uary)?|Feb(?:ruary)?|Mar(?:ch)?|Apr(?:il)?|May|Jun(?:e)?|Jul(?:y)?|Aug(?:ust)?|Sep(?:tember)?|Oct(?:ober)?|Nov(?:ember)?|Dec(?:ember)?)\b<br>MONTHNUM ：(?:0?<span class="hljs-comment">[1-9]</span>|1<span class="hljs-comment">[0-2]</span>)<br>MONTHNUM2 ：(?:0<span class="hljs-comment">[1-9]</span>|1<span class="hljs-comment">[0-2]</span>)<br>MONTHDAY ：(?:(?:0<span class="hljs-comment">[1-9]</span>)|(?:<span class="hljs-comment">[12]</span><span class="hljs-comment">[0-9]</span>)|(?:3<span class="hljs-comment">[01]</span>)|<span class="hljs-comment">[1-9]</span>)<br><br># Days: Monday, Tue, Thu, etc...<br>DAY ：(?:Mon(?:day)?|Tue(?:sday)?|Wed(?:nesday)?|Thu(?:rsday)?|Fri(?:day)?|Sat(?:urday)?|Sun(?:day)?)<br><br># Years?<br>YEAR ：(?&gt;\d\d)&#123;1,2&#125;<br>HOUR ：(?:2<span class="hljs-comment">[0123]</span>|<span class="hljs-comment">[01]</span>?<span class="hljs-comment">[0-9]</span>)<br>MINUTE ：(?:<span class="hljs-comment">[0-5]</span><span class="hljs-comment">[0-9]</span>)<br># &#x27;60&#x27; <span class="hljs-keyword">is</span> a leap second in most time standards and thus <span class="hljs-keyword">is</span> valid.<br>SECOND ：(?:(?:<span class="hljs-comment">[0-5]</span>?<span class="hljs-comment">[0-9]</span>|60)(?:<span class="hljs-comment">[:.,]</span><span class="hljs-comment">[0-9]</span>+)?)<br>TIME ：(?!&lt;<span class="hljs-comment">[0-9]</span>)%&#123;HOUR&#125;:%&#123;MINUTE&#125;(?::%&#123;SECOND&#125;)(?!<span class="hljs-comment">[0-9]</span>)<br># datestamp <span class="hljs-keyword">is</span> YYYY/MM/DD-HH:MM:SS.UUUU (or something like it)<br>DATE_US ：%&#123;MONTHNUM&#125;<span class="hljs-comment">[/-]</span>%&#123;MONTHDAY&#125;<span class="hljs-comment">[/-]</span>%&#123;YEAR&#125;<br>DATE_EU ：%&#123;MONTHDAY&#125;<span class="hljs-comment">[./-]</span>%&#123;MONTHNUM&#125;<span class="hljs-comment">[./-]</span>%&#123;YEAR&#125;<br>ISO8601_TIMEZONE ：(?:Z|<span class="hljs-comment">[+-]</span>%&#123;HOUR&#125;(?::?%&#123;MINUTE&#125;))<br>ISO8601_SECOND ：(?:%&#123;SECOND&#125;|60)<br>TIMESTAMP_ISO8601 ：%&#123;YEAR&#125;-%&#123;MONTHNUM&#125;-%&#123;MONTHDAY&#125;<span class="hljs-comment">[T ]</span>%&#123;HOUR&#125;:?%&#123;MINUTE&#125;(?::?%&#123;SECOND&#125;)?%&#123;ISO8601_TIMEZONE&#125;?<br>DATE ：%&#123;DATE_US&#125;|%&#123;DATE_EU&#125;<br>DATESTAMP ：%&#123;DATE&#125;<span class="hljs-comment">[- ]</span>%&#123;TIME&#125;<br>TZ ：(?:<span class="hljs-comment">[PMCE]</span><span class="hljs-comment">[SD]</span>T|UTC)<br>DATESTAMP_RFC822 ：%&#123;DAY&#125; %&#123;MONTH&#125; %&#123;MONTHDAY&#125; %&#123;YEAR&#125; %&#123;TIME&#125; %&#123;TZ&#125;<br>DATESTAMP_RFC2822 ：%&#123;DAY&#125;, %&#123;MONTHDAY&#125; %&#123;MONTH&#125; %&#123;YEAR&#125; %&#123;TIME&#125; %&#123;ISO8601_TIMEZONE&#125;<br>DATESTAMP_OTHER ：%&#123;DAY&#125; %&#123;MONTH&#125; %&#123;MONTHDAY&#125; %&#123;TIME&#125; %&#123;TZ&#125; %&#123;YEAR&#125;<br>DATESTAMP_EVENTLOG ：%&#123;YEAR&#125;%&#123;MONTHNUM2&#125;%&#123;MONTHDAY&#125;%&#123;HOUR&#125;%&#123;MINUTE&#125;%&#123;SECOND&#125;<br><br># Syslog Dates: Month Day HH:MM:SS<br>SYSLOGTIMESTAMP ：%&#123;MONTH&#125; +%&#123;MONTHDAY&#125; %&#123;TIME&#125;<br>PROG ：(?:<span class="hljs-comment">[\w._/%-]</span>+)<br>SYSLOGPROG ：%&#123;PROG:program&#125;(?:\<span class="hljs-comment">[%&#123;POSINT:pid&#125;\]</span>)?<br>SYSLOGHOST ：%&#123;IPORHOST&#125;<br>SYSLOGFACILITY ：&lt;%&#123;NONNEGINT:facility&#125;.%&#123;NONNEGINT:priority&#125;&gt;<br>HTTPDATE ：%&#123;MONTHDAY&#125;/%&#123;MONTH&#125;/%&#123;YEAR&#125;:%&#123;TIME&#125; %&#123;INT&#125;<br><br># Shortcuts<br>QS ：%&#123;QUOTEDSTRING&#125;<br><br># Log formats<br>SYSLOGBASE ：%&#123;SYSLOGTIMESTAMP:timestamp&#125; (?:%&#123;SYSLOGFACILITY&#125; )?%&#123;SYSLOGHOST:logsource&#125; %&#123;SYSLOGPROG&#125;:<br>COMMONAPACHELOG ：%&#123;IPORHOST:clientip&#125; %&#123;USER:ident&#125; %&#123;USER:auth&#125; \<span class="hljs-comment">[%&#123;HTTPDATE:timestamp&#125;\]</span> <span class="hljs-string">&quot;(?:%&#123;WORD:verb&#125; %&#123;NOTSPACE:request&#125;(?: HTTP/%&#123;NUMBER:httpversion&#125;)?|%&#123;DATA:rawrequest&#125;)&quot;</span> %&#123;NUMBER:response&#125; (?:%&#123;NUMBER:bytes&#125;|-)<br>COMBINEDAPACHELOG ：%&#123;COMMONAPACHELOG&#125; %&#123;QS:referrer&#125; %&#123;QS:agent&#125;<br><br># Log Levels<br>LOGLEVEL ：(<span class="hljs-comment">[Aa]</span>lert|ALERT|<span class="hljs-comment">[Tt]</span>race|TRACE|<span class="hljs-comment">[Dd]</span>ebug|DEBUG|<span class="hljs-comment">[Nn]</span>otice|NOTICE|<span class="hljs-comment">[Ii]</span>nfo|INFO|<span class="hljs-comment">[Ww]</span>arn?(?:ing)?|WARN?(?:ING)?|<span class="hljs-comment">[Ee]</span>rr?(?:or)?|ERR?(?:OR)?|<span class="hljs-comment">[Cc]</span>rit?(?:ical)?|CRIT?(?:ICAL)?|<span class="hljs-comment">[Ff]</span>atal|FATAL|<span class="hljs-comment">[Ss]</span>evere|SEVERE|EMERG(?:ENCY)?|<span class="hljs-comment">[Ee]</span>merg(?:ency)?)<br></code></pre></td></tr></table></figure>

<h5 id="时间处理-Date"><a href="#时间处理-Date" class="headerlink" title="时间处理(Date)"></a>时间处理(Date)</h5><p>date插件是对于排序事件和回填旧数据尤其重要，它可以用来转换日志记录中的时间字段，变成LogStash::Timestamp对象，然后转存到@timestamp字段里。</p>
<p>下面是date插件的一个配置示例（这里仅仅列出filter部分）：</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs puppet"><span class="hljs-keyword">filter</span> &#123;<br>    grok &#123;<br>        <span class="hljs-attr">match</span> =&gt; [<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;%&#123;HTTPDATE:timestamp&#125;&quot;</span>]<br>    &#125;<br>    <span class="hljs-keyword">date</span> &#123;<br>        <span class="hljs-attr">match</span> =&gt; [<span class="hljs-string">&quot;timestamp&quot;</span>, <span class="hljs-string">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span>]<br>        <span class="hljs-attr">target</span> =&gt; <span class="hljs-string">&quot;timestamp&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="数据修改-Mutate"><a href="#数据修改-Mutate" class="headerlink" title="数据修改(Mutate)"></a>数据修改(Mutate)</h5><ul>
<li>正则表达式替换匹配字段</li>
</ul>
<p>gsub可以通过正则表达式替换字段中匹配到的值，只对字符串字段有效，下面是一个关于mutate插件中gsub的示例（仅列出filter部分）：</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs puppet"><span class="hljs-keyword">filter</span> &#123;<br>    mutate &#123;<br>        <span class="hljs-attr">gsub</span> =&gt; [<span class="hljs-string">&quot;filed_name_1&quot;</span>, <span class="hljs-string">&quot;/&quot;</span> , <span class="hljs-string">&quot;_&quot;</span>]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个示例表示将filed_name_1字段中所有”/“字符替换为”_”。</p>
<ul>
<li>分隔符分割字符串为数组</li>
</ul>
<p>split可以通过指定的分隔符分割字段中的字符串为数组，下面是一个关于mutate插件中split的示例（仅列出filter部分）：</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs puppet"><span class="hljs-keyword">filter</span> &#123;<br>    mutate &#123;<br>        <span class="hljs-attr">split</span> =&gt; [<span class="hljs-string">&quot;filed_name_2&quot;</span>, <span class="hljs-string">&quot;|&quot;</span>]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个示例表示将filed_name_2字段以”|”为区间分隔为数组。</p>
<ul>
<li>重命名字段</li>
</ul>
<p>rename可以实现重命名某个字段的功能，下面是一个关于mutate插件中rename的示例（仅列出filter部分）：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs coq">filter &#123;<br>    mutate &#123;<br>        <span class="hljs-built_in">rename</span> =&gt; &#123; <span class="hljs-string">&quot;old_field&quot;</span> =&gt; <span class="hljs-string">&quot;new_field&quot;</span> &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个示例表示将字段old_field重命名为new_field。</p>
<ul>
<li>删除字段</li>
</ul>
<p>remove_field可以实现删除某个字段的功能，下面是一个关于mutate插件中remove_field的示例（仅列出filter部分）：</p>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs puppet"><span class="hljs-keyword">filter</span> &#123;<br>    mutate &#123;<br>        <span class="hljs-attr">remove_field</span>  =&gt;  [<span class="hljs-string">&quot;timestamp&quot;</span>]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个示例表示将字段timestamp删除。</p>
<ul>
<li>GeoIP 地址查询归类</li>
</ul>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs puppet"><span class="hljs-keyword">filter</span> &#123;<br>    geoip &#123;<br>        <span class="hljs-attr">source</span> =&gt; <span class="hljs-string">&quot;ip_field&quot;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>综合例子：</li>
</ul>
<figure class="highlight puppet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs puppet"><span class="hljs-keyword">input</span> &#123;<br>  <span class="hljs-comment"># stdin &#123;&#125;</span><br><br>  file &#123;<br>    <span class="hljs-attr">path</span> =&gt; <span class="hljs-string">&quot;H:/logstash-7.3.0/nginx.log&quot;</span><br>    <span class="hljs-attr">start_position</span> =&gt; beginning<br>        <span class="hljs-comment">#添加自定义的字段</span><br>    <span class="hljs-attr">add_field</span> =&gt; &#123;<span class="hljs-string">&quot;test&quot;</span>=&gt;<span class="hljs-string">&quot;test&quot;</span>&#125;<br>    #增加标签<br>    stat_interval =&gt; 1<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">filter</span> &#123;<br>  grok &#123;<br>    <span class="hljs-comment"># 127.0.0.1 - - [11/Nov/2022:17:10:00 +0800] &quot;GET / HTTP/1.1&quot; 200 2384 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:70.0) Gecko/20100101 Firefox/70.0&quot;</span><br>    <span class="hljs-attr">match</span> =&gt; [<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;%&#123;IP:clientIp&#125;\ \-\ \-\ \[%&#123;HTTPDATE:timestamp&#125;\]\ %&#123;QS:referrer&#125;\ %&#123;NUMBER:response&#125;\ %&#123;NUMBER:bytes&#125;\ %&#123;GREEDYDATA:ua&#125;&quot;</span>]<br>  &#125;<br>  <span class="hljs-keyword">date</span> &#123;<br>    <span class="hljs-attr">match</span> =&gt; [<span class="hljs-string">&quot;timestamp&quot;</span>, <span class="hljs-string">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span>]<br>    <span class="hljs-attr">target</span> =&gt; <span class="hljs-string">&quot;timestamp&quot;</span><br>  &#125;<br>  <span class="hljs-keyword">mutate</span> &#123;<br>    <span class="hljs-attr">gsub</span> =&gt; [<span class="hljs-string">&quot;ua&quot;</span>, <span class="hljs-string">&quot;\&quot;-\&quot; &quot;</span>, <span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">gsub</span> =&gt; [<span class="hljs-string">&quot;ua&quot;</span>, <span class="hljs-string">&quot;\&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">gsub</span> =&gt; [<span class="hljs-string">&quot;ua&quot;</span>, <span class="hljs-string">&quot;\r&quot;</span>, <span class="hljs-string">&quot;&quot;</span>]<br>    <span class="hljs-attr">gsub</span> =&gt; [<span class="hljs-string">&quot;referrer&quot;</span>, <span class="hljs-string">&quot;\&quot;&quot;</span>, <span class="hljs-string">&quot;&quot;</span>]<br><br>    <span class="hljs-attr">split</span> =&gt; [<span class="hljs-string">&quot;clientIp&quot;</span>, <span class="hljs-string">&quot;.&quot;</span>]<br><br>    <span class="hljs-attr">rename</span> =&gt; [<span class="hljs-string">&quot;timestamp&quot;</span>, <span class="hljs-string">&quot;create_time&quot;</span>]<br>    <span class="hljs-attr">remove_field</span> =&gt; [<span class="hljs-string">&quot;message&quot;</span>]<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">output</span> &#123;<br>  stdout &#123;<br>    <span class="hljs-attr">codec</span> =&gt; rubydebug<br>  &#125;<br>  # <span class="hljs-keyword">file</span> &#123;<br>  <span class="hljs-comment">#   path =&gt; &quot;H:/logstash-7.3.0/logdata/%&#123;host&#125;_%&#123;+HH&#125;.log&quot;</span><br>  <span class="hljs-comment"># &#125;</span><br>  <span class="hljs-comment"># elasticsearch &#123;</span><br>  <span class="hljs-comment">#   hosts =&gt; [&quot;39.102.41.53:9200&quot;]</span><br>  <span class="hljs-comment">#   index =&gt; &quot;nginxlog-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>  <span class="hljs-comment"># &#125;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="14-3-Kibana"><a href="#14-3-Kibana" class="headerlink" title="14.3 Kibana"></a>14.3 Kibana</h2><p>Kibana是一个针对Elasticsearch的开源分析及可视化平台，用来搜索、查看交互存储在Elasticsearch索引中的数据。使用Kibana，可以通过各种图表进行高级数据分析及展示。</p>
<p>Kibana让海量数据更容易理解。它操作简单，基于浏览器的用户界面可以快速创建仪表板（dashboard）实时显示Elasticsearch查询动态。</p>
<p>设置Kibana非常简单。无需编码或者额外的基础架构，几分钟内就可以完成Kibana安装并启动Elasticsearch索引监测。</p>
<h3 id="14-3-1-windows安装"><a href="#14-3-1-windows安装" class="headerlink" title="14.3.1 windows安装"></a>14.3.1 windows安装</h3><p>下载，解压，配置 <code>kibana.yml</code> ，主要是配置ES的地址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment">#配置Kibana的远程访问</span><br>server.host: 0.0.0.0<br><br><span class="hljs-comment">#配置es访问地址</span><br>elasticsearch.hosts: [<span class="hljs-string">&quot;http://192.168.42.21:9200&quot;</span>]<br><br><span class="hljs-comment">#汉化访问</span><br>i18n.locale: <span class="hljs-string">&quot;zh-CN&quot;</span><br></code></pre></td></tr></table></figure>



<p>启动bin/kibana.bat即可</p>
<p>访问 <a target="_blank" rel="noopener" href="http://localhost:5601/">http://localhost:5601</a> 进入Dev Tools界面，就可以操作ES， 并且拥有代码提示</p>
<h3 id="14-3-2-Linux安装"><a href="#14-3-2-Linux安装" class="headerlink" title="14.3.2 Linux安装"></a>14.3.2 Linux安装</h3><p>将安装包放到 <code>soft</code> 文件夹下，解压</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">tar zxvf kibana-7.3.0-linux-x86_64.tar.gz  <br></code></pre></td></tr></table></figure>

<p>修改配置文件同上</p>
<p>授权文件给es用户</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">chown</span> -R es:es kibana-7.3.0-linux-x86_64<br></code></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">nohup</span> bin/kinaba &amp;<br></code></pre></td></tr></table></figure>



<h3 id="14-3-3-Docker安装"><a href="#14-3-3-Docker安装" class="headerlink" title="14.3.3 Docker安装"></a>14.3.3 Docker安装</h3><p>创建kibana目录，并创建配置文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-built_in">mkdir</span> -p /usr/local/kibana/config<br><br><span class="hljs-built_in">touch</span> kibana.yml<br><br></code></pre></td></tr></table></figure>

<p>启动kibana</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">docker run --name kibana \<br>-v /usr/local/kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml \<br>-p 5601:5601 -d kibana:7.3.0<br></code></pre></td></tr></table></figure>

<h1 id="15-案例"><a href="#15-案例" class="headerlink" title="15. 案例"></a>15. 案例</h1><h2 id="15-1-日志分析"><a href="#15-1-日志分析" class="headerlink" title="15.1 日志分析"></a>15.1 日志分析</h2><ul>
<li><p>代码输出日志</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">contextLoads</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> random.nextInt(<span class="hljs-number">1000</span>);<br>        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) &#123;<br>            log.info(<span class="hljs-string">&quot;我是info，当前生成的随机数是 &#123;&#125;&quot;</span>, i);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            log.error(<span class="hljs-string">&quot;我是error，当前生成的随机数是 &#123;&#125;&quot;</span>, i);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">99</span>) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        Thread.sleep(<span class="hljs-number">100</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>logstash同步到ES</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs sh">input &#123;<br>  file &#123;<br>    path =&gt; <span class="hljs-string">&quot;H:/es/**/*.log&quot;</span><br>    start_position =&gt; beginning<br>    <span class="hljs-comment">#增加标签</span><br>    stat_interval =&gt; 1<br>  &#125;<br>&#125;<br><br>filter &#123;<br>  grok &#123;<br>    match =&gt; [<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;%&#123;TIMESTAMP_ISO8601:log_time&#125;\ %&#123;GREEDYDATA:level&#125;\ \[%&#123;GREEDYDATA:thread&#125;\]\ \[%&#123;GREEDYDATA:app_name&#125;\]\ %&#123;GREEDYDATA:package_name&#125;\:%&#123;NUMBER:code_line&#125;\ \-%&#123;GREEDYDATA:info&#125;&quot;</span>]<br>  &#125;<br>  mutate &#123;<br>    gsub =&gt; [<span class="hljs-string">&quot;info&quot;</span>, <span class="hljs-string">&quot;\r&quot;</span>, <span class="hljs-string">&quot;&quot;</span>]<br>    remove_field =&gt; [<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;@timestamp&quot;</span>, <span class="hljs-string">&quot;host&quot;</span>]<br>  &#125;<br>&#125;<br><br>output &#123;<br>  stdout &#123;<br>    codec =&gt; rubydebug<br>  &#125;<br>  elasticsearch &#123;<br>    hosts =&gt; [<span class="hljs-string">&quot;39.102.41.53:9200&quot;</span>]<br>    index =&gt; <span class="hljs-string">&quot;log-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>kibana显示</p>
</li>
</ul>
<h2 id="15-2-mysql数据同步"><a href="#15-2-mysql数据同步" class="headerlink" title="15.2 mysql数据同步"></a>15.2 mysql数据同步</h2><p>将数据同步到ES</p>
<ul>
<li><p>代码持续生成数据存库</p>
</li>
<li><p>配置logstash</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs sh">input &#123;<br> jdbc &#123;<br>	  jdbc_connection_string =&gt; <span class="hljs-string">&quot;jdbc:mysql://127.0.0.1:3306/article?characterEncoding=UTF8&quot;</span><br>	  jdbc_user =&gt; <span class="hljs-string">&quot;root&quot;</span><br>	  jdbc_password =&gt; <span class="hljs-string">&quot;yangdeshi&quot;</span><br>	  jdbc_driver_library =&gt; <span class="hljs-string">&quot;H:/logstash-7.3.0/config/mysql-connector-java-5.1.47.jar&quot;</span><br>	  jdbc_driver_class =&gt; <span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span><br>	  <span class="hljs-comment">#使用其它字段追踪，而不是用时间</span><br>    use_column_value =&gt; <span class="hljs-literal">true</span><br>    <span class="hljs-comment">#追踪的字段</span><br>    tracking_column =&gt; <span class="hljs-built_in">id</span><br>    record_last_run =&gt; <span class="hljs-literal">true</span><br>    <span class="hljs-comment">#上一个sql_last_value值的存放文件路径, 必须要在文件中指定字段的初始值</span><br>    <span class="hljs-comment">#指定文件,来记录上次执行到的 tracking_column 字段的值</span><br>	  <span class="hljs-comment">#比如上次数据库有 10000 条记录,查询完后该文件中就会有数字 10000 这样的记录,下次执行 SQL 查询可以从 10001 条处开始.</span><br>	  <span class="hljs-comment">#我们只需要在 SQL 语句中 WHERE MY_ID &gt; :sql_last_value 即可. 其中 :sql_last_value 取得就是该文件中的值(10000).</span><br>    last_run_metadata_path =&gt; <span class="hljs-string">&quot;H:/logstash-7.3.0/config/station_parameter&quot;</span><br>	  <span class="hljs-comment">#是否开启分页</span><br>	  <span class="hljs-comment">#jdbc_paging_enabled =&gt; &quot;true&quot;</span><br>	  <span class="hljs-comment">#每页条数</span><br>	  <span class="hljs-comment">#jdbc_page_size =&gt; &quot;100&quot;</span><br>	  <span class="hljs-comment">#以下对应着要执行的sql的绝对路径。</span><br>	  <span class="hljs-comment">#sql太长写在文件中，这里指定路径statement_filepath =&gt; &quot;文件路径&quot;</span><br>	  statement_filepath =&gt; <span class="hljs-string">&quot;H:/logstash-7.3.0/config/article.sql&quot;</span><br>	  <span class="hljs-comment">#定时执行，最小一分钟一次</span><br>	  schedule =&gt; <span class="hljs-string">&quot;* * * * *&quot;</span><br>  &#125;<br>&#125;<br><br>output &#123;<br>  stdout &#123;<br>    codec =&gt; rubydebug<br>  &#125;<br>  elasticsearch &#123;<br>    hosts =&gt; [<span class="hljs-string">&quot;39.102.41.53:9200&quot;</span>]<br>    index =&gt; <span class="hljs-string">&quot;article-%&#123;+YYYY.MM.dd&#125;&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>查看同步情况</p>
</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="category-chain-item">服务器</a>
  
  
    <span>></span>
    
  <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/" class="category-chain-item">elasticsearch</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/elasticsearch/">#elasticsearch</a>
      
        <a href="/tags/elk/">#elk</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>elasticsearch比较全面的教程</div>
      <div>https://leellun.github.io/2019/03/25/服务器/elasticsearch/elk/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>leellun</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2019年3月25日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2019/03/25/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/ElasticSerach%E5%85%A5%E9%97%A8/" title="elasticsearch基本操作">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">elasticsearch基本操作</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2019/03/24/%E6%9C%8D%E5%8A%A1%E5%99%A8/elasticsearch/elasticsearch/" title="ElasticSearch基本教程和架构说明">
                        <span class="hidden-mobile">ElasticSearch基本教程和架构说明</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/leellun" target="_blank" rel="nofollow noopener"><span>我的github</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
