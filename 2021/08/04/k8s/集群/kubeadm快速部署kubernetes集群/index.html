

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/leaf_icon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="leellun">
  <meta name="keywords" content="">
  
    <meta name="description" content="kubeadm快速部署kubernetes集群1 安装要求 一台或多台机器，操作系统 CentOS7.x-86_x64 硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多(master必须2cpu,node可以不用) 可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像并导入节点 禁止swap分区  安装 kubeadm | Kubernetes 2 准备环境">
<meta property="og:type" content="article">
<meta property="og:title" content="kubernetes调度器scheduler">
<meta property="og:url" content="https://leellun.github.io/2021/08/04/k8s/%E9%9B%86%E7%BE%A4/kubeadm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/index.html">
<meta property="og:site_name" content="青叶水间 - 一个IT技术文章分享博客">
<meta property="og:description" content="kubeadm快速部署kubernetes集群1 安装要求 一台或多台机器，操作系统 CentOS7.x-86_x64 硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多(master必须2cpu,node可以不用) 可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像并导入节点 禁止swap分区  安装 kubeadm | Kubernetes 2 准备环境">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://leellun.github.io/2021/08/04/k8s/%E9%9B%86%E7%BE%A4/kubeadm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/1629031322356.png">
<meta property="og:image" content="https://leellun.github.io/2021/08/04/k8s/%E9%9B%86%E7%BE%A4/kubeadm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/image-25.png">
<meta property="og:image" content="https://leellun.github.io/2021/08/04/k8s/%E9%9B%86%E7%BE%A4/kubeadm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/image-26.png">
<meta property="article:published_time" content="2021-08-04T10:11:02.000Z">
<meta property="article:modified_time" content="2022-09-23T17:05:13.623Z">
<meta property="article:author" content="leellun">
<meta property="article:tag" content="kubernetes">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="集群部署">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://leellun.github.io/2021/08/04/k8s/%E9%9B%86%E7%BE%A4/kubeadm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/1629031322356.png">
  
  
  
  <title>kubernetes调度器scheduler - 青叶水间 - 一个IT技术文章分享博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"leellun.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 60vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>青叶水间</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg-default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="kubernetes调度器scheduler"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2021-08-04 18:11" pubdate>
          2021年8月4日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          18k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          152 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">kubernetes调度器scheduler</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="kubeadm快速部署kubernetes集群"><a href="#kubeadm快速部署kubernetes集群" class="headerlink" title="kubeadm快速部署kubernetes集群"></a>kubeadm快速部署kubernetes集群</h1><h1 id="1-安装要求"><a href="#1-安装要求" class="headerlink" title="1 安装要求"></a>1 安装要求</h1><ul>
<li>一台或多台机器，操作系统 CentOS7.x-86_x64</li>
<li>硬件配置：2GB或更多RAM，2个CPU或更多CPU，硬盘30GB或更多(master必须2cpu,node可以不用)</li>
<li>可以访问外网，需要拉取镜像，如果服务器不能上网，需要提前下载镜像并导入节点</li>
<li>禁止swap分区</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">安装 kubeadm | Kubernetes</a></p>
<h1 id="2-准备环境"><a href="#2-准备环境" class="headerlink" title="2 准备环境"></a>2 准备环境</h1><table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
</tr>
</thead>
<tbody><tr>
<td>master</td>
<td>192.168.66.11</td>
</tr>
<tr>
<td>node1</td>
<td>192.168.66.21</td>
</tr>
<tr>
<td>node2</td>
<td>192.168.66.22</td>
</tr>
</tbody></table>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stata">yum <span class="hljs-keyword">update</span> -y<br>yum install -y firewalld ntpdate <span class="hljs-keyword">net</span>-tools ipvsadm wget<br></code></pre></td></tr></table></figure>

<h2 id="2-1-关闭防火墙及selinux"><a href="#2-1-关闭防火墙及selinux" class="headerlink" title="2.1 关闭防火墙及selinux"></a>2.1 关闭防火墙及selinux</h2><p>所有节点执行一下命令</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 关闭防火墙</span><br>systemctl stop firewalld<br>systemctl <span class="hljs-built_in">disable</span> firewalld<br><br><span class="hljs-comment"># 关闭selinux</span><br><span class="hljs-comment"># 永久</span><br>sed -i <span class="hljs-string">&#x27;s/enforcing/disabled/&#x27;</span> /etc/selinux<span class="hljs-built_in">/config </span> <br><span class="hljs-comment"># 临时</span><br>setenforce 0  <br></code></pre></td></tr></table></figure>

<h2 id="2-2-关闭swap"><a href="#2-2-关闭swap" class="headerlink" title="2.2 关闭swap"></a>2.2 关闭swap</h2><p>所有节点执行一下命令</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 关闭swap</span><br><span class="hljs-comment"># 临时</span><br>swapoff -a  <br><span class="hljs-comment"># 永久</span><br>sed -ri <span class="hljs-string">&#x27;s/.*swap.*/#&amp;/&#x27;</span> <span class="hljs-regexp">/etc/</span>fstab    <br></code></pre></td></tr></table></figure>

<h2 id="2-3-根据规划设置主机名及hosts"><a href="#2-3-根据规划设置主机名及hosts" class="headerlink" title="2.3 根据规划设置主机名及hosts"></a>2.3 根据规划设置主机名及hosts</h2><p>所有节点执行hostnamectl set-hostname <hostname>命令</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-comment"># k8smaster节点执行</span><br><span class="hljs-string">hostnamectl</span> <span class="hljs-built_in">set-hostname</span> <span class="hljs-string">k8s-master01</span><br><span class="hljs-comment"># k8snode1节点执行</span><br><span class="hljs-string">hostnamectl</span> <span class="hljs-built_in">set-hostname</span> <span class="hljs-string">k8s-node01</span><br><span class="hljs-comment"># k8snode2节点执行</span><br><span class="hljs-string">hostnamectl</span> <span class="hljs-built_in">set-hostname</span> <span class="hljs-string">k8s-node02</span><br></code></pre></td></tr></table></figure>

<p>k8smaster主节点执行</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs accesslog">cat &gt;&gt; /etc/hosts &lt;&lt; EOF<br><span class="hljs-number">192.168.66.11</span> k8s-master01<br><span class="hljs-number">192.168.66.21</span> k8s-node01<br><span class="hljs-number">192.168.66.22</span> k8s-node02<br>EOF<br></code></pre></td></tr></table></figure>

<h2 id="2-4-将桥接的IPv4流量传递到iptables的链"><a href="#2-4-将桥接的IPv4流量传递到iptables的链" class="headerlink" title="2.4 将桥接的IPv4流量传递到iptables的链"></a>2.4 将桥接的IPv4流量传递到iptables的链</h2><p>确保 <code>br_netfilter</code> 模块被加载。这一操作可以通过运行 <code>lsmod | grep br_netfilter</code> 来完成。若要显式加载该模块，可执行 <code>sudo modprobe br_netfilter</code>。 </p>
<p>确保在你的 <code>sysctl</code> 配置中将 <code>net.bridge.bridge-nf-call-iptables</code> 设置为 1。 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF | sudo tee /etc/modules-load.d/k8s.conf</span><br><span class="hljs-string">br_netfilter</span><br><span class="hljs-string">EOF</span><br><br><span class="hljs-comment">#将桥接的IPv4流量传递到iptables的链</span><br><span class="hljs-built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="hljs-string">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="hljs-string">EOF</span><br><span class="hljs-comment"># 生效</span><br>sysctl --system  <br></code></pre></td></tr></table></figure>

<h2 id="2-5-时间同步"><a href="#2-5-时间同步" class="headerlink" title="2.5 时间同步"></a>2.5 时间同步</h2><p>所有节点执行一下命令</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">yum <span class="hljs-keyword">install </span>ntpdate -y<br>ntpdate time.windows.com<br><span class="hljs-comment"># 强制把系统时间写入CMOS</span><br><span class="hljs-keyword">clock </span>-w<br></code></pre></td></tr></table></figure>

<h1 id="3-所有节点安装Docker-kubeadm-kubelet"><a href="#3-所有节点安装Docker-kubeadm-kubelet" class="headerlink" title="3 所有节点安装Docker/kubeadm/kubelet"></a>3 所有节点安装Docker/kubeadm/kubelet</h1><h2 id="3-1-安装Docker"><a href="#3-1-安装Docker" class="headerlink" title="3.1 安装Docker"></a>3.1 安装Docker</h2><p>k8snode1和k8snode2下安装docker</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/docker-ce/</span>linux<span class="hljs-regexp">/centos/</span>docker-ce.repo -O <span class="hljs-regexp">/etc/yum</span>.repos.d/docker-ce.repo<br>yum -y install docker-ce-<span class="hljs-number">18.06</span>.<span class="hljs-number">1</span>.ce-<span class="hljs-number">3</span>.el7<br>systemctl enable docker &amp;&amp; systemctl start docker<br>docker --version<br></code></pre></td></tr></table></figure>

<h2 id="3-2-配置docker镜像加速"><a href="#3-2-配置docker镜像加速" class="headerlink" title="3.2 配置docker镜像加速"></a>3.2 配置docker镜像加速</h2><img src="/2021/08/04/k8s/%E9%9B%86%E7%BE%A4/kubeadm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/1629031322356.png" srcset="/img/loading.gif" lazyload class="" title="img">

<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">cat &gt; /etc/docker/daemon<span class="hljs-selector-class">.json</span> &lt;&lt; EOF<br>&#123;<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: <span class="hljs-selector-attr">[<span class="hljs-string">&quot;https://onozxvpe.mirror.aliyuncs.com&quot;</span>,<span class="hljs-string">&quot;http://hub-mirror.c.163.com&quot;</span>, <span class="hljs-string">&quot;https://registry.docker-cn.com&quot;</span>]</span>,<br>  <span class="hljs-string">&quot;exec-opts&quot;</span>: <span class="hljs-selector-attr">[<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>]</span><br>&#125;<br>EOF<br></code></pre></td></tr></table></figure>

<p>添加镜像加入和本地搭建harbor后：</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs prolog">&#123;<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;https://onozxvpe.mirror.aliyuncs.com&quot;</span>],<br>  <span class="hljs-string">&quot;exec-opts&quot;</span>: [<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>],<br>  <span class="hljs-string">&quot;insecure-registries&quot;</span>: [<span class="hljs-string">&quot;harborcloud.com&quot;</span>]<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="3-3-添加阿里云YUM软件源"><a href="#3-3-添加阿里云YUM软件源" class="headerlink" title="3.3 添加阿里云YUM软件源"></a>3.3 添加阿里云YUM软件源</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat &gt; <span class="hljs-regexp">/etc/yum</span>.repos.d/kubernetes.repo &lt;&lt; EOF<br>[kubernetes]<br>name=Kubernetes<br>baseurl=https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/kubernetes/yum</span><span class="hljs-regexp">/repos/</span>kubernetes-el7-x86_64<br>enabled=<span class="hljs-number">1</span><br>gpgcheck=<span class="hljs-number">0</span><br>repo_gpgcheck=<span class="hljs-number">0</span><br>gpgkey=https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/kubernetes/yum</span><span class="hljs-regexp">/doc/yum</span>-key.gpg https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/kubernetes/yum</span><span class="hljs-regexp">/doc/</span>rpm-package-key.gpg<br>EOF<br></code></pre></td></tr></table></figure>

<h2 id="3-4-安装kubeadm，kubelet和kubectl"><a href="#3-4-安装kubeadm，kubelet和kubectl" class="headerlink" title="3.4 安装kubeadm，kubelet和kubectl"></a>3.4 安装kubeadm，kubelet和kubectl</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">yum</span> install -y kubeadm-<span class="hljs-number">1</span>.<span class="hljs-number">22</span>.<span class="hljs-number">0</span> kubectl-<span class="hljs-number">1</span>.<span class="hljs-number">22</span>.<span class="hljs-number">0</span> kubelet-<span class="hljs-number">1</span>.<span class="hljs-number">22</span>.<span class="hljs-number">0</span><br><span class="hljs-attribute">systemctl</span> enable kubelet<br></code></pre></td></tr></table></figure>

<h1 id="4-部署Kubernetes-Master"><a href="#4-部署Kubernetes-Master" class="headerlink" title="4 部署Kubernetes Master"></a>4 部署Kubernetes Master</h1><p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/kubeadm-init/">https://kubernetes.io/zh-cn/docs/reference/setup-tools/kubeadm/kubeadm-init/</a></p>
<p>在192.168.66.10（k8smaster）执行。</p>
<p>由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址</p>
<p><strong>–pod-network-cidr</strong></p>
<p>指定pod网络的IP地址范围。 设置后，控制平面将自动为每个节点分配cidr。</p>
<p><strong>–service-cidr</strong></p>
<p>集群内部虚拟网络，Pod统一访问入口</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros">kubeadm init \<br><span class="hljs-attribute">--apiserver-advertise-address</span>=192.168.66.10 \<br>--image-repository registry.aliyuncs.com/google_containers \<br>--kubernetes-version v1.22.0 \<br><span class="hljs-attribute">--service-cidr</span>=10.96.0.0/12 \<br><span class="hljs-attribute">--pod-network-cidr</span>=10.244.0.0/16<br></code></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-attr">[init]</span> Using Kubernetes version: v1.<span class="hljs-number">22.0</span><br><span class="hljs-selector-attr">[preflight]</span> Running pre-flight checks<br><span class="hljs-selector-attr">[preflight]</span> Pulling images required <span class="hljs-keyword">for</span> setting up <span class="hljs-selector-tag">a</span> Kubernetes cluster<br><span class="hljs-selector-attr">[preflight]</span> This might take <span class="hljs-selector-tag">a</span> minute or two, depending on the speed of your internet connection<br><span class="hljs-selector-attr">[preflight]</span> You can also perform this action <span class="hljs-keyword">in</span> beforehand using <span class="hljs-string">&#x27;kubeadm config images pull&#x27;</span><br><span class="hljs-selector-attr">[certs]</span> Using certificateDir folder <span class="hljs-string">&quot;/etc/kubernetes/pki&quot;</span><br><span class="hljs-selector-attr">[certs]</span> Generating <span class="hljs-string">&quot;ca&quot;</span> certificate and key<br><span class="hljs-selector-attr">[certs]</span> Generating <span class="hljs-string">&quot;apiserver&quot;</span> certificate and key<br><span class="hljs-selector-attr">[certs]</span> apiserver serving cert is signed <span class="hljs-keyword">for</span> DNS names <span class="hljs-selector-attr">[k8s-master01 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local]</span> and IPs <span class="hljs-selector-attr">[10.96.0.1 192.168.66.11]</span><br><span class="hljs-selector-attr">[certs]</span> Generating <span class="hljs-string">&quot;apiserver-kubelet-client&quot;</span> certificate and key<br><span class="hljs-selector-attr">[certs]</span> Generating <span class="hljs-string">&quot;front-proxy-ca&quot;</span> certificate and key<br><span class="hljs-selector-attr">[certs]</span> Generating <span class="hljs-string">&quot;front-proxy-client&quot;</span> certificate and key<br><span class="hljs-selector-attr">[certs]</span> Generating <span class="hljs-string">&quot;etcd/ca&quot;</span> certificate and key<br><span class="hljs-selector-attr">[certs]</span> Generating <span class="hljs-string">&quot;etcd/server&quot;</span> certificate and key<br><span class="hljs-selector-attr">[certs]</span> etcd/server serving cert is signed <span class="hljs-keyword">for</span> DNS names <span class="hljs-selector-attr">[k8s-master01 localhost]</span> and IPs <span class="hljs-selector-attr">[192.168.66.11 127.0.0.1 ::1]</span><br><span class="hljs-selector-attr">[certs]</span> Generating <span class="hljs-string">&quot;etcd/peer&quot;</span> certificate and key<br><span class="hljs-selector-attr">[certs]</span> etcd/peer serving cert is signed <span class="hljs-keyword">for</span> DNS names <span class="hljs-selector-attr">[k8s-master01 localhost]</span> and IPs <span class="hljs-selector-attr">[192.168.66.11 127.0.0.1 ::1]</span><br><span class="hljs-selector-attr">[certs]</span> Generating <span class="hljs-string">&quot;etcd/healthcheck-client&quot;</span> certificate and key<br><span class="hljs-selector-attr">[certs]</span> Generating <span class="hljs-string">&quot;apiserver-etcd-client&quot;</span> certificate and key<br><span class="hljs-selector-attr">[certs]</span> Generating <span class="hljs-string">&quot;sa&quot;</span> key and public key<br><span class="hljs-selector-attr">[kubeconfig]</span> Using kubeconfig folder <span class="hljs-string">&quot;/etc/kubernetes&quot;</span><br><span class="hljs-selector-attr">[kubeconfig]</span> Writing <span class="hljs-string">&quot;admin.conf&quot;</span> kubeconfig file<br><span class="hljs-selector-attr">[kubeconfig]</span> Writing <span class="hljs-string">&quot;kubelet.conf&quot;</span> kubeconfig file<br><span class="hljs-selector-attr">[kubeconfig]</span> Writing <span class="hljs-string">&quot;controller-manager.conf&quot;</span> kubeconfig file<br><span class="hljs-selector-attr">[kubeconfig]</span> Writing <span class="hljs-string">&quot;scheduler.conf&quot;</span> kubeconfig file<br><span class="hljs-selector-attr">[kubelet-start]</span> Writing kubelet environment file with flags to file <span class="hljs-string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><br><span class="hljs-selector-attr">[kubelet-start]</span> Writing kubelet configuration to file <span class="hljs-string">&quot;/var/lib/kubelet/config.yaml&quot;</span><br><span class="hljs-selector-attr">[kubelet-start]</span> Starting the kubelet<br><span class="hljs-selector-attr">[control-plane]</span> Using manifest folder <span class="hljs-string">&quot;/etc/kubernetes/manifests&quot;</span><br><span class="hljs-selector-attr">[control-plane]</span> Creating static Pod manifest <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;kube-apiserver&quot;</span><br><span class="hljs-selector-attr">[control-plane]</span> Creating static Pod manifest <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;kube-controller-manager&quot;</span><br><span class="hljs-selector-attr">[control-plane]</span> Creating static Pod manifest <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;kube-scheduler&quot;</span><br><span class="hljs-selector-attr">[etcd]</span> Creating static Pod manifest <span class="hljs-keyword">for</span> local etcd <span class="hljs-keyword">in</span> <span class="hljs-string">&quot;/etc/kubernetes/manifests&quot;</span><br><span class="hljs-selector-attr">[wait-control-plane]</span> Waiting <span class="hljs-keyword">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="hljs-string">&quot;/etc/kubernetes/manifests&quot;</span>. This can take up to <span class="hljs-number">4</span>m0s<br><span class="hljs-selector-attr">[apiclient]</span> All control plane components are healthy after <span class="hljs-number">12.003757</span> seconds<br><span class="hljs-selector-attr">[upload-config]</span> Storing the configuration used <span class="hljs-keyword">in</span> ConfigMap <span class="hljs-string">&quot;kubeadm-config&quot;</span> <span class="hljs-keyword">in</span> the <span class="hljs-string">&quot;kube-system&quot;</span> Namespace<br><span class="hljs-selector-attr">[kubelet]</span> Creating <span class="hljs-selector-tag">a</span> ConfigMap <span class="hljs-string">&quot;kubelet-config-1.22&quot;</span> <span class="hljs-keyword">in</span> namespace kube-system with the configuration <span class="hljs-keyword">for</span> the kubelets <span class="hljs-keyword">in</span> the cluster<br><span class="hljs-selector-attr">[upload-certs]</span> Skipping phase. Please see <span class="hljs-attr">--upload-certs</span><br><span class="hljs-selector-attr">[mark-control-plane]</span> Marking the node k8s-master01 as control-plane by adding the labels: <span class="hljs-selector-attr">[node-role.kubernetes.io/master(deprecated) node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span><br><span class="hljs-selector-attr">[mark-control-plane]</span> Marking the node k8s-master01 as control-plane by adding the taints <span class="hljs-selector-attr">[node-role.kubernetes.io/master:NoSchedule]</span><br><span class="hljs-selector-attr">[bootstrap-token]</span> Using token: ii3pse<span class="hljs-selector-class">.bfxj9fqc9tvz6yrr</span><br><span class="hljs-selector-attr">[bootstrap-token]</span> Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles<br><span class="hljs-selector-attr">[bootstrap-token]</span> configured RBAC rules to allow Node Bootstrap tokens to get nodes<br><span class="hljs-selector-attr">[bootstrap-token]</span> configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="hljs-keyword">in</span> <span class="hljs-attribute">order</span> for nodes to get long term certificate credentials<br><span class="hljs-selector-attr">[bootstrap-token]</span> configured RBAC rules to allow the csrapprover controller automatically approve CSRs from <span class="hljs-selector-tag">a</span> Node Bootstrap Token<br><span class="hljs-selector-attr">[bootstrap-token]</span> configured RBAC rules to allow certificate rotation <span class="hljs-keyword">for</span> <span class="hljs-attribute">all</span> node client certificates in the cluster<br><span class="hljs-selector-attr">[bootstrap-token]</span> Creating the <span class="hljs-string">&quot;cluster-info&quot;</span> ConfigMap <span class="hljs-keyword">in</span> the <span class="hljs-string">&quot;kube-public&quot;</span> namespace<br><span class="hljs-selector-attr">[kubelet-finalize]</span> Updating <span class="hljs-string">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to <span class="hljs-selector-tag">a</span> rotatable kubelet client certificate and key<br><span class="hljs-selector-attr">[addons]</span> Applied essential addon: CoreDNS<br><span class="hljs-selector-attr">[addons]</span> Applied essential addon: kube-proxy<br><br>Your Kubernetes control-plane has initialized successfully!<br><br>To start using your cluster, you need to run the following as <span class="hljs-selector-tag">a</span> regular user:<br><br>  mkdir -<span class="hljs-selector-tag">p</span> <span class="hljs-variable">$HOME</span>/<span class="hljs-selector-class">.kube</span><br>  sudo cp -<span class="hljs-selector-tag">i</span> /etc/kubernetes/admin<span class="hljs-selector-class">.conf</span> <span class="hljs-variable">$HOME</span>/.kube/config<br>  sudo chown $(id -u):$(id -g) <span class="hljs-variable">$HOME</span>/.kube/config<br><br>Alternatively, <span class="hljs-keyword">if</span> you are the root user, you can run:<br><br>  export KUBECONFIG=/etc/kubernetes/admin<span class="hljs-selector-class">.conf</span><br><br>You should now deploy <span class="hljs-selector-tag">a</span> pod network to the cluster.<br>Run <span class="hljs-string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:<br>  https:<span class="hljs-comment">//kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><br>Then you can join any number of worker nodes by running the following on each as root:<br><br>kubeadm join <span class="hljs-number">192.168</span>.<span class="hljs-number">66.11</span>:<span class="hljs-number">6443</span> <span class="hljs-attr">--token</span> ii3pse<span class="hljs-selector-class">.bfxj9fqc9tvz6yrr</span> \<br>        <span class="hljs-attr">--discovery-token-ca-cert-hash</span> sha256:<span class="hljs-number">643</span>b48706d97589356e2a4be7294a898ac9a909baa56fecca277b7b4e5634e0e <br></code></pre></td></tr></table></figure>

<ul>
<li>preflight，系统前置检查</li>
<li>certs 各种证书的文件生成</li>
<li>kubeconfig生成kubeconfig文件，主要是kubenetes的几大组件的配置文件。</li>
<li>kubelet-start 启动kubelet</li>
<li>control-plane 生成所有静态pod的manifest文件，这些静态pod组成了kubenetes的控制面板，apiserver，controller，scheduler，生成这个文件后，kubelet会自动依据此文件描述的信息拉起镜像</li>
<li>etcd 生成etcd的manifest</li>
<li>upload-config 上传kubeadm和kubelet的配置文件到configmap中</li>
<li>upload-certs 上传配置证书文件</li>
<li>mark-control-plane mark一个node作为控制台</li>
<li>bootstrap-token 生成bootstrap tokens用于把node节点加入到集群。</li>
<li>kubelet-finalize 更新kubelet的设置</li>
<li>addon 安装其他的相关组件。主要是网络组件dns和kube-proxy</li>
</ul>
<p>所有node执行：</p>
<p>注：<code>kubectl</code> 在 <code>$HOME/.kube</code> 目录中查找一个名为 <code>config</code> 的配置文件。 你可以通过设置 KUBECONFIG 环境变量或设置 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/organize-cluster-access-kubeconfig/"><code>--kubeconfig</code></a> 参数来指定其它 <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/organize-cluster-access-kubeconfig/">kubeconfig</a> 文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br>sudo <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>sudo <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br>$ kubectl get nodes<br></code></pre></td></tr></table></figure>

<p>如果出现错误通过一下命令重置</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">kubeadm reset</span><br></code></pre></td></tr></table></figure>

<h1 id="5-加入Kubernetes-Node"><a href="#5-加入Kubernetes-Node" class="headerlink" title="5 加入Kubernetes Node"></a>5 加入Kubernetes Node</h1><p>执行上面kubeadm init后显示的信息提示，加入kubernates</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">kubeadm <span class="hljs-keyword">join </span><span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">66</span>.<span class="hljs-number">11</span>:<span class="hljs-number">6443</span> --token ii3pse.<span class="hljs-keyword">bfxj9fqc9tvz6yrr </span>\<br>        --<span class="hljs-keyword">discovery-token-ca-cert-hash </span><span class="hljs-keyword">sha256:643b48706d97589356e2a4be7294a898ac9a909baa56fecca277b7b4e5634e0e</span><br></code></pre></td></tr></table></figure>

<p>默认token有效期为24小时，当过期之后，该token就不可用了。这时就需要重新创建token，操作如下：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss">kubeadm <span class="hljs-built_in">token</span> <span class="hljs-keyword">create</span> --<span class="hljs-keyword">print</span>-join-command<br></code></pre></td></tr></table></figure>

<h1 id="6-部署CNI网络插件"><a href="#6-部署CNI网络插件" class="headerlink" title="6 部署CNI网络插件"></a>6 部署CNI网络插件</h1><img src="/2021/08/04/k8s/%E9%9B%86%E7%BE%A4/kubeadm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/image-25.png" srcset="/img/loading.gif" lazyload class="" title="img">

<p>这里可能需要代理下载，可以先下载下来</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ kubectl apply -f https:<span class="hljs-regexp">//</span>raw.githubusercontent.com<span class="hljs-regexp">/coreos/</span>flannel<span class="hljs-regexp">/master/</span>Documentation/kube-flannel.yml<br>$ kubectl get pods -n kube-system<br>NAME                          READY   STATUS    RESTARTS   AGE<br>kube-flannel-ds-amd64-<span class="hljs-number">2</span>pc95   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          <span class="hljs-number">72</span>s<br></code></pre></td></tr></table></figure>

<img src="/2021/08/04/k8s/%E9%9B%86%E7%BE%A4/kubeadm%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2kubernetes%E9%9B%86%E7%BE%A4/image-26.png" srcset="/img/loading.gif" lazyload class="" title="img">

<p><strong>Flannel工作原理</strong></p>
<p>k8s网络通讯方式：<a target="_blank" rel="noopener" href="http://jishu.youhang.site/25.html">k8s网络通讯方式 – 青叶水间 (youhang.site)</a></p>
<p>每个主机配置一个ip段和子网个数。 例如，可以配置一个覆盖网络使用 10.244.0.0/16段，每个主机/24个子网。因此主机a可以接受10.244.1.0/24，主机B可以接受10.244.2.0/24的包。flannel使用etcd来维护分配的子网到实际的ip地址之间的映射。</p>
<p>master IP信息：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs pf">[root@k8s-master01 ~]<span class="hljs-comment"># ip addr</span><br><span class="hljs-number">1</span>: lo: <span class="hljs-variable">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> mtu <span class="hljs-number">65536</span> qdisc noqueue <span class="hljs-keyword">state</span> UNKNOWN <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">1000</span><br>    link/loopback <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> brd <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span><br>    <span class="hljs-keyword">inet</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/<span class="hljs-number">8</span> scope host lo<br>       valid_lft forever preferred_lft forever<br>    <span class="hljs-keyword">inet6</span> ::<span class="hljs-number">1</span>/<span class="hljs-number">128</span> scope host <br>       valid_lft forever preferred_lft forever<br><span class="hljs-number">2</span>: eno16777736: <span class="hljs-variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="hljs-number">1500</span> qdisc pfifo_fast <span class="hljs-keyword">state</span> UP <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">1000</span><br>    link/ether <span class="hljs-number">00</span>:<span class="hljs-number">0</span>c:<span class="hljs-number">29</span>:<span class="hljs-number">6</span>b:de:b6 brd ff:ff:ff:ff:ff:ff<br>    <span class="hljs-keyword">inet</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">66.11</span>/<span class="hljs-number">24</span> brd <span class="hljs-number">10.0</span>.<span class="hljs-number">0.255</span> scope <span class="hljs-keyword">global</span> noprefixroute eno16777736<br>       valid_lft forever preferred_lft forever<br>    <span class="hljs-keyword">inet6</span> fd56:a9ae:cb0f::a49/<span class="hljs-number">128</span> scope <span class="hljs-keyword">global</span> noprefixroute dynamic <br>       valid_lft <span class="hljs-number">29570</span>sec preferred_lft <span class="hljs-number">29570</span>sec<br>    <span class="hljs-keyword">inet6</span> fd56:a9ae:cb0f:<span class="hljs-number">0</span>:<span class="hljs-number">20</span>c:<span class="hljs-number">29</span>ff:fe6b:deb6/<span class="hljs-number">64</span> scope <span class="hljs-keyword">global</span> noprefixroute <br>       valid_lft forever preferred_lft forever<br>    <span class="hljs-keyword">inet6</span> fe80::<span class="hljs-number">20</span>c:<span class="hljs-number">29</span>ff:fe6b:deb6/<span class="hljs-number">64</span> scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br><span class="hljs-number">3</span>: docker0: <span class="hljs-variable">&lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt;</span> mtu <span class="hljs-number">1500</span> qdisc noqueue <span class="hljs-keyword">state</span> DOWN <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> <br>    link/ether <span class="hljs-number">02</span>:<span class="hljs-number">42</span>:f0:df:d5:af brd ff:ff:ff:ff:ff:ff<br>    <span class="hljs-keyword">inet</span> <span class="hljs-number">172.17</span>.<span class="hljs-number">0.1</span>/<span class="hljs-number">16</span> brd <span class="hljs-number">172.17</span>.<span class="hljs-number">255.255</span> scope <span class="hljs-keyword">global</span> docker0<br>       valid_lft forever preferred_lft forever<br><span class="hljs-number">4</span>: flannel.<span class="hljs-number">1</span>: <span class="hljs-variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="hljs-number">1450</span> qdisc noqueue <span class="hljs-keyword">state</span> UNKNOWN <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> <br>    link/ether <span class="hljs-number">8</span>e:<span class="hljs-number">53</span>:a8:<span class="hljs-number">6</span>d:<span class="hljs-number">99</span>:<span class="hljs-number">1</span>e brd ff:ff:ff:ff:ff:ff<br>    <span class="hljs-keyword">inet</span> <span class="hljs-number">10.244</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">32</span> scope <span class="hljs-keyword">global</span> flannel.<span class="hljs-number">1</span><br>       valid_lft forever preferred_lft forever<br>    <span class="hljs-keyword">inet6</span> fe80::<span class="hljs-number">8</span>c53:a8ff:fe6d:<span class="hljs-number">991</span>e/<span class="hljs-number">64</span> scope link <br>       valid_lft forever preferred_lft forever<br><span class="hljs-number">5</span>: cni0: <span class="hljs-variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="hljs-number">1450</span> qdisc noqueue <span class="hljs-keyword">state</span> UP <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> qlen <span class="hljs-number">1000</span><br>    link/ether <span class="hljs-number">7</span>a:<span class="hljs-number">33</span>:a2:<span class="hljs-number">1</span>a:<span class="hljs-number">15</span>:<span class="hljs-number">65</span> brd ff:ff:ff:ff:ff:ff<br>    <span class="hljs-keyword">inet</span> <span class="hljs-number">10.244</span>.<span class="hljs-number">0.1</span>/<span class="hljs-number">24</span> brd <span class="hljs-number">10.244</span>.<span class="hljs-number">0.255</span> scope <span class="hljs-keyword">global</span> cni0<br>       valid_lft forever preferred_lft forever<br>    <span class="hljs-keyword">inet6</span> fe80::<span class="hljs-number">7833</span>:a2ff:fe1a:<span class="hljs-number">1565</span>/<span class="hljs-number">64</span> scope link <br>       valid_lft forever preferred_lft forever<br><span class="hljs-number">6</span>: vethefc85590@if3: <span class="hljs-variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="hljs-number">1450</span> qdisc noqueue master cni0 <span class="hljs-keyword">state</span> UP <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> <br>    link/ether <span class="hljs-number">5</span>a:<span class="hljs-number">3</span>e:<span class="hljs-number">58</span>:<span class="hljs-number">6</span>a:<span class="hljs-number">8</span>c:d2 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="hljs-number">0</span><br>    <span class="hljs-keyword">inet6</span> fe80::<span class="hljs-number">583</span>e:<span class="hljs-number">58</span>ff:fe6a:<span class="hljs-number">8</span>cd2/<span class="hljs-number">64</span> scope link <br>       valid_lft forever preferred_lft forever<br><span class="hljs-number">7</span>: veth991a2bde@if3: <span class="hljs-variable">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> mtu <span class="hljs-number">1450</span> qdisc noqueue master cni0 <span class="hljs-keyword">state</span> UP <span class="hljs-keyword">group</span> <span class="hljs-keyword">default</span> <br>    link/ether fe:<span class="hljs-number">6</span>f:eb:<span class="hljs-number">91</span>:<span class="hljs-number">71</span>:<span class="hljs-number">71</span> brd ff:ff:ff:ff:ff:ff link-netnsid <span class="hljs-number">1</span><br>    <span class="hljs-keyword">inet6</span> fe80::fc6f:ebff:fe91:<span class="hljs-number">7171</span>/<span class="hljs-number">64</span> scope link <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure>

<p><strong>lo</strong></p>
<p>本地环回接口</p>
<p><strong>eno16777736</strong></p>
<p>真实网卡</p>
<p><strong>docker0</strong></p>
<p>docker ip信息，默认IP 172.17.0.1/16</p>
<p>可修改 /etc/docker/daemon.json, 指定ip地址，例如：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">vi <span class="hljs-regexp">/etc/</span>docker/daemon.json<br>&#123;<br> <span class="hljs-string">&quot;bip&quot;</span>: <span class="hljs-string">&quot;172.18.0.1/24&quot;</span>,<br>&#125;<br>service docker restart<br></code></pre></td></tr></table></figure>

<p><strong>flannel.1</strong></p>
<p>docker集群跨主机通讯的覆盖网络 10.244.0.0/32</p>
<p><strong>cni0</strong></p>
<p>pod分配 网络 10.244.0.1/24</p>
<p>node1 IP信息：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="hljs-number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="hljs-number">1000</span><br>    <span class="hljs-attribute">link</span>/loopback <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> brd <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span><br>    <span class="hljs-attribute">inet</span> <span class="hljs-number">127.0.0.1</span>/<span class="hljs-number">8</span> scope host lo<br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br>    <span class="hljs-attribute">inet6</span> ::<span class="hljs-number">1</span>/<span class="hljs-number">128</span> scope host <br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br><span class="hljs-attribute">2</span>: eno16777736: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="hljs-number">1000</span><br>    <span class="hljs-attribute">link</span>/ether <span class="hljs-number">00</span>:<span class="hljs-number">0</span>c:<span class="hljs-number">29</span>:<span class="hljs-number">1</span>a:<span class="hljs-number">1</span>c:d4 brd ff:ff:ff:ff:ff:ff<br>    <span class="hljs-attribute">inet</span> <span class="hljs-number">10.0.0.21</span>/<span class="hljs-number">24</span> brd <span class="hljs-number">10.0.0.255</span> scope global noprefixroute eno16777736<br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br>    <span class="hljs-attribute">inet6</span> fd56:a9ae:cb0f::<span class="hljs-number">7</span>a1/<span class="hljs-number">128</span> scope global noprefixroute dynamic <br>       <span class="hljs-attribute">valid_lft</span> <span class="hljs-number">29510</span>sec preferred_lft <span class="hljs-number">29510</span>sec<br>    <span class="hljs-attribute">inet6</span> fd56:a9ae:cb0f:<span class="hljs-number">0</span>:<span class="hljs-number">20</span>c:<span class="hljs-number">29</span>ff:fe1a:<span class="hljs-number">1</span>cd4/<span class="hljs-number">64</span> scope global noprefixroute <br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br>    <span class="hljs-attribute">inet6</span> fe80::<span class="hljs-number">20</span>c:<span class="hljs-number">29</span>ff:fe1a:<span class="hljs-number">1</span>cd4/<span class="hljs-number">64</span> scope link noprefixroute <br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br><span class="hljs-attribute">3</span>: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue state DOWN group default <br>    <span class="hljs-attribute">link</span>/ether <span class="hljs-number">02</span>:<span class="hljs-number">42</span>:b8:ae:c9:<span class="hljs-number">24</span> brd ff:ff:ff:ff:ff:ff<br>    <span class="hljs-attribute">inet</span> <span class="hljs-number">172.17.0.1</span>/<span class="hljs-number">16</span> brd <span class="hljs-number">172.17.255.255</span> scope global docker0<br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br><span class="hljs-attribute">4</span>: flannel.<span class="hljs-number">1</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1450</span> qdisc noqueue state UNKNOWN group default <br>    <span class="hljs-attribute">link</span>/ether <span class="hljs-number">1</span>e:<span class="hljs-number">6</span>d:<span class="hljs-number">47</span>:<span class="hljs-number">69</span>:f7:<span class="hljs-number">6</span>a brd ff:ff:ff:ff:ff:ff<br>    <span class="hljs-attribute">inet</span> <span class="hljs-number">10.244.1.0</span>/<span class="hljs-number">32</span> scope global flannel.<span class="hljs-number">1</span><br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br>    <span class="hljs-attribute">inet6</span> fe80::<span class="hljs-number">1</span>c6d:<span class="hljs-number">47</span>ff:fe69:f76a/<span class="hljs-number">64</span> scope link <br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br></code></pre></td></tr></table></figure>

<p>node2 IP信息</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="hljs-number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="hljs-number">1000</span><br>    <span class="hljs-attribute">link</span>/loopback <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> brd <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span><br>    <span class="hljs-attribute">inet</span> <span class="hljs-number">127.0.0.1</span>/<span class="hljs-number">8</span> scope host lo<br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br>    <span class="hljs-attribute">inet6</span> ::<span class="hljs-number">1</span>/<span class="hljs-number">128</span> scope host <br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br><span class="hljs-attribute">2</span>: eno16777736: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1500</span> qdisc pfifo_fast state UP group default qlen <span class="hljs-number">1000</span><br>    <span class="hljs-attribute">link</span>/ether <span class="hljs-number">00</span>:<span class="hljs-number">0</span>c:<span class="hljs-number">29</span>:<span class="hljs-number">67</span>:c3:<span class="hljs-number">4</span>a brd ff:ff:ff:ff:ff:ff<br>    <span class="hljs-attribute">inet</span> <span class="hljs-number">10.0.0.22</span>/<span class="hljs-number">24</span> brd <span class="hljs-number">10.0.0.255</span> scope global noprefixroute eno16777736<br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br>    <span class="hljs-attribute">inet6</span> fd56:a9ae:cb0f::<span class="hljs-number">853</span>/<span class="hljs-number">128</span> scope global noprefixroute dynamic <br>       <span class="hljs-attribute">valid_lft</span> <span class="hljs-number">29262</span>sec preferred_lft <span class="hljs-number">29262</span>sec<br>    <span class="hljs-attribute">inet6</span> fd56:a9ae:cb0f:<span class="hljs-number">0</span>:<span class="hljs-number">20</span>c:<span class="hljs-number">29</span>ff:fe67:c34a/<span class="hljs-number">64</span> scope global noprefixroute <br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br>    <span class="hljs-attribute">inet6</span> fe80::<span class="hljs-number">20</span>c:<span class="hljs-number">29</span>ff:fe67:c34a/<span class="hljs-number">64</span> scope link noprefixroute <br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br><span class="hljs-attribute">3</span>: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span class="hljs-number">1500</span> qdisc noqueue state DOWN group default <br>    <span class="hljs-attribute">link</span>/ether <span class="hljs-number">02</span>:<span class="hljs-number">42</span>:b2:<span class="hljs-number">7</span>e:<span class="hljs-number">58</span>:<span class="hljs-number">1</span>f brd ff:ff:ff:ff:ff:ff<br>    <span class="hljs-attribute">inet</span> <span class="hljs-number">172.17.0.1</span>/<span class="hljs-number">16</span> brd <span class="hljs-number">172.17.255.255</span> scope global docker0<br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br><span class="hljs-attribute">4</span>: flannel.<span class="hljs-number">1</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="hljs-number">1450</span> qdisc noqueue state UNKNOWN group default <br>    <span class="hljs-attribute">link</span>/ether <span class="hljs-number">66</span>:<span class="hljs-number">5</span>b:e2:<span class="hljs-number">87</span>:<span class="hljs-number">5</span>c:<span class="hljs-number">22</span> brd ff:ff:ff:ff:ff:ff<br>    <span class="hljs-attribute">inet</span> <span class="hljs-number">10.244.2.0</span>/<span class="hljs-number">32</span> scope global flannel.<span class="hljs-number">1</span><br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br>    <span class="hljs-attribute">inet6</span> fe80::<span class="hljs-number">645</span>b:e2ff:fe87:<span class="hljs-number">5</span>c22/<span class="hljs-number">64</span> scope link <br>       <span class="hljs-attribute">valid_lft</span> forever preferred_lft forever<br></code></pre></td></tr></table></figure>

<p>7 测试kubernetes集群</p>
<p>在Kubernetes集群中创建一个pod，验证是否正常运行：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@k8s-master01 ~]<span class="hljs-comment"># kubectl create deployment nginx --image=nginx</span><br>deployment.apps/nginx created<br>[root@k8s-master01 ~]<span class="hljs-comment"># kubectl expose deployment nginx --port=80 --type=NodePort</span><br>service/nginx exposed<br>[root@k8s-master01 ~]<span class="hljs-comment"># kubectl get pod,svc</span><br>NAME                         READY   STATUS              RESTARTS   AGE<br>pod<span class="hljs-regexp">/nginx-6799fc88d8-zzsw7   0/</span><span class="hljs-number">1</span>     ContainerCreating   <span class="hljs-number">0</span>          <span class="hljs-number">31</span>s<br><br>NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE<br>service<span class="hljs-regexp">/kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/</span>TCP        <span class="hljs-number">24</span>h<br>service<span class="hljs-regexp">/nginx        NodePort    10.103.32.138   &lt;none&gt;        80:30029/</span>TCP   <span class="hljs-number">13</span>s<br></code></pre></td></tr></table></figure>

<p>访问地址：<a href="http://nodeip:Port/">http://NodeIP:Port</a></p>
<p>可以通过 <a target="_blank" rel="noopener" href="http://10.0.0.21:31263/">http://10.0.0.21:31263</a> 和 <a target="_blank" rel="noopener" href="http://10.0.0.22:31263/">http://10.0.0.22:31263</a> 访问</p>
<h1 id="8-错误排查"><a href="#8-错误排查" class="headerlink" title="8 错误排查"></a>8 <strong>错误排查</strong></h1><p>启动日志获取</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-comment">#查看启动日志</span><br><span class="hljs-keyword">journalctl </span>-f -u kubelet.service<br></code></pre></td></tr></table></figure>

<p>配置加载与重启服务</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-params">system</span>ctl daemon-reload &amp;&amp; <span class="hljs-params">system</span>ctl restart kubelet<br></code></pre></td></tr></table></figure>

<h1 id="9-ipvs修改"><a href="#9-ipvs修改" class="headerlink" title="9 ipvs修改"></a>9 ipvs修改</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vim">kubectl <span class="hljs-keyword">edit</span> configmap kube-proxy -n kube-<span class="hljs-built_in">system</span><br>...<br><span class="hljs-number">43</span>   <span class="hljs-keyword">mode</span>: <span class="hljs-string">&quot;ipvs&quot;</span><br>   ...<br></code></pre></td></tr></table></figure>

<p><strong>删除pod,会自动拉起</strong></p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gauss">kubectl <span class="hljs-keyword">delete</span> pod kube-proxy-btz4p -n kube-<span class="hljs-keyword">system</span>  <br></code></pre></td></tr></table></figure>

<p><strong>查看是否启用ipvs</strong></p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clean">kubectl logs kube-proxy-wwqbh -n kube-<span class="hljs-keyword">system</span>        <br></code></pre></td></tr></table></figure>

<p><strong>注：</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">1、 kube-proxy配置文件以configmap方式存储<br>2、 如果让所有节点生效，需要重建所有节点kube-proxy pod<br></code></pre></td></tr></table></figure>

<h1 id="10-问题及解决"><a href="#10-问题及解决" class="headerlink" title="10 问题及解决"></a>10 <strong>问题及解决</strong></h1><p>1 failed to find subsystem mount for required subsystem: pids failed to find subsystem mount for required subsystem: pids</p>
<p>解决方法：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">vi <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/systemd/</span>system<span class="hljs-regexp">/kubelet.service.d/</span><span class="hljs-number">10</span>-kubeadm.conf<br><span class="hljs-comment">#发现ExecStart=后面添加参数</span><br>ExecStart=<span class="hljs-string">&quot;--feature-gates SupportPodPidsLimit=false --feature-gates SupportNodePidsLimit=false&quot;</span><br><span class="hljs-comment">#或者更改引用变量$KUBELET_EXTRA_ARGS</span><br>vi <span class="hljs-regexp">/etc/</span>sysconfig/kubelet<br>KUBELET_EXTRA_ARGS=--feature-gates SupportPodPidsLimit=false --feature-gates SupportNodePidsLimit=false<br></code></pre></td></tr></table></figure>

<p>2 kubelet cgroup driver: \“systemd\“ is different from docker cgroup driver: \“cgroupfs\“</p>
<p>docker的驱动查看是否有systemd</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">docker</span> <span class="hljs-literal">info</span> |grep Cgroup<br></code></pre></td></tr></table></figure>

<p>解决方案步骤如下：</p>
<p>(1)、先修改docker的Cgroup Driver，修改/etc/docker/daemon.json文件</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs prolog">&#123;<br>  <span class="hljs-string">&quot;exec-opts&quot;</span>: [<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>重启docker</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-params">system</span>ctl daemon-reload<br><span class="hljs-params">system</span>ctl restart docker<br></code></pre></td></tr></table></figure>

<p>(2)、然后修改kubelet的Cgroup Driver<br>修改 “/usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf ” 文件，增加（或修改成）“–cgroup-driver=systemd” (官方推荐用systemd)</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">Environment</span><span class="hljs-operator">=</span><span class="hljs-string">&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf --cgroup-driver=systemd&quot;</span><br></code></pre></td></tr></table></figure>

<p>修改 “/var/lib/kubelet/kubeadm-flags.env ”文件，增加（或修改成）“-–cgroup-driver=systemd”</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">KUBELET_KUBEADM_ARGS=&quot;</span><span class="hljs-literal">--</span><span class="hljs-comment">cgroup</span><span class="hljs-literal">-</span><span class="hljs-comment">driver=systemd</span> <span class="hljs-literal">--</span><span class="hljs-comment">network</span><span class="hljs-literal">-</span><span class="hljs-comment">plugin=cni</span> <span class="hljs-literal">--</span><span class="hljs-comment">pod</span><span class="hljs-literal">-</span><span class="hljs-comment">infra</span><span class="hljs-literal">-</span><span class="hljs-comment">container</span><span class="hljs-literal">-</span><span class="hljs-comment">image=registry</span><span class="hljs-string">.</span><span class="hljs-comment">aliyuncs</span><span class="hljs-string">.</span><span class="hljs-comment">com/google_containers/pause:3</span><span class="hljs-string">.</span><span class="hljs-comment">2&quot;</span><br></code></pre></td></tr></table></figure>

<p>重启：</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-params">system</span>ctl daemon-reload<br><span class="hljs-params">system</span>ctl restart kubelet<br></code></pre></td></tr></table></figure>
<p>3 missing required cgroups: cpu</p>
<p>修改<code>/etc/default/grub</code></p>
<p>添加一行<code>GRUB_CMDLINE_LINUX=&quot;cgroup_enable=cpu&quot;</code></p>
<p>运行 <code>update-grub2</code></p>
<p>重启机器 <code>reboot</code></p>
<p>4  Failed to start CRI Interface for Docker Application Container Engine Defined-By: systemd</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-number">7</span>月 <span class="hljs-number">29</span> <span class="hljs-number">20</span>:<span class="hljs-number">35</span>:<span class="hljs-number">14</span> k8s-master02 systemd[<span class="hljs-number">1</span>]: cri-docker.service: main <span class="hljs-built_in">process</span> exited, code=exited, status=<span class="hljs-number">203</span>/EXEC<br><span class="hljs-number">7</span>月 <span class="hljs-number">29</span> <span class="hljs-number">20</span>:<span class="hljs-number">35</span>:<span class="hljs-number">14</span> k8s-master02 systemd[<span class="hljs-number">1</span>]: Failed <span class="hljs-built_in">to</span> <span class="hljs-built_in">start</span> CRI Interface <span class="hljs-keyword">for</span> Docker Application Container Engine.<br><span class="hljs-comment">-- Subject: Unit cri-docker.service has failed</span><br><span class="hljs-comment">-- Defined-By: systemd</span><br><span class="hljs-comment">-- Support: http://lists.freedesktop.org/mailman/listinfo/systemd-devel</span><br><span class="hljs-comment">-- </span><br><span class="hljs-comment">-- Unit cri-docker.service has failed.</span><br><span class="hljs-comment">-- </span><br><span class="hljs-comment">-- The result is failed.</span><br><span class="hljs-number">7</span>月 <span class="hljs-number">29</span> <span class="hljs-number">20</span>:<span class="hljs-number">35</span>:<span class="hljs-number">14</span> k8s-master02 systemd[<span class="hljs-number">1</span>]: Unit cri-docker.service entered failed state.<br><span class="hljs-number">7</span>月 <span class="hljs-number">29</span> <span class="hljs-number">20</span>:<span class="hljs-number">35</span>:<span class="hljs-number">14</span> k8s-master02 systemd[<span class="hljs-number">1</span>]: cri-docker.service failed.<br></code></pre></td></tr></table></figure>

<p>修改 docker 控制组</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">vi <span class="hljs-regexp">/etc/</span>docker/daemon.json <br>&#123;<br>  <span class="hljs-string">&quot;exec-opts&quot;</span>: [<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>]<br>&#125;<br></code></pre></td></tr></table></figure>

<p>从重启服务</p>
<figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-params">system</span>ctl daemon-reload<br><span class="hljs-params">system</span>ctl restart docker<br><span class="hljs-params">system</span>ctl restart cri-docker<br></code></pre></td></tr></table></figure>

<p>5  error execution phase preflight: couldn’t validate the identity of the API Server: Get “<a target="_blank" rel="noopener" href="https://10.0.0.150:16443/api/v1/namespaces/kube-public/configmaps/cluster-info?timeout=10s&quot;">https://10.0.0.150:16443/api/v1/namespaces/kube-public/configmaps/cluster-info?timeout=10s&quot;</a>: x509: certificate has expired or is not yet valid: current time 2022-07-30T16:12:40+08:00 is before 2022-07-30T13:31:36Z</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">yum <span class="hljs-keyword">install </span>ntpdate -y<br>ntpdate time.windows.com<br><span class="hljs-comment"># 强制把系统时间写入CMOS</span><br><span class="hljs-keyword">clock </span>-w<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="category-chain-item">服务器</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/kubernetes/">#kubernetes</a>
      
        <a href="/tags/k8s/">#k8s</a>
      
        <a href="/tags/%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/">#集群部署</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>kubernetes调度器scheduler</div>
      <div>https://leellun.github.io/2021/08/04/k8s/集群/kubeadm快速部署kubernetes集群/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>leellun</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2021年8月4日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/08/06/k8s/pod/k8s%20pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/" title="k8s pod生命周期">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">k8s pod生命周期</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/08/02/k8s/basic/k8s%E9%9B%86%E7%BE%A4%E5%BC%80%E5%90%AFfirewalld%E9%98%B2%E7%81%AB%E5%A2%99/" title="k8s集群开启firewalld防火墙">
                        <span class="hidden-mobile">k8s集群开启firewalld防火墙</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/leellun" target="_blank" rel="nofollow noopener"><span>我的github</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
